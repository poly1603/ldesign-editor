<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>虚拟滚动演示 - @ldesign/editor</title>
  <link rel="stylesheet" href="../dist/editor.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .demo-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .editor-container {
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      font-family: monospace;
    }

    .stat-item {
      flex: 1;
    }

    .stat-label {
      color: #666;
      font-size: 12px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #f5f5f5;
    }

    .btn-primary {
      background: #2196F3;
      color: white;
      border-color: #2196F3;
    }

    .btn-primary:hover {
      background: #1976D2;
    }

    .perf-graph {
      height: 200px;
      margin-top: 20px;
      position: relative;
      background: #f8f9fa;
      border-radius: 4px;
      overflow: hidden;
    }

    .fps-line {
      position: absolute;
      bottom: 0;
      width: 2px;
      background: #4CAF50;
      transition: height 0.1s;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>虚拟滚动演示</h1>
      <p>支持10万+行文档的高性能编辑</p>
    </div>

    <div class="demo-section">
      <h2>控制面板</h2>
      <div class="controls">
        <button class="btn btn-primary" onclick="loadLargeDocument(1000)">加载 1,000 行</button>
        <button class="btn btn-primary" onclick="loadLargeDocument(10000)">加载 10,000 行</button>
        <button class="btn btn-primary" onclick="loadLargeDocument(100000)">加载 100,000 行</button>
        <button class="btn" onclick="clearDocument()">清空文档</button>
        <button class="btn" onclick="scrollToLine()">跳转到行...</button>
        <button class="btn" onclick="toggleLineNumbers()">切换行号</button>
        <button class="btn" onclick="toggleWordWrap()">切换换行</button>
        <button class="btn" onclick="toggleSyntaxHighlight()">切换语法高亮</button>
      </div>
    </div>

    <div class="demo-section">
      <h2>编辑器</h2>
      <div id="editor" class="editor-container"></div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-label">总行数</div>
          <div class="stat-value" id="total-lines">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">渲染行数</div>
          <div class="stat-value" id="rendered-lines">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">可见范围</div>
          <div class="stat-value" id="visible-range">0-0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">内存使用</div>
          <div class="stat-value" id="memory-usage">0 MB</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">FPS</div>
          <div class="stat-value" id="fps">60</div>
        </div>
      </div>
    </div>

    <div class="demo-section">
      <h2>性能监控</h2>
      <div id="perf-graph" class="perf-graph"></div>
    </div>
  </div>

  <script type="module">
    import { Editor } from '../dist/editor.esm.js'

    let editor
    let virtualScrollConfig = {
      enabled: true,
      lineHeight: 21,
      maxLines: 1000000,
      enableSyntaxHighlight: true,
      enableLineNumbers: true,
      enableWordWrap: false
    }

    // 初始化编辑器
    function initEditor() {
      editor = new Editor({
        element: '#editor',
        virtualScroll: virtualScrollConfig,
        plugins: ['FormattingPlugin', 'HeadingPlugin']
      })

      // 监听虚拟滚动事件
      editor.on('virtualScroll', (metrics) => {
        updateStats(metrics)
      })

      // 初始加载一些内容
      loadLargeDocument(1000)

      // 启动性能监控
      startPerformanceMonitoring()
    }

    // 加载大文档
    window.loadLargeDocument = function (lines) {
      const startTime = performance.now()

      // 生成示例内容
      const content = []
      for (let i = 0; i < lines; i++) {
        if (i % 100 === 0) {
          content.push(`// ============ Section ${i / 100 + 1} ============`)
        } else if (i % 10 === 0) {
          content.push(`function example${i}() {`)
          content.push(`  const result = calculate(${i}, ${i * 2});`)
          content.push(`  return result;`)
          content.push(`}`)
        } else {
          content.push(`const line${i} = "This is line number ${i + 1} of the document. " + "Lorem ipsum dolor sit amet, consectetur adipiscing elit.";`)
        }
      }

      editor.virtualScroller?.setContent(content.join('\n'))

      const loadTime = performance.now() - startTime
      console.log(`Loaded ${lines} lines in ${loadTime.toFixed(2)}ms`)

      // 显示通知
      showNotification(`成功加载 ${lines.toLocaleString()} 行 (耗时: ${loadTime.toFixed(0)}ms)`)
    }

    // 清空文档
    window.clearDocument = function () {
      editor.virtualScroller?.setContent('')
      showNotification('文档已清空')
    }

    // 跳转到指定行
    window.scrollToLine = function () {
      const lineNumber = prompt('跳转到行号:')
      if (lineNumber) {
        const line = parseInt(lineNumber) - 1
        editor.virtualScroller?.scrollToLine(line)
        showNotification(`已跳转到第 ${lineNumber} 行`)
      }
    }

    // 切换行号显示
    window.toggleLineNumbers = function () {
      virtualScrollConfig.enableLineNumbers = !virtualScrollConfig.enableLineNumbers
      // 重新初始化编辑器
      document.getElementById('editor').innerHTML = ''
      initEditor()
    }

    // 切换自动换行
    window.toggleWordWrap = function () {
      virtualScrollConfig.enableWordWrap = !virtualScrollConfig.enableWordWrap
      document.getElementById('editor').innerHTML = ''
      initEditor()
    }

    // 切换语法高亮
    window.toggleSyntaxHighlight = function () {
      virtualScrollConfig.enableSyntaxHighlight = !virtualScrollConfig.enableSyntaxHighlight
      document.getElementById('editor').innerHTML = ''
      initEditor()
    }

    // 更新统计信息
    function updateStats(metrics) {
      if (!editor.virtualScroller) return

      const perfMetrics = editor.virtualScroller.getPerformanceMetrics()

      document.getElementById('total-lines').textContent = perfMetrics.totalLines.toLocaleString()
      document.getElementById('rendered-lines').textContent = perfMetrics.renderedItems
      document.getElementById('visible-range').textContent =
        `${perfMetrics.visibleRange.start + 1}-${perfMetrics.visibleRange.end + 1}`

      const memoryMB = (perfMetrics.totalLines * 0.001).toFixed(1) // 估算
      document.getElementById('memory-usage').textContent = `${memoryMB} MB`
    }

    // FPS监控
    let lastTime = performance.now()
    let frames = 0
    let fpsHistory = []

    function startPerformanceMonitoring() {
      function measureFPS() {
        frames++
        const currentTime = performance.now()

        if (currentTime >= lastTime + 1000) {
          const fps = Math.round((frames * 1000) / (currentTime - lastTime))
          document.getElementById('fps').textContent = fps

          // 更新FPS图表
          updateFPSGraph(fps)

          frames = 0
          lastTime = currentTime
        }

        requestAnimationFrame(measureFPS)
      }

      measureFPS()
    }

    // 更新FPS图表
    function updateFPSGraph(fps) {
      fpsHistory.push(fps)
      if (fpsHistory.length > 60) {
        fpsHistory.shift()
      }

      const graph = document.getElementById('perf-graph')
      graph.innerHTML = ''

      fpsHistory.forEach((fps, index) => {
        const line = document.createElement('div')
        line.className = 'fps-line'
        line.style.left = `${index * (100 / 60)}%`
        line.style.height = `${(fps / 120) * 100}%`
        line.style.background = fps >= 50 ? '#4CAF50' : fps >= 30 ? '#FF9800' : '#F44336'
        graph.appendChild(line)
      })
    }

    // 显示通知
    function showNotification(message) {
      const notification = document.createElement('div')
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: #323232;
        color: white;
        border-radius: 4px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      `
      notification.textContent = message
      document.body.appendChild(notification)

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out'
        setTimeout(() => notification.remove(), 300)
      }, 3000)
    }

    // 添加动画样式
    const style = document.createElement('style')
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `
    document.head.appendChild(style)

    // 初始化
    initEditor()
  </script>
</body>

</html>






