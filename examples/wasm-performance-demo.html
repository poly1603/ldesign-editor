<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDesign Editor - WebAssembly性能演示</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .header p {
      font-size: 18px;
      opacity: 0.9;
    }

    .wasm-status {
      background: rgba(255, 255, 255, 0.2);
      display: inline-block;
      padding: 10px 20px;
      border-radius: 50px;
      margin-top: 20px;
    }

    .wasm-status.supported {
      background: rgba(76, 175, 80, 0.3);
    }

    .wasm-status.unsupported {
      background: rgba(244, 67, 54, 0.3);
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 30px;
    }

    .section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .section-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-content {
      padding: 20px;
    }

    .editor-container {
      min-height: 300px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }

    .btn.secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn.secondary:hover {
      background: #d0d0d0;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .performance-panel {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .performance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .metric {
      background: white;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }

    .metric-value {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
      margin: 10px 0;
    }

    .metric-label {
      font-size: 14px;
      color: #666;
    }

    .benchmark-results {
      margin-top: 20px;
    }

    .benchmark-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .benchmark-item:last-child {
      border-bottom: none;
    }

    .benchmark-bar {
      flex: 1;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      margin: 0 15px;
      position: relative;
      overflow: hidden;
    }

    .benchmark-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.6s ease-out;
      position: relative;
    }

    .benchmark-fill.js {
      background: linear-gradient(90deg, #ff9800, #ff5722);
    }

    .speedup-badge {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      padding: 15px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .log-entry {
      margin-bottom: 5px;
      display: flex;
      align-items: center;
    }

    .log-timestamp {
      color: #858585;
      margin-right: 10px;
    }

    .log-level {
      padding: 2px 6px;
      border-radius: 3px;
      margin-right: 10px;
      font-size: 11px;
      text-transform: uppercase;
    }

    .log-level.info {
      background: #1e88e5;
    }

    .log-level.warn {
      background: #fb8c00;
    }

    .log-level.error {
      background: #e53935;
    }

    .log-level.debug {
      background: #43a047;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    .status-indicator.active {
      background: #4caf50;
    }

    .status-indicator.inactive {
      background: #f44336;
      animation: none;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.toggle-slider {
      background-color: #667eea;
    }

    input:checked+.toggle-slider:before {
      transform: translateX(26px);
    }

    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>🚀 WebAssembly 性能演示</h1>
      <p>体验 LDesign Editor 的极致性能优化</p>
      <div class="wasm-status" id="wasm-status">
        <span class="status-indicator"></span>
        检测中...
      </div>
    </div>

    <div class="content">
      <div class="section">
        <div class="section-header">
          <span>编辑器（带WASM加速）</span>
          <span id="editor1-status">未初始化</span>
        </div>
        <div class="section-content">
          <div id="editor1" class="editor-container"></div>
          <div class="controls">
            <button class="btn" onclick="loadLargeDocument(1)">加载大文档（10k行）</button>
            <button class="btn" onclick="loadHugeDocument(1)">加载超大文档（100k行）</button>
            <button class="btn secondary" onclick="clearEditor(1)">清空</button>
          </div>
          <div class="toggle-container">
            <label>
              <input type="checkbox" id="wasm-toggle" checked onchange="toggleWasm()">
              <span>启用WASM加速</span>
            </label>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <span>基准测试</span>
          <button class="btn" onclick="runBenchmarks()">运行测试</button>
        </div>
        <div class="section-content">
          <div class="benchmark-results" id="benchmark-results">
            <p style="text-align: center; color: #666;">点击"运行测试"开始基准测试</p>
          </div>
        </div>
      </div>
    </div>

    <div style="padding: 0 30px 30px;">
      <div class="performance-panel">
        <h3>实时性能指标</h3>
        <div class="performance-grid" id="performance-metrics">
          <div class="metric">
            <div class="metric-label">WASM状态</div>
            <div class="metric-value" id="metric-wasm-status">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">Diff加速比</div>
            <div class="metric-value" id="metric-diff-speedup">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">解析加速比</div>
            <div class="metric-value" id="metric-parse-speedup">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">累计节省时间</div>
            <div class="metric-value" id="metric-time-saved">-</div>
          </div>
        </div>
      </div>

      <div class="performance-panel">
        <h3>调试日志</h3>
        <div class="log-container" id="log-container"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Editor } from '../src/index.js'

    let editor1
    let wasmEnabled = true
    let logContainer = document.getElementById('log-container')

    // 日志函数
    function log(level, message) {
      const timestamp = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = 'log-entry'
      entry.innerHTML = `
        <span class="log-timestamp">${timestamp}</span>
        <span class="log-level ${level}">${level}</span>
        <span>${message}</span>
      `
      logContainer.appendChild(entry)
      logContainer.scrollTop = logContainer.scrollHeight
    }

    // 检测WebAssembly支持
    function checkWasmSupport() {
      const supported = typeof WebAssembly === 'object' &&
        typeof WebAssembly.instantiate === 'function'

      const statusEl = document.getElementById('wasm-status')
      const indicator = statusEl.querySelector('.status-indicator')

      if (supported) {
        statusEl.className = 'wasm-status supported'
        statusEl.innerHTML = '<span class="status-indicator active"></span>WebAssembly 已支持'
        log('info', 'WebAssembly support detected')

        // 检测高级特性
        const features = []
        if (typeof WebAssembly.instantiateStreaming === 'function') {
          features.push('Streaming')
        }
        if (typeof SharedArrayBuffer !== 'undefined') {
          features.push('Threads')
        }
        log('info', `WebAssembly features: ${features.join(', ') || 'Basic'}`)
      } else {
        statusEl.className = 'wasm-status unsupported'
        statusEl.innerHTML = '<span class="status-indicator inactive"></span>WebAssembly 不支持'
        log('warn', 'WebAssembly not supported')
      }

      return supported
    }

    // 初始化编辑器
    async function initEditor() {
      log('info', 'Initializing editor with WASM acceleration')

      editor1 = new Editor({
        placeholder: '开始输入或加载测试文档...',
        features: {
          bold: true,
          italic: true,
          underline: true,
          link: true,
          image: true,
          list: true,
          heading: true,
          code: true,
          table: true
        },
        wasm: {
          enabled: wasmEnabled,
          enableDiff: true,
          enableParser: true,
          warmupStrategy: 'eager'
        }
      })

      const editorElement = document.getElementById('editor1')
      editor1.mount(editorElement)

      // 监听WASM初始化
      if (editor1.wasmAccelerator) {
        editor1.wasmAccelerator.initialize().then(() => {
          log('info', 'WASM accelerator initialized successfully')
          document.getElementById('editor1-status').textContent = 'WASM已加速'
          updateMetrics()
        }).catch(error => {
          log('error', `WASM initialization failed: ${error.message}`)
          document.getElementById('editor1-status').textContent = '降级到JS'
        })
      } else {
        document.getElementById('editor1-status').textContent = wasmEnabled ? '初始化中...' : 'JS模式'
      }
    }

    // 生成大文档
    function generateLargeDocument(lines) {
      log('info', `Generating document with ${lines} lines`)
      const content = []

      // 生成标题
      content.push('# 性能测试文档\n')
      content.push(`这是一个包含 ${lines} 行的测试文档，用于演示 WebAssembly 加速效果。\n`)
      content.push('\n')

      // 生成内容
      for (let i = 0; i < lines; i++) {
        if (i % 1000 === 0) {
          content.push(`## 第 ${i / 1000 + 1} 章节\n\n`)
        }

        if (i % 100 === 0) {
          content.push(`### 小节 ${i / 100 + 1}\n\n`)
        }

        // 随机生成不同类型的内容
        const type = i % 5
        switch (type) {
          case 0:
            content.push(`这是第 ${i + 1} 行普通文本，包含一些**加粗**和*斜体*文字。\n`)
            break
          case 1:
            content.push(`- 列表项 ${i + 1}：这是一个无序列表项\n`)
            break
          case 2:
            content.push(`${i + 1}. 有序列表项：这是第 ${i + 1} 个有序列表项\n`)
            break
          case 3:
            content.push(`> 引用块 ${i + 1}：这是一段引用文本，来自第 ${i + 1} 行\n`)
            break
          case 4:
            content.push('```javascript\n')
            content.push(`// 代码块 ${i + 1}\n`)
            content.push(`function example${i}() {\n`)
            content.push(`  return "Line ${i + 1}";\n`)
            content.push('}\n')
            content.push('```\n')
            break
        }

        content.push('\n')
      }

      return content.join('')
    }

    // 加载大文档
    window.loadLargeDocument = async function (editorNum) {
      const startTime = performance.now()
      const content = generateLargeDocument(10000)

      log('info', 'Loading large document (10k lines)...')

      if (editorNum === 1 && editor1) {
        editor1.setContent(content)
        const loadTime = performance.now() - startTime
        log('info', `Document loaded in ${loadTime.toFixed(2)}ms`)
        updateMetrics()
      }
    }

    // 加载超大文档
    window.loadHugeDocument = async function (editorNum) {
      const startTime = performance.now()
      const content = generateLargeDocument(100000)

      log('info', 'Loading huge document (100k lines)...')

      if (editorNum === 1 && editor1) {
        editor1.setContent(content)
        const loadTime = performance.now() - startTime
        log('info', `Document loaded in ${loadTime.toFixed(2)}ms`)
        updateMetrics()
      }
    }

    // 清空编辑器
    window.clearEditor = function (editorNum) {
      if (editorNum === 1 && editor1) {
        editor1.setContent('')
        log('info', 'Editor cleared')
      }
    }

    // 切换WASM
    window.toggleWasm = function () {
      wasmEnabled = document.getElementById('wasm-toggle').checked
      log('info', `WASM acceleration ${wasmEnabled ? 'enabled' : 'disabled'}`)

      // 重新初始化编辑器
      if (editor1) {
        const content = editor1.getContent()
        editor1.destroy()
        initEditor().then(() => {
          editor1.setContent(content)
        })
      }
    }

    // 运行基准测试
    window.runBenchmarks = async function () {
      log('info', 'Starting benchmarks...')
      const results = document.getElementById('benchmark-results')
      results.innerHTML = '<p>运行中...</p>'

      const benchmarks = [
        {
          name: 'Diff计算（1000字符）',
          run: async (useWasm) => {
            const text1 = generateLargeDocument(10).slice(0, 1000)
            const text2 = text1.replace(/Line \d+/g, 'Modified Line')

            const start = performance.now()
            if (useWasm && editor1.wasmAccelerator) {
              await editor1.wasmAccelerator.diff(text1, text2)
            } else {
              // JS实现
              await editor1.wasmAccelerator?.diff(text1, text2)
            }
            return performance.now() - start
          }
        },
        {
          name: '文档解析（5000行）',
          run: async (useWasm) => {
            const text = generateLargeDocument(5000)

            const start = performance.now()
            if (useWasm && editor1.wasmAccelerator) {
              await editor1.wasmAccelerator.parse(text)
            } else {
              // JS实现
              const lines = text.split('\n')
              // 简单解析
            }
            return performance.now() - start
          }
        },
        {
          name: '字符串比较（10000次）',
          run: async (useWasm) => {
            const str1 = 'Hello World'
            const str2 = 'Hello World'

            const start = performance.now()
            for (let i = 0; i < 10000; i++) {
              if (useWasm && editor1.wasmAccelerator) {
                await editor1.wasmAccelerator.compare(str1, str2)
              } else {
                str1 === str2
              }
            }
            return performance.now() - start
          }
        }
      ]

      results.innerHTML = ''

      for (const benchmark of benchmarks) {
        const item = document.createElement('div')
        item.className = 'benchmark-item'

        // 运行WASM版本
        const wasmTime = await benchmark.run(true)

        // 运行JS版本
        editor1.wasmAccelerator.options.enabled = false
        const jsTime = await benchmark.run(false)
        editor1.wasmAccelerator.options.enabled = true

        const speedup = jsTime / wasmTime
        const percentage = (wasmTime / jsTime) * 100

        item.innerHTML = `
          <div style="min-width: 150px;">${benchmark.name}</div>
          <div class="benchmark-bar">
            <div class="benchmark-fill" style="width: ${percentage}%">
              <span class="speedup-badge">${speedup.toFixed(2)}x</span>
            </div>
          </div>
          <div style="min-width: 100px; text-align: right;">
            ${wasmTime.toFixed(2)}ms
          </div>
        `

        results.appendChild(item)

        log('debug', `${benchmark.name}: WASM=${wasmTime.toFixed(2)}ms, JS=${jsTime.toFixed(2)}ms, Speedup=${speedup.toFixed(2)}x`)
      }

      log('info', 'Benchmarks completed')
      updateMetrics()
    }

    // 更新性能指标
    function updateMetrics() {
      if (editor1?.wasmAccelerator) {
        const stats = editor1.wasmAccelerator.getStats()

        document.getElementById('metric-wasm-status').textContent =
          stats.initialized ? '已激活' : '未激活'

        document.getElementById('metric-diff-speedup').textContent =
          stats.performance.averageSpeedup.toFixed(2) + 'x'

        document.getElementById('metric-parse-speedup').textContent =
          stats.performance.averageSpeedup.toFixed(2) + 'x'

        document.getElementById('metric-time-saved').textContent =
          stats.performance.totalTimeSaved.toFixed(0) + 'ms'
      }
    }

    // 初始化
    checkWasmSupport()
    initEditor()

    // 定期更新指标
    setInterval(updateMetrics, 1000)

    log('info', 'Demo initialized')
  </script>
</body>

</html>



