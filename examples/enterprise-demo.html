<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDesign Editor - ä¼ä¸šçº§åŠŸèƒ½æ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
    }

    .header h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      background: #f8f9fa;
    }

    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      background: #e8e8e8;
    }

    .tab.active {
      background: white;
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: 600;
    }

    .tab-content {
      display: none;
      padding: 30px;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 20px;
    }

    .card {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    button:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .user-role {
      font-size: 13px;
      color: #666;
    }

    .permission-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .permission-card {
      padding: 12px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .permission-card.granted {
      border-color: #4caf50;
      background: #f1f8f4;
    }

    .permission-card.denied {
      border-color: #f44336;
      background: #fef5f5;
    }

    .audit-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .audit-table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
    }

    .audit-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .audit-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.failure {
      background: #f8d7da;
      color: #721c24;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¢ ä¼ä¸šçº§åŠŸèƒ½æ¼”ç¤º</h1>
      <p>æƒé™æ§åˆ¶ Â· SSOé›†æˆ Â· å®¡è®¡æ—¥å¿—</p>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="permissions">ğŸ” æƒé™ç®¡ç†</div>
      <div class="tab" data-tab="sso">ğŸ”‘ SSOç™»å½•</div>
      <div class="tab" data-tab="audit">ğŸ“‹ å®¡è®¡æ—¥å¿—</div>
    </div>

    <!-- æƒé™ç®¡ç†æ ‡ç­¾ -->
    <div class="tab-content active" id="permissions">
      <div class="section">
        <h3>å½“å‰ç”¨æˆ·</h3>
        <div id="currentUser">
          <p style="color: #999;">æœªç™»å½•</p>
        </div>
      </div>

      <div class="section">
        <h3>æƒé™æ£€æŸ¥</h3>
        <div class="permission-grid" id="permissionGrid"></div>
      </div>

      <div class="section">
        <h3>è§’è‰²ç®¡ç†</h3>
        <div class="card">
          <select id="roleSelect" style="padding: 8px; width: 200px; margin-right: 10px;">
            <option value="admin">ç®¡ç†å‘˜</option>
            <option value="editor">ç¼–è¾‘è€…</option>
            <option value="viewer">æŸ¥çœ‹è€…</option>
            <option value="commenter">è¯„è®ºè€…</option>
          </select>
          <button id="assignRole">åˆ†é…è§’è‰²</button>
        </div>
      </div>

      <div class="section">
        <h3>ç¼–è¾‘å™¨æµ‹è¯•</h3>
        <div class="button-group">
          <button id="testRead">æµ‹è¯•è¯»å–</button>
          <button id="testWrite">æµ‹è¯•ç¼–è¾‘</button>
          <button id="testDelete">æµ‹è¯•åˆ é™¤</button>
          <button id="testShare">æµ‹è¯•åˆ†äº«</button>
        </div>
        <div id="testResult"
          style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 4px; display: none;">
        </div>
      </div>
    </div>

    <!-- SSOæ ‡ç­¾ -->
    <div class="tab-content" id="sso">
      <div class="section">
        <h3>SSOæä¾›å•†</h3>
        <div class="card">
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">é€‰æ‹©è®¤è¯æ–¹å¼</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div class="card" style="cursor: pointer; text-align: center;" data-provider="oauth2">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ”</div>
                <strong>OAuth 2.0</strong>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">æ ‡å‡†OAuthè®¤è¯</p>
              </div>
              <div class="card" style="cursor: pointer; text-align: center;" data-provider="saml">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ«</div>
                <strong>SAML</strong>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">ä¼ä¸šçº§SAML 2.0</p>
              </div>
              <div class="card" style="cursor: pointer; text-align: center;" data-provider="ldap">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                <strong>LDAP/AD</strong>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">ç›®å½•æœåŠ¡è®¤è¯</p>
              </div>
            </div>
          </div>

          <div class="button-group">
            <button id="ssoLogin">ğŸ”‘ SSOç™»å½•</button>
            <button id="ssoLogout" disabled>ğŸšª ç™»å‡º</button>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>è®¤è¯çŠ¶æ€</h3>
        <div class="card">
          <div><strong>çŠ¶æ€ï¼š</strong> <span id="authStatus">æœªè®¤è¯</span></div>
          <div style="margin-top: 10px;"><strong>Tokenï¼š</strong> <span id="tokenInfo">æ— </span></div>
        </div>
      </div>
    </div>

    <!-- å®¡è®¡æ—¥å¿—æ ‡ç­¾ -->
    <div class="tab-content" id="audit">
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalLogs">0</div>
          <div class="stat-label">æ€»æ—¥å¿—æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="uniqueUsers">0</div>
          <div class="stat-label">ç”¨æˆ·æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="uniqueActions">0</div>
          <div class="stat-label">æ“ä½œç±»å‹</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pendingLogs">0</div>
          <div class="stat-label">å¾…åŒæ­¥</div>
        </div>
      </div>

      <div class="section">
        <h3>æ“ä½œè®°å½•</h3>
        <div class="button-group">
          <button id="generateLogs">ğŸ² ç”Ÿæˆæµ‹è¯•æ—¥å¿—</button>
          <button id="exportJSON">ğŸ“¥ å¯¼å‡ºJSON</button>
          <button id="exportCSV">ğŸ“¥ å¯¼å‡ºCSV</button>
          <button id="clearLogs">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
      </div>

      <div class="section">
        <div style="max-height: 400px; overflow-y: auto;">
          <table class="audit-table">
            <thead>
              <tr>
                <th>æ—¶é—´</th>
                <th>ç”¨æˆ·</th>
                <th>æ“ä½œ</th>
                <th>èµ„æº</th>
                <th>ç»“æœ</th>
              </tr>
            </thead>
            <tbody id="auditTableBody">
              <tr>
                <td colspan="5" style="text-align: center; color: #999; padding: 30px;">
                  æš‚æ— å®¡è®¡æ—¥å¿—
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Editor, PermissionManager, SSOManager, AuditLogger } from '../dist/es/index.js'

    // åˆå§‹åŒ–æƒé™ç®¡ç†å™¨
    const permissionManager = new PermissionManager({
      strictMode: true,
      inheritRoles: true
    })

    // åˆå§‹åŒ–SSOç®¡ç†å™¨
    let ssoManager
    let selectedProvider = 'oauth2'

    // åˆå§‹åŒ–å®¡è®¡æ—¥å¿—
    const auditLogger = new AuditLogger({
      enabled: true,
      storage: 'indexeddb',
      maxLogs: 10000,
      persistToDisk: true,
      includeContent: true
    })

    await auditLogger.initialize()

    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    const editor = new Editor({
      content: '<h2>ä¼ä¸šçº§ç¼–è¾‘å™¨</h2><p>è¿™ä¸ªç¼–è¾‘å™¨é›†æˆäº†å®Œæ•´çš„ä¼ä¸šçº§åŠŸèƒ½ï¼ŒåŒ…æ‹¬æƒé™æ§åˆ¶ã€SSOç™»å½•å’Œå®¡è®¡æ—¥å¿—ã€‚</p>',
      placeholder: 'å¼€å§‹è¾“å…¥...'
    })

    editor.mount('#editor')

    // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•
    function simulateLogin(roleId) {
      const user = {
        id: `user-${Math.random().toString(36).substr(2, 9)}`,
        name: `æµ‹è¯•ç”¨æˆ· (${roleId})`,
        email: `user@example.com`,
        roles: [roleId]
      }

      permissionManager.setCurrentUser(user)
      permissionManager.assignRole(user.id, roleId)

      // è®°å½•å®¡è®¡æ—¥å¿—
      auditLogger.log({
        userId: user.id,
        action: 'user.login',
        result: 'success',
        metadata: {
          role: roleId,
          timestamp: Date.now()
        }
      })

      updateCurrentUser(user)
      updatePermissions()
      updateAuditStats()
    }

    // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
    function updateCurrentUser(user) {
      const container = document.getElementById('currentUser')
      container.innerHTML = `
        <div class="user-card">
          <div class="user-avatar">${user.name.charAt(0)}</div>
          <div class="user-info">
            <div class="user-name">${user.name}</div>
            <div class="user-role">è§’è‰²: ${user.roles.join(', ')}</div>
          </div>
          <button onclick="window.simulateLogin('viewer')">åˆ‡æ¢ä¸ºæŸ¥çœ‹è€…</button>
          <button onclick="window.simulateLogin('editor')">åˆ‡æ¢ä¸ºç¼–è¾‘è€…</button>
          <button onclick="window.simulateLogin('admin')">åˆ‡æ¢ä¸ºç®¡ç†å‘˜</button>
        </div>
      `
    }

    // æ›´æ–°æƒé™æ˜¾ç¤º
    function updatePermissions() {
      const permissions = [
        { id: 'document.read', name: 'è¯»å–æ–‡æ¡£' },
        { id: 'document.write', name: 'ç¼–è¾‘æ–‡æ¡£' },
        { id: 'document.create', name: 'åˆ›å»ºæ–‡æ¡£' },
        { id: 'document.delete', name: 'åˆ é™¤æ–‡æ¡£' },
        { id: 'document.share', name: 'åˆ†äº«æ–‡æ¡£' },
        { id: 'comment.create', name: 'åˆ›å»ºè¯„è®º' },
        { id: 'admin.users', name: 'ç®¡ç†ç”¨æˆ·' },
        { id: 'admin.settings', name: 'ç®¡ç†è®¾ç½®' }
      ]

      const grid = document.getElementById('permissionGrid')
      grid.innerHTML = permissions.map(p => {
        const hasPermission = permissionManager.hasPermission(p.id)
        return `
          <div class="permission-card ${hasPermission ? 'granted' : 'denied'}">
            <span>${p.name}</span>
            <span>${hasPermission ? 'âœ…' : 'âŒ'}</span>
          </div>
        `
      }).join('')
    }

    // æ›´æ–°å®¡è®¡ç»Ÿè®¡
    function updateAuditStats() {
      const stats = auditLogger.getStats()
      document.getElementById('totalLogs').textContent = stats.totalLogs
      document.getElementById('uniqueUsers').textContent = stats.uniqueUsers
      document.getElementById('uniqueActions').textContent = stats.uniqueActions
      document.getElementById('pendingLogs').textContent = stats.pendingLogs
    }

    // æ›´æ–°å®¡è®¡è¡¨æ ¼
    async function updateAuditTable() {
      const logs = await auditLogger.query({ limit: 20, sortOrder: 'desc' })
      const tbody = document.getElementById('auditTableBody')

      if (logs.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: #999; padding: 30px;">
              æš‚æ— å®¡è®¡æ—¥å¿—
            </td>
          </tr>
        `
        return
      }

      tbody.innerHTML = logs.map(log => `
        <tr>
          <td>${new Date(log.timestamp).toLocaleString()}</td>
          <td>${log.userId}</td>
          <td>${log.action}</td>
          <td>${log.resource || '-'}</td>
          <td>
            <span class="badge ${log.result || 'success'}">${log.result || 'success'}</span>
          </td>
        </tr>
      `).join('')
    }

    // æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))

        tab.classList.add('active')
        document.getElementById(tabName).classList.add('active')
      })
    })

    // æƒé™æµ‹è¯•
    document.getElementById('testRead').addEventListener('click', () => {
      const result = document.getElementById('testResult')
      try {
        permissionManager.assertPermission('document.read')
        result.style.display = 'block'
        result.style.background = '#d4edda'
        result.style.color = '#155724'
        result.innerHTML = 'âœ… è¯»å–æƒé™æ£€æŸ¥é€šè¿‡'

        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.read',
          resource: 'document',
          result: 'success'
        })
      } catch (error) {
        result.style.display = 'block'
        result.style.background = '#f8d7da'
        result.style.color = '#721c24'
        result.innerHTML = 'âŒ æƒé™ä¸è¶³: ' + error.message

        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.read',
          resource: 'document',
          result: 'failure'
        })
      }

      updateAuditStats()
      updateAuditTable()
    })

    document.getElementById('testWrite').addEventListener('click', () => {
      const result = document.getElementById('testResult')
      try {
        permissionManager.assertPermission('document.write')
        result.style.display = 'block'
        result.style.background = '#d4edda'
        result.innerHTML = 'âœ… ç¼–è¾‘æƒé™æ£€æŸ¥é€šè¿‡'
        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.write',
          result: 'success'
        })
      } catch (error) {
        result.style.display = 'block'
        result.style.background = '#f8d7da'
        result.innerHTML = 'âŒ æƒé™ä¸è¶³: ' + error.message
        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.write',
          result: 'failure'
        })
      }
      updateAuditStats()
      updateAuditTable()
    })

    document.getElementById('testDelete').addEventListener('click', () => {
      const result = document.getElementById('testResult')
      try {
        permissionManager.assertPermission('document.delete')
        result.style.display = 'block'
        result.style.background = '#d4edda'
        result.innerHTML = 'âœ… åˆ é™¤æƒé™æ£€æŸ¥é€šè¿‡'
        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.delete',
          result: 'success'
        })
      } catch (error) {
        result.style.display = 'block'
        result.style.background = '#f8d7da'
        result.innerHTML = 'âŒ æƒé™ä¸è¶³: ' + error.message
        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.delete',
          result: 'failure'
        })
      }
      updateAuditStats()
      updateAuditTable()
    })

    document.getElementById('testShare').addEventListener('click', () => {
      const result = document.getElementById('testResult')
      try {
        permissionManager.assertPermission('document.share')
        result.style.display = 'block'
        result.style.background = '#d4edda'
        result.innerHTML = 'âœ… åˆ†äº«æƒé™æ£€æŸ¥é€šè¿‡'
        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.share',
          result: 'success'
        })
      } catch (error) {
        result.style.display = 'block'
        result.style.background = '#f8d7da'
        result.innerHTML = 'âŒ æƒé™ä¸è¶³: ' + error.message
        auditLogger.log({
          userId: permissionManager.getCurrentUser()?.id || 'anonymous',
          action: 'document.share',
          result: 'failure'
        })
      }
      updateAuditStats()
      updateAuditTable()
    })

    // åˆ†é…è§’è‰²
    document.getElementById('assignRole').addEventListener('click', () => {
      const role = document.getElementById('roleSelect').value
      const user = permissionManager.getCurrentUser()
      if (user) {
        permissionManager.assignRole(user.id, role)
        updateCurrentUser({ ...user, roles: [role] })
        updatePermissions()

        auditLogger.log({
          userId: user.id,
          action: 'role.assign',
          resource: 'role',
          resourceId: role,
          result: 'success'
        })

        updateAuditStats()
        updateAuditTable()
      }
    })

    // å®¡è®¡æ—¥å¿—æ“ä½œ
    document.getElementById('generateLogs').addEventListener('click', () => {
      const actions = ['document.read', 'document.write', 'document.delete', 'comment.create', 'document.share']
      const users = ['user-1', 'user-2', 'user-3']

      for (let i = 0; i < 20; i++) {
        auditLogger.log({
          userId: users[Math.floor(Math.random() * users.length)],
          action: actions[Math.floor(Math.random() * actions.length)],
          resource: 'document',
          resourceId: `doc-${Math.floor(Math.random() * 10)}`,
          result: Math.random() > 0.1 ? 'success' : 'failure'
        })
      }

      updateAuditStats()
      updateAuditTable()
    })

    document.getElementById('exportJSON').addEventListener('click', async () => {
      const blob = await auditLogger.export('json')
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `audit-logs-${Date.now()}.json`
      a.click()
      URL.revokeObjectURL(url)
    })

    document.getElementById('exportCSV').addEventListener('click', async () => {
      const blob = await auditLogger.export('csv')
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `audit-logs-${Date.now()}.csv`
      a.click()
      URL.revokeObjectURL(url)
    })

    document.getElementById('clearLogs').addEventListener('click', async () => {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å®¡è®¡æ—¥å¿—å—ï¼Ÿ')) {
        await auditLogger.clear()
        updateAuditStats()
        updateAuditTable()
      }
    })

    // å¯¼å‡ºåˆ°å…¨å±€
    window.simulateLogin = simulateLogin
    window.permissionManager = permissionManager
    window.auditLogger = auditLogger

    // åˆå§‹åŒ–ï¼šé»˜è®¤ä»¥æŸ¥çœ‹è€…èº«ä»½ç™»å½•
    simulateLogin('viewer')

    console.log('ğŸ’¡ æç¤ºï¼š')
    console.log('- åˆ‡æ¢ä¸åŒè§’è‰²è§‚å¯Ÿæƒé™å˜åŒ–')
    console.log('- æ‰€æœ‰æ“ä½œéƒ½ä¼šè¢«å®¡è®¡æ—¥å¿—è®°å½•')
    console.log('- å¯ä»¥å¯¼å‡ºå®¡è®¡æ—¥å¿—ä¸ºJSONæˆ–CSVæ ¼å¼')
  </script>
</body>

</html>
