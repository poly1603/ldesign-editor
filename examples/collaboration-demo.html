<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDesign Editor - ç¦»çº¿åä½œæ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .editor-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 80vh;
    }

    .panel-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .panel-header h2 {
      font-size: 24px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-header .status {
      font-size: 13px;
      opacity: 0.9;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .users-list {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }

    .users-list h4 {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      font-size: 12px;
      margin-right: 8px;
    }

    .user-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .editor-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .info-panel {
      padding: 20px;
      background: #f0f4ff;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .info-item {
      background: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .info-item .label {
      color: #666;
      margin-bottom: 4px;
    }

    .info-item .value {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }

    .controls {
      padding: 15px 20px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .controls button {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .controls button:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }

    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .log-panel {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      font-family: 'Consolas', monospace;
      font-size: 11px;
      height: 150px;
      overflow-y: auto;
    }

    .conflict-indicator {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: #ff9800;
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100px);
        opacity: 0;
      }

      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .ldesign-editor {
      min-height: 200px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 15px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ç¼–è¾‘å™¨1 -->
    <div class="editor-panel">
      <div class="panel-header">
        <h2>
          <span>ğŸ‘¤</span>
          ç¼–è¾‘å™¨ Aï¼ˆç”¨æˆ·1ï¼‰
        </h2>
        <div class="status">
          <span class="status-dot" id="status1"></span>
          <span id="statusText1">æœªè¿æ¥</span>
        </div>
      </div>

      <div class="users-list">
        <h4>åœ¨çº¿ç”¨æˆ·</h4>
        <div id="users1"></div>
      </div>

      <div class="info-panel">
        <div class="info-grid">
          <div class="info-item">
            <div class="label">æ“ä½œæ•°</div>
            <div class="value" id="ops1">0</div>
          </div>
          <div class="info-item">
            <div class="label">æ—¶é’Ÿ</div>
            <div class="value" id="clock1">0</div>
          </div>
          <div class="info-item">
            <div class="label">å­—ç¬¦æ•°</div>
            <div class="value" id="chars1">0</div>
          </div>
          <div class="info-item">
            <div class="label">å†²çª</div>
            <div class="value" id="conflicts1">0</div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="connect1">ğŸ”— è¿æ¥</button>
        <button id="disconnect1" disabled>ğŸ”Œ æ–­å¼€</button>
        <button id="insert1">â• æ’å…¥æ–‡æœ¬</button>
        <button id="delete1">â– åˆ é™¤æ–‡æœ¬</button>
        <button id="sync1">ğŸ”„ æ‰‹åŠ¨åŒæ­¥</button>
      </div>

      <div class="editor-container">
        <div id="editor1"></div>
      </div>

      <div class="log-panel" id="log1"></div>
    </div>

    <!-- ç¼–è¾‘å™¨2 -->
    <div class="editor-panel">
      <div class="panel-header">
        <h2>
          <span>ğŸ‘¤</span>
          ç¼–è¾‘å™¨ Bï¼ˆç”¨æˆ·2ï¼‰
        </h2>
        <div class="status">
          <span class="status-dot" id="status2"></span>
          <span id="statusText2">æœªè¿æ¥</span>
        </div>
      </div>

      <div class="users-list">
        <h4>åœ¨çº¿ç”¨æˆ·</h4>
        <div id="users2"></div>
      </div>

      <div class="info-panel">
        <div class="info-grid">
          <div class="info-item">
            <div class="label">æ“ä½œæ•°</div>
            <div class="value" id="ops2">0</div>
          </div>
          <div class="info-item">
            <div class="label">æ—¶é’Ÿ</div>
            <div class="value" id="clock2">0</div>
          </div>
          <div class="info-item">
            <div class="label">å­—ç¬¦æ•°</div>
            <div class="value" id="chars2">0</div>
          </div>
          <div class="info-item">
            <div class="label">å†²çª</div>
            <div class="value" id="conflicts2">0</div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="connect2">ğŸ”— è¿æ¥</button>
        <button id="disconnect2" disabled>ğŸ”Œ æ–­å¼€</button>
        <button id="insert2">â• æ’å…¥æ–‡æœ¬</button>
        <button id="delete2">â– åˆ é™¤æ–‡æœ¬</button>
        <button id="sync2">ğŸ”„ æ‰‹åŠ¨åŒæ­¥</button>
      </div>

      <div class="editor-container">
        <div id="editor2"></div>
      </div>

      <div class="log-panel" id="log2"></div>
    </div>
  </div>

  <div class="conflict-indicator" id="conflictIndicator">
    âš ï¸ æ£€æµ‹åˆ°å†²çªï¼Œå·²è‡ªåŠ¨è§£å†³
  </div>

  <script type="module">
    import { Editor, CollaborationManager, CRDT } from '../dist/es/index.js'

    // æ—¥å¿—å‡½æ•°
    function log(panelId, message, type = 'info') {
      const logEl = document.getElementById(`log${panelId}`)
      const time = new Date().toLocaleTimeString()
      const colors = {
        info: '#4caf50',
        warn: '#ff9800',
        error: '#f44336',
        debug: '#2196f3'
      }

      logEl.innerHTML += `
        <div style="margin-bottom: 2px;">
          <span style="color: #888;">[${time}]</span>
          <span style="color: ${colors[type]};">[${type.toUpperCase()}]</span>
          <span>${message}</span>
        </div>
      `
      logEl.scrollTop = logEl.scrollHeight
    }

    // åˆ›å»ºç¼–è¾‘å™¨1
    const editor1 = new Editor({
      content: '<h3>åä½œç¼–è¾‘æ¼”ç¤º</h3><p>è¿™æ˜¯ä¸€ä¸ªåŸºäºCRDTçš„ç¦»çº¿åä½œç¼–è¾‘å™¨ã€‚ä¸¤ä¸ªç¼–è¾‘å™¨å¯ä»¥åŒæ—¶ç¼–è¾‘ï¼Œæ‰€æœ‰æ›´æ”¹ä¼šè‡ªåŠ¨åŒæ­¥ï¼Œå†²çªä¼šè‡ªåŠ¨è§£å†³ã€‚</p>',
      placeholder: 'å¼€å§‹è¾“å…¥...'
    })
    editor1.mount('#editor1')

    // åˆ›å»ºç¼–è¾‘å™¨2
    const editor2 = new Editor({
      content: '<h3>åä½œç¼–è¾‘æ¼”ç¤º</h3><p>è¿™æ˜¯ä¸€ä¸ªåŸºäºCRDTçš„ç¦»çº¿åä½œç¼–è¾‘å™¨ã€‚ä¸¤ä¸ªç¼–è¾‘å™¨å¯ä»¥åŒæ—¶ç¼–è¾‘ï¼Œæ‰€æœ‰æ›´æ”¹ä¼šè‡ªåŠ¨åŒæ­¥ï¼Œå†²çªä¼šè‡ªåŠ¨è§£å†³ã€‚</p>',
      placeholder: 'å¼€å§‹è¾“å…¥...'
    })
    editor2.mount('#editor2')

    // åˆ›å»ºåä½œç®¡ç†å™¨ï¼ˆæ¨¡æ‹Ÿæœ¬åœ°åä½œï¼‰
    const collab1 = new CollaborationManager(editor1, {
      user: {
        id: 'user-1',
        name: 'ç”¨æˆ· A',
        avatar: 'ğŸ‘¨'
      }
    })

    const collab2 = new CollaborationManager(editor2, {
      user: {
        id: 'user-2',
        name: 'ç”¨æˆ· B',
        avatar: 'ğŸ‘©'
      }
    })

    // æ¨¡æ‹ŸP2PåŒæ­¥ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰
    collab1.on('remote-operation', (op) => {
      // å°†æ“ä½œå‘é€åˆ°ç¼–è¾‘å™¨2
      collab2['crdt'].applyOperation(op)
      editor2.setContent(collab2['crdt'].getText())
      log(2, `æ”¶åˆ°è¿œç¨‹æ“ä½œ: ${op.type}`, 'debug')
      updateStats(2)
    })

    collab2.on('remote-operation', (op) => {
      // å°†æ“ä½œå‘é€åˆ°ç¼–è¾‘å™¨1
      collab1['crdt'].applyOperation(op)
      editor1.setContent(collab1['crdt'].getText())
      log(1, `æ”¶åˆ°è¿œç¨‹æ“ä½œ: ${op.type}`, 'debug')
      updateStats(1)
    })

    // ç›‘å¬ç¼–è¾‘å™¨å˜åŒ–
    editor1.on('change', () => {
      updateStats(1)
      // æ¨¡æ‹Ÿå‘é€åˆ°ç¼–è¾‘å™¨2
      setTimeout(() => {
        const state1 = collab1.getCRDTState()
        const newOps = collab2['crdt'].merge(state1)
        if (newOps.length > 0) {
          editor2.setContent(collab2['crdt'].getText())
          log(2, `åŒæ­¥äº† ${newOps.length} ä¸ªæ“ä½œ`, 'info')
        }
      }, 100)
    })

    editor2.on('change', () => {
      updateStats(2)
      // æ¨¡æ‹Ÿå‘é€åˆ°ç¼–è¾‘å™¨1
      setTimeout(() => {
        const state2 = collab2.getCRDTState()
        const newOps = collab1['crdt'].merge(state2)
        if (newOps.length > 0) {
          editor1.setContent(collab1['crdt'].getText())
          log(1, `åŒæ­¥äº† ${newOps.length} ä¸ªæ“ä½œ`, 'info')
        }
      }, 100)
    })

    // æ›´æ–°ç»Ÿè®¡
    function updateStats(panelId) {
      const collab = panelId === 1 ? collab1 : collab2
      const state = collab.getCRDTState()

      document.getElementById(`ops${panelId}`).textContent = state.operations.length
      document.getElementById(`clock${panelId}`).textContent = state.clock
      document.getElementById(`chars${panelId}`).textContent = collab['crdt'].getText().length
    }

    // æ›´æ–°åœ¨çº¿ç”¨æˆ·
    function updateUsers(panelId) {
      const collab = panelId === 1 ? collab1 : collab2
      const users = collab.getOnlineUsers()
      const container = document.getElementById(`users${panelId}`)

      container.innerHTML = users.map(user => `
        <span class="user-badge">
          <span class="dot" style="background: ${user.color};"></span>
          <span>${user.avatar} ${user.name}</span>
        </span>
      `).join('')
    }

    // æ§åˆ¶æŒ‰é’®
    document.getElementById('connect1').addEventListener('click', () => {
      log(1, 'è¿æ¥åˆ°åä½œæœåŠ¡å™¨...', 'info')
      document.getElementById('statusText1').textContent = 'å·²è¿æ¥ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰'
      document.getElementById('connect1').disabled = true
      document.getElementById('disconnect1').disabled = false
      updateUsers(1)
    })

    document.getElementById('disconnect1').addEventListener('click', () => {
      log(1, 'æ–­å¼€è¿æ¥', 'info')
      document.getElementById('statusText1').textContent = 'æœªè¿æ¥'
      document.getElementById('connect1').disabled = false
      document.getElementById('disconnect1').disabled = true
    })

    document.getElementById('insert1').addEventListener('click', () => {
      editor1.insertText('æµ‹è¯•æ’å…¥ ')
      log(1, 'æ’å…¥æ–‡æœ¬', 'info')
    })

    document.getElementById('delete1').addEventListener('click', () => {
      const text = editor1.getContent()
      if (text.length > 0) {
        editor1.setContent(text.substring(0, text.length - 1))
        log(1, 'åˆ é™¤æ–‡æœ¬', 'info')
      }
    })

    document.getElementById('sync1').addEventListener('click', () => {
      const state1 = collab1.getCRDTState()
      collab2['crdt'].merge(state1)
      editor2.setContent(collab2['crdt'].getText())
      log(1, 'æ‰‹åŠ¨åŒæ­¥å®Œæˆ', 'info')
      log(2, 'æ”¶åˆ°åŒæ­¥æ•°æ®', 'info')
      updateStats(2)
    })

    // ç¼–è¾‘å™¨2çš„æ§åˆ¶
    document.getElementById('connect2').addEventListener('click', () => {
      log(2, 'è¿æ¥åˆ°åä½œæœåŠ¡å™¨...', 'info')
      document.getElementById('statusText2').textContent = 'å·²è¿æ¥ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰'
      document.getElementById('connect2').disabled = true
      document.getElementById('disconnect2').disabled = false
      updateUsers(2)
    })

    document.getElementById('disconnect2').addEventListener('click', () => {
      log(2, 'æ–­å¼€è¿æ¥', 'info')
      document.getElementById('statusText2').textContent = 'æœªè¿æ¥'
      document.getElementById('connect2').disabled = false
      document.getElementById('disconnect2').disabled = true
    })

    document.getElementById('insert2').addEventListener('click', () => {
      editor2.insertText('æµ‹è¯•æ’å…¥ ')
      log(2, 'æ’å…¥æ–‡æœ¬', 'info')
    })

    document.getElementById('delete2').addEventListener('click', () => {
      const text = editor2.getContent()
      if (text.length > 0) {
        editor2.setContent(text.substring(0, text.length - 1))
        log(2, 'åˆ é™¤æ–‡æœ¬', 'info')
      }
    })

    document.getElementById('sync2').addEventListener('click', () => {
      const state2 = collab2.getCRDTState()
      collab1['crdt'].merge(state2)
      editor1.setContent(collab1['crdt'].getText())
      log(2, 'æ‰‹åŠ¨åŒæ­¥å®Œæˆ', 'info')
      log(1, 'æ”¶åˆ°åŒæ­¥æ•°æ®', 'info')
      updateStats(1)
    })

    // åˆå§‹åŒ–
    log(1, 'CRDTåä½œç³»ç»Ÿå·²åˆå§‹åŒ–', 'info')
    log(2, 'CRDTåä½œç³»ç»Ÿå·²åˆå§‹åŒ–', 'info')
    log(1, `ç«™ç‚¹ID: ${collab1.getCRDTState().siteId}`, 'debug')
    log(2, `ç«™ç‚¹ID: ${collab2.getCRDTState().siteId}`, 'debug')

    updateStats(1)
    updateStats(2)
    updateUsers(1)
    updateUsers(2)

    // æ¼”ç¤ºæç¤º
    console.log('ğŸ’¡ æç¤ºï¼š')
    console.log('- åœ¨ä¸¤ä¸ªç¼–è¾‘å™¨ä¸­åŒæ—¶ç¼–è¾‘ï¼Œè§‚å¯Ÿè‡ªåŠ¨åŒæ­¥')
    console.log('- CRDTä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œæ— éœ€æ‰‹åŠ¨è§£å†³å†²çª')
    console.log('- æ”¯æŒç¦»çº¿ç¼–è¾‘ï¼Œè”ç½‘åè‡ªåŠ¨åŒæ­¥')
  </script>
</body>

</html>
