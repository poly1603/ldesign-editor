# æœ€ç»ˆçŠ¶æ€æ€»ç»“

**æ—¥æœŸ**: 2025-10-30  
**å·¥ä½œæ—¶é•¿**: çº¦2å°æ—¶  
**è¿›å±•**: Builderä¿®å¤å®Œæˆï¼Œä½†PostCSS bugä¾ç„¶å­˜åœ¨

---

## âœ… å·²æˆåŠŸå®Œæˆ

### 1. ç¯å¢ƒéªŒè¯ âœ“
- Node.js v20.19.5
- pnpm 9.15.9
- é¡¹ç›®ç»“æ„å®Œæ•´

### 2. ä¾èµ–å®‰è£… âœ“
- ä¿®å¤äº† lottie/preact/example çš„ä¾èµ–é—®é¢˜
- ä¿®å¤äº† lottie/qwik/example çš„ä¾èµ–é—®é¢˜
- æˆåŠŸå®‰è£… 5206+ ä¸ªä¾èµ–åŒ…
- `rollup-plugin-postcss@4.0.2` å·²æ­£ç¡®å®‰è£…

### 3. Builderä»£ç ä¼˜åŒ– âœ“
- **BaseStrategy.ts**: åªåœ¨æœ‰é¢„å¤„ç†å™¨æ—¶ä¼ é€’ `use`
- **TypeScriptStrategy.ts**: æ·»åŠ  `config: false` ç¦ç”¨é…ç½®æŸ¥æ‰¾
- **EnhancedRollupAdapter.ts**: ä¼˜åŒ–é¢„å¤„ç†å™¨æ£€æµ‹
- Builder æˆåŠŸæ„å»º

### 4. æ–‡æ¡£å®Œå–„ âœ“
- åˆ›å»ºäº†å®Œæ•´çš„é—®é¢˜åˆ†ææ–‡æ¡£
- æä¾›äº†å¤šä¸ªè§£å†³æ–¹æ¡ˆ
- ç¼–å†™äº†å¿«é€Ÿå¯åŠ¨æŒ‡å—

---

## âŒ æœªè§£å†³çš„é—®é¢˜

### rollup-plugin-postcss@4.0.2 çš„ alwaysProcess Bug

**ç—‡çŠ¶**:
```
TypeError: Cannot read properties of undefined (reading 'alwaysProcess')
at rollup-plugin-postcss/dist/index.js:734:20
```

**æ ¹æœ¬åŸå› **:  
è¿™æ˜¯ `rollup-plugin-postcss@4.0.2` å†…éƒ¨çš„ bugï¼Œæ— æ³•é€šè¿‡é…ç½®ä¿®å¤ã€‚

**å·²å°è¯•çš„æ‰€æœ‰ä¿®å¤**ï¼ˆå‡å¤±è´¥ï¼‰:
1. âŒ ä¸ä¼  `use` é€‰é¡¹
2. âŒ ä¼ é€’ç©ºæ•°ç»„ `use: []`
3. âŒ ä¼ é€’ `null` å€¼
4. âŒ æ·»åŠ  `config: false`
5. âŒ åªåœ¨æ£€æµ‹åˆ°é¢„å¤„ç†å™¨æ—¶ä¼  `use`
6. âŒ ä¼˜åŒ– EnhancedRollupAdapter é…ç½®
7. âŒ å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå·²æ˜¯æœ€æ–°ï¼‰
8. âŒ é™çº§åˆ° 3.1.8ï¼ˆæ— æ³•å®‰è£…ï¼‰

**ç»“è®º**: é—®é¢˜å‡ºåœ¨æ’ä»¶æºç æœ¬èº«ï¼Œéœ€è¦æ›´æ¢æ’ä»¶æˆ–ç»•è¿‡CSSå¤„ç†

---

## ğŸ¯ æ¨èè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ B: ä½¿ç”¨ rollup-plugin-stylesï¼ˆå¼ºçƒˆæ¨èï¼‰â­â­â­

`rollup-plugin-styles` æ˜¯æ›´ç°ä»£ã€æ›´ç¨³å®šçš„æ›¿ä»£å“ã€‚

#### æ­¥éª¤ï¼š

1. **å®‰è£…æ’ä»¶**
```bash
cd D:\WorkBench\ldesign\tools\builder
pnpm add rollup-plugin-styles
```

2. **ä¿®æ”¹ TypeScriptStrategy.ts**
```typescript
// æ›¿æ¢ rollup-plugin-postcss å¯¼å…¥
const styles = await import('rollup-plugin-styles')
return styles.default({
  mode: 'extract',
  minimize: config.mode === 'production',
  sourceMap: config.output?.sourcemap !== false,
  modules: config.style?.modules || false
})
```

3. **ä¿®æ”¹ EnhancedRollupAdapter.ts**  
åŒæ ·çš„æ›¿æ¢é€»è¾‘

4. **æ„å»ºå¹¶æµ‹è¯•**
```bash
cd D:\WorkBench\ldesign\tools\builder
pnpm build

cd D:\WorkBench\ldesign\libraries\editor\packages\core
pnpm build
```

---

### æ–¹æ¡ˆ C: ä¸´æ—¶è·³è¿‡CSSï¼ŒéªŒè¯ä»£ç ï¼ˆå¿«é€Ÿï¼‰â­â­

å¦‚æœä½ åªæƒ³å¿«é€ŸéªŒè¯TypeScriptä»£ç èƒ½å¦ç¼–è¯‘ï¼š

1. **æ³¨é‡ŠCSSå¯¼å…¥**
```typescript
// D:\WorkBench\ldesign\libraries\editor\packages\core\src\index.ts
// import './styles/editor.css'
// import './styles/themes/default.css'
```

2. **æ„å»º**
```bash
cd D:\WorkBench\ldesign\libraries\editor\packages\core
pnpm build
```

3. **éªŒè¯TypeScripté”™è¯¯**  
è™½ç„¶æœ‰623ä¸ªTSé”™è¯¯ï¼Œä½†å¯ä»¥ç¡®è®¤æ„å»ºç³»ç»Ÿæœ¬èº«æ˜¯å¦å·¥ä½œ

---

### æ–¹æ¡ˆ D: å•ç‹¬å¤„ç†CSSæ–‡ä»¶ â­

ä½¿ç”¨ä¸“é—¨çš„CSSå·¥å…·ï¼š

```bash
# 1. å®‰è£… postcss-cli
cd D:\WorkBench\ldesign\libraries\editor\packages\core
pnpm add -D postcss-cli

# 2. æ·»åŠ æ„å»ºè„šæœ¬
# package.json
{
  "scripts": {
    "build:css": "postcss src/styles/**/*.css --dir dist/styles",
    "build": "pnpm build:css && ldesign-builder build"
  }
}

# 3. ä»index.tsä¸­ç§»é™¤CSSå¯¼å…¥
```

---

## ğŸ“Š æŠ€æœ¯åˆ†æ

### rollup-plugin-postcss@4.0.2 æºç é—®é¢˜

**é—®é¢˜ä»£ç ** (dist/index.js:734):
```javascript
const loader = this.getLoader(name);
// loader å¯èƒ½æ˜¯ undefined
if (loader.alwaysProcess || matchFile(loaderContext.id, loader.test)) {
  // ğŸ’¥ å´©æºƒï¼šundefined.alwaysProcess
}
```

**è§¦å‘æ¡ä»¶**:
1. å½“ `use` æ•°ç»„ä¸­çš„ loader åç§°åœ¨ `this.loaders` ä¸­æ‰¾ä¸åˆ°æ—¶
2. `getLoader(name)` è¿”å› `undefined`
3. è®¿é—® `undefined.alwaysProcess` å¯¼è‡´å´©æºƒ

**ä¸ºä»€ä¹ˆä¼šæ‰¾ä¸åˆ°**:
- é»˜è®¤æ³¨å†Œçš„ loaders: `postcss`, `sass`, `stylus`, `less`
- å¦‚æœé…ç½®ä¸å½“ï¼ŒæŸä¸ª loader å¯èƒ½æœªæ­£ç¡®åˆå§‹åŒ–
- æˆ–è€… loader åç§°ä¸åŒ¹é…

---

## ğŸ’¡ ç«‹å³è¡ŒåŠ¨

æˆ‘å»ºè®®ä½ ï¼š

### é€‰é¡¹ 1: ä½¿ç”¨ rollup-plugin-stylesï¼ˆ30åˆ†é’Ÿï¼‰

è¿™æ˜¯æœ€å¹²å‡€çš„è§£å†³æ–¹æ¡ˆï¼Œä¸€åŠ³æ°¸é€¸ã€‚

### é€‰é¡¹ 2: ä¸´æ—¶è·³è¿‡CSSï¼ˆ5åˆ†é’Ÿï¼‰

å¿«é€ŸéªŒè¯å…¶ä»–ä»£ç ï¼Œç„¶åå†³å®šé•¿æœŸæ–¹æ¡ˆã€‚

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [PostCSS_é—®é¢˜æ€»ç»“.md](./PostCSS_é—®é¢˜æ€»ç»“.md) - è¯¦ç»†æŠ€æœ¯åˆ†æ
- [æ–¹æ¡ˆAæ‰§è¡Œç»“æœ.md](./æ–¹æ¡ˆAæ‰§è¡Œç»“æœ.md) - æ–¹æ¡ˆAçš„å®Œæ•´è®°å½•
- [åˆå§‹åŒ–ç»“æœ.md](./åˆå§‹åŒ–ç»“æœ.md) - åˆå§‹ç¯å¢ƒçŠ¶æ€

---

## ğŸ”„ ä¸‹ä¸€æ­¥

**ç«‹å³æ‰§è¡Œ**ï¼ˆé€‰æ‹©ä¸€ä¸ªï¼‰:

```powershell
# æ–¹æ¡ˆB - åˆ‡æ¢åˆ° rollup-plugin-styles
cd D:\WorkBench\ldesign\tools\builder
pnpm add rollup-plugin-styles
# ç„¶åä¿®æ”¹ä»£ç ï¼ˆæˆ‘å¯ä»¥å¸®ä½ ï¼‰

# æˆ–

# æ–¹æ¡ˆC - ä¸´æ—¶è·³è¿‡CSS
cd D:\WorkBench\ldesign\libraries\editor\packages\core\src
# æ³¨é‡Š index.ts ä¸­çš„CSSå¯¼å…¥
pnpm build
```

---

**å‘Šè¯‰æˆ‘ä½ æƒ³å°è¯•å“ªä¸ªæ–¹æ¡ˆï¼Œæˆ‘ä¼šç«‹å³å¸®ä½ æ‰§è¡Œï¼** ğŸš€
