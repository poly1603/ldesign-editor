{"version":3,"file":"VirtualScroller.cjs","sources":["../../src/core/VirtualScroller.ts"],"sourcesContent":["/**\r\n * 虚拟滚动器 - 支持超大文档的高性能滚动\r\n *\r\n * 特性：\r\n * - 支持10万+行文档流畅滚动\r\n * - 只渲染可视区域内容\r\n * - 动态回收和复用DOM节点\r\n * - 平滑滚动和快速跳转\r\n */\r\n\r\nimport { throttle } from '../utils/helpers'\r\nimport { EventEmitter } from './EventEmitter'\r\n\r\nexport interface VirtualScrollerOptions {\r\n  /** 容器元素 */\r\n  container: HTMLElement\r\n  /** 单个项目的高度（固定高度模式） */\r\n  itemHeight?: number\r\n  /** 缓冲区大小（可视区域外额外渲染的项目数） */\r\n  bufferSize?: number\r\n  /** 是否启用动态高度 */\r\n  dynamicHeight?: boolean\r\n  /** 滚动事件节流延迟（ms） */\r\n  scrollThrottle?: number\r\n  /** 是否启用平滑滚动 */\r\n  smoothScroll?: boolean\r\n  /** 最大缓存节点数 */\r\n  maxCachedNodes?: number\r\n  /** 自定义渲染器 */\r\n  renderer?: (item: any, index: number) => HTMLElement\r\n}\r\n\r\nexport interface VirtualScrollerItem {\r\n  id: string | number\r\n  data: any\r\n  height?: number\r\n  element?: HTMLElement\r\n}\r\n\r\ninterface ScrollMetrics {\r\n  scrollTop: number\r\n  scrollHeight: number\r\n  containerHeight: number\r\n  visibleStart: number\r\n  visibleEnd: number\r\n  renderStart: number\r\n  renderEnd: number\r\n}\r\n\r\nexport class VirtualScroller extends EventEmitter {\r\n  private container: HTMLElement\r\n  private viewport: HTMLElement\r\n  private content: HTMLElement\r\n  private items: VirtualScrollerItem[] = []\r\n  private itemHeights: Map<string | number, number> = new Map()\r\n  private nodePool: HTMLElement[] = []\r\n  private renderedItems: Map<string | number, HTMLElement> = new Map()\r\n  private metrics: ScrollMetrics\r\n  private options: Required<VirtualScrollerOptions>\r\n  private scrollHandler: () => void\r\n  private resizeObserver: ResizeObserver\r\n  private intersectionObserver: IntersectionObserver\r\n  private isScrolling = false\r\n  private scrollTimeout: any\r\n  private measurementCache: Map<string, number> = new Map()\r\n\r\n  constructor(options: VirtualScrollerOptions) {\r\n    super()\r\n\r\n    this.options = {\r\n      itemHeight: 50,\r\n      bufferSize: 5,\r\n      dynamicHeight: false,\r\n      scrollThrottle: 16,\r\n      smoothScroll: true,\r\n      maxCachedNodes: 100,\r\n      renderer: this.defaultRenderer.bind(this),\r\n      ...options,\r\n    }\r\n\r\n    this.container = options.container\r\n    this.setupDOM()\r\n    this.setupEventListeners()\r\n    this.setupObservers()\r\n\r\n    this.metrics = this.calculateMetrics()\r\n    this.scrollHandler = throttle(() => this.handleScroll(), this.options.scrollThrottle)\r\n  }\r\n\r\n  /**\r\n   * 设置要渲染的项目列表\r\n   */\r\n  setItems(items: VirtualScrollerItem[]): void {\r\n    this.items = items\r\n    this.updateContentHeight()\r\n    this.render()\r\n  }\r\n\r\n  /**\r\n   * 添加项目\r\n   */\r\n  addItems(items: VirtualScrollerItem[], index?: number): void {\r\n    if (index !== undefined)\r\n      this.items.splice(index, 0, ...items)\r\n    else\r\n      this.items.push(...items)\r\n\r\n    this.updateContentHeight()\r\n    this.render()\r\n  }\r\n\r\n  /**\r\n   * 移除项目\r\n   */\r\n  removeItems(ids: (string | number)[]): void {\r\n    const idSet = new Set(ids)\r\n    this.items = this.items.filter(item => !idSet.has(item.id))\r\n\r\n    // 清理缓存\r\n    ids.forEach((id) => {\r\n      this.itemHeights.delete(id)\r\n      const element = this.renderedItems.get(id)\r\n      if (element) {\r\n        this.recycleNode(element)\r\n        this.renderedItems.delete(id)\r\n      }\r\n    })\r\n\r\n    this.updateContentHeight()\r\n    this.render()\r\n  }\r\n\r\n  /**\r\n   * 滚动到指定位置\r\n   */\r\n  scrollTo(position: number, smooth = true): void {\r\n    this.viewport.scrollTo({\r\n      top: position,\r\n      behavior: smooth && this.options.smoothScroll ? 'smooth' : 'auto',\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 滚动到指定项目\r\n   */\r\n  scrollToItem(id: string | number, position: 'start' | 'center' | 'end' = 'start'): void {\r\n    const index = this.items.findIndex(item => item.id === id)\r\n    if (index === -1)\r\n      return\r\n\r\n    const offset = this.calculateItemOffset(index)\r\n    let scrollPosition = offset\r\n\r\n    if (position === 'center')\r\n      scrollPosition = offset - this.metrics.containerHeight / 2 + this.getItemHeight(index) / 2\r\n    else if (position === 'end')\r\n      scrollPosition = offset + this.getItemHeight(index) - this.metrics.containerHeight\r\n\r\n    this.scrollTo(scrollPosition)\r\n  }\r\n\r\n  /**\r\n   * 获取当前可见的项目\r\n   */\r\n  getVisibleItems(): VirtualScrollerItem[] {\r\n    const { visibleStart, visibleEnd } = this.metrics\r\n    return this.items.slice(visibleStart, visibleEnd + 1)\r\n  }\r\n\r\n  /**\r\n   * 刷新指定项目\r\n   */\r\n  refreshItem(id: string | number): void {\r\n    const element = this.renderedItems.get(id)\r\n    if (!element)\r\n      return\r\n\r\n    const item = this.items.find(i => i.id === id)\r\n    if (!item)\r\n      return\r\n\r\n    const newElement = this.options.renderer(item.data, this.items.indexOf(item))\r\n    element.replaceWith(newElement)\r\n    this.renderedItems.set(id, newElement)\r\n  }\r\n\r\n  /**\r\n   * 销毁虚拟滚动器\r\n   */\r\n  destroy(): void {\r\n    this.viewport.removeEventListener('scroll', this.scrollHandler)\r\n    this.resizeObserver.disconnect()\r\n    this.intersectionObserver.disconnect()\r\n    this.nodePool = []\r\n    this.renderedItems.clear()\r\n    this.itemHeights.clear()\r\n    this.measurementCache.clear()\r\n  }\r\n\r\n  private setupDOM(): void {\r\n    // 创建视口容器\r\n    this.viewport = document.createElement('div')\r\n    this.viewport.className = 'virtual-scroller-viewport'\r\n    this.viewport.style.cssText = `\r\n      height: 100%;\r\n      overflow-y: auto;\r\n      position: relative;\r\n    `\r\n\r\n    // 创建内容容器\r\n    this.content = document.createElement('div')\r\n    this.content.className = 'virtual-scroller-content'\r\n    this.content.style.cssText = `\r\n      position: relative;\r\n      width: 100%;\r\n    `\r\n\r\n    this.viewport.appendChild(this.content)\r\n    this.container.appendChild(this.viewport)\r\n  }\r\n\r\n  private setupEventListeners(): void {\r\n    this.viewport.addEventListener('scroll', this.scrollHandler)\r\n  }\r\n\r\n  private setupObservers(): void {\r\n    // 监听容器大小变化\r\n    this.resizeObserver = new ResizeObserver((entries) => {\r\n      this.metrics = this.calculateMetrics()\r\n      this.render()\r\n    })\r\n    this.resizeObserver.observe(this.viewport)\r\n\r\n    // 监听项目可见性（用于动态高度测量）\r\n    if (this.options.dynamicHeight) {\r\n      this.intersectionObserver = new IntersectionObserver(\r\n        (entries) => {\r\n          entries.forEach((entry) => {\r\n            if (entry.isIntersecting)\r\n              this.measureItem(entry.target as HTMLElement)\r\n          })\r\n        },\r\n        { root: this.viewport },\r\n      )\r\n    }\r\n  }\r\n\r\n  private handleScroll(): void {\r\n    this.isScrolling = true\r\n    clearTimeout(this.scrollTimeout)\r\n\r\n    this.metrics = this.calculateMetrics()\r\n    this.render()\r\n\r\n    this.scrollTimeout = setTimeout(() => {\r\n      this.isScrolling = false\r\n      this.emit('scrollEnd', this.metrics)\r\n    }, 150)\r\n\r\n    this.emit('scroll', this.metrics)\r\n  }\r\n\r\n  private calculateMetrics(): ScrollMetrics {\r\n    const scrollTop = this.viewport.scrollTop\r\n    const containerHeight = this.viewport.clientHeight\r\n    const scrollHeight = this.content.scrollHeight\r\n\r\n    // 计算可见区域\r\n    const visibleStart = this.findStartIndex(scrollTop)\r\n    const visibleEnd = this.findEndIndex(scrollTop + containerHeight)\r\n\r\n    // 计算渲染区域（包含缓冲区）\r\n    const renderStart = Math.max(0, visibleStart - this.options.bufferSize)\r\n    const renderEnd = Math.min(this.items.length - 1, visibleEnd + this.options.bufferSize)\r\n\r\n    return {\r\n      scrollTop,\r\n      scrollHeight,\r\n      containerHeight,\r\n      visibleStart,\r\n      visibleEnd,\r\n      renderStart,\r\n      renderEnd,\r\n    }\r\n  }\r\n\r\n  private findStartIndex(scrollTop: number): number {\r\n    if (this.options.dynamicHeight) {\r\n      let accumulatedHeight = 0\r\n      for (let i = 0; i < this.items.length; i++) {\r\n        if (accumulatedHeight >= scrollTop)\r\n          return i\r\n        accumulatedHeight += this.getItemHeight(i)\r\n      }\r\n      return this.items.length - 1\r\n    }\r\n    else {\r\n      return Math.floor(scrollTop / this.options.itemHeight)\r\n    }\r\n  }\r\n\r\n  private findEndIndex(scrollBottom: number): number {\r\n    if (this.options.dynamicHeight) {\r\n      let accumulatedHeight = 0\r\n      for (let i = 0; i < this.items.length; i++) {\r\n        accumulatedHeight += this.getItemHeight(i)\r\n        if (accumulatedHeight >= scrollBottom)\r\n          return i\r\n      }\r\n      return this.items.length - 1\r\n    }\r\n    else {\r\n      return Math.ceil(scrollBottom / this.options.itemHeight)\r\n    }\r\n  }\r\n\r\n  private getItemHeight(index: number): number {\r\n    const item = this.items[index]\r\n    if (!item)\r\n      return this.options.itemHeight\r\n\r\n    if (this.options.dynamicHeight) {\r\n      // 优先使用缓存的高度\r\n      if (this.itemHeights.has(item.id))\r\n        return this.itemHeights.get(item.id)!\r\n\r\n      // 使用预设高度或默认高度\r\n      return item.height || this.options.itemHeight\r\n    }\r\n\r\n    return this.options.itemHeight\r\n  }\r\n\r\n  private calculateItemOffset(index: number): number {\r\n    if (this.options.dynamicHeight) {\r\n      let offset = 0\r\n      for (let i = 0; i < index; i++)\r\n        offset += this.getItemHeight(i)\r\n\r\n      return offset\r\n    }\r\n    else {\r\n      return index * this.options.itemHeight\r\n    }\r\n  }\r\n\r\n  private updateContentHeight(): void {\r\n    let totalHeight: number\r\n\r\n    if (this.options.dynamicHeight) {\r\n      totalHeight = 0\r\n      for (let i = 0; i < this.items.length; i++)\r\n        totalHeight += this.getItemHeight(i)\r\n    }\r\n    else {\r\n      totalHeight = this.items.length * this.options.itemHeight\r\n    }\r\n\r\n    this.content.style.height = `${totalHeight}px`\r\n  }\r\n\r\n  private render(): void {\r\n    const { renderStart, renderEnd } = this.metrics\r\n    const fragment = document.createDocumentFragment()\r\n    const renderedIds = new Set<string | number>()\r\n\r\n    // 移除不在渲染范围内的元素\r\n    this.renderedItems.forEach((element, id) => {\r\n      const index = this.items.findIndex(item => item.id === id)\r\n      if (index < renderStart || index > renderEnd) {\r\n        this.recycleNode(element)\r\n        this.renderedItems.delete(id)\r\n      }\r\n    })\r\n\r\n    // 渲染可见项目\r\n    for (let i = renderStart; i <= renderEnd; i++) {\r\n      const item = this.items[i]\r\n      if (!item)\r\n        continue\r\n\r\n      renderedIds.add(item.id)\r\n\r\n      // 如果已经渲染，跳过\r\n      if (this.renderedItems.has(item.id))\r\n        continue\r\n\r\n      // 获取或创建元素\r\n      const element = this.getOrCreateNode()\r\n      const renderedElement = this.options.renderer(item.data, i)\r\n\r\n      // 复制渲染的内容到池化的元素\r\n      element.innerHTML = renderedElement.innerHTML\r\n      element.className = renderedElement.className\r\n      element.setAttribute('data-index', String(i))\r\n      element.setAttribute('data-id', String(item.id))\r\n\r\n      // 设置位置\r\n      const offset = this.calculateItemOffset(i)\r\n      element.style.position = 'absolute'\r\n      element.style.top = `${offset}px`\r\n      element.style.left = '0'\r\n      element.style.right = '0'\r\n\r\n      // 动态高度监听\r\n      if (this.options.dynamicHeight && this.intersectionObserver)\r\n        this.intersectionObserver.observe(element)\r\n\r\n      fragment.appendChild(element)\r\n      this.renderedItems.set(item.id, element)\r\n    }\r\n\r\n    // 批量添加到DOM\r\n    if (fragment.childNodes.length > 0)\r\n      this.content.appendChild(fragment)\r\n  }\r\n\r\n  private getOrCreateNode(): HTMLElement {\r\n    if (this.nodePool.length > 0)\r\n      return this.nodePool.pop()!\r\n\r\n    const element = document.createElement('div')\r\n    element.className = 'virtual-scroller-item'\r\n    return element\r\n  }\r\n\r\n  private recycleNode(element: HTMLElement): void {\r\n    if (this.nodePool.length < this.options.maxCachedNodes) {\r\n      element.remove()\r\n      element.innerHTML = ''\r\n      element.style.cssText = ''\r\n      element.className = 'virtual-scroller-item'\r\n      this.nodePool.push(element)\r\n    }\r\n    else {\r\n      element.remove()\r\n    }\r\n  }\r\n\r\n  private measureItem(element: HTMLElement): void {\r\n    const id = element.getAttribute('data-id')\r\n    if (!id)\r\n      return\r\n\r\n    const height = element.offsetHeight\r\n    const previousHeight = this.itemHeights.get(id) || this.options.itemHeight\r\n\r\n    if (height !== previousHeight) {\r\n      this.itemHeights.set(id, height)\r\n      this.updateContentHeight()\r\n\r\n      // 如果高度变化较大，可能需要重新渲染\r\n      if (Math.abs(height - previousHeight) > 10)\r\n        this.render()\r\n    }\r\n  }\r\n\r\n  private defaultRenderer(data: any, index: number): HTMLElement {\r\n    const element = document.createElement('div')\r\n    element.textContent = `Item ${index}: ${JSON.stringify(data)}`\r\n    return element\r\n  }\r\n\r\n  /**\r\n   * 获取性能指标\r\n   */\r\n  getPerformanceMetrics() {\r\n    return {\r\n      totalItems: this.items.length,\r\n      renderedItems: this.renderedItems.size,\r\n      cachedNodes: this.nodePool.length,\r\n      memoryUsage: this.estimateMemoryUsage(),\r\n    }\r\n  }\r\n\r\n  private estimateMemoryUsage(): number {\r\n    // 估算内存使用（字节）\r\n    const itemMemory = this.renderedItems.size * 1024 // 假设每个渲染项1KB\r\n    const cacheMemory = this.nodePool.length * 512 // 假设每个缓存节点512B\r\n    const heightCacheMemory = this.itemHeights.size * 16 // 每个高度缓存16B\r\n\r\n    return itemMemory + cacheMemory + heightCacheMemory\r\n  }\r\n}\r\n"],"names":["VirtualScroller","EventEmitter","constructor","options","items","itemHeights","Map","nodePool","renderedItems","isScrolling","measurementCache","itemHeight","bufferSize","dynamicHeight","scrollThrottle","smoothScroll","maxCachedNodes","renderer","defaultRenderer","bind","container","setupDOM","setupEventListeners","setupObservers","metrics","calculateMetrics","scrollHandler","throttle","handleScroll","setItems","updateContentHeight","render","addItems","index","undefined","splice","push","removeItems","ids","idSet","Set","filter","item","has","id","forEach","delete","element","get","recycleNode","scrollTo","position","smooth","viewport","top","behavior","scrollToItem","findIndex","offset","calculateItemOffset","scrollPosition","containerHeight","getItemHeight","getVisibleItems","visibleStart","visibleEnd","slice","refreshItem","find","i","newElement","data","indexOf","replaceWith","set","destroy","removeEventListener","resizeObserver","disconnect","intersectionObserver","clear","document","createElement","className","style","cssText","content","appendChild","addEventListener","ResizeObserver","entries","observe","IntersectionObserver","entry","isIntersecting","measureItem","target","root","clearTimeout","scrollTimeout","setTimeout","emit","scrollTop","clientHeight","scrollHeight","findStartIndex","findEndIndex","renderStart","Math","max","renderEnd","min","length","accumulatedHeight","floor","scrollBottom","ceil","height","totalHeight","fragment","createDocumentFragment","renderedIds","add","getOrCreateNode","renderedElement","innerHTML","setAttribute","String","left","right","childNodes","pop","remove","getAttribute","offsetHeight","previousHeight","abs","textContent","JSON","stringify","getPerformanceMetrics","totalItems","size","cachedNodes","memoryUsage","estimateMemoryUsage","itemMemory","cacheMemory","heightCacheMemory"],"mappings":"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"}