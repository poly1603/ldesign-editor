{"version":3,"file":"Document.cjs","sources":["../../src/core/Document.ts"],"sourcesContent":["/**\r\n * Document - 文档模型\r\n * 管理文档内容和结构\r\n */\r\n\r\nimport type { Node } from '../types'\r\nimport type { Schema } from './Schema'\r\nimport { defaultSchema } from './Schema'\r\n\r\nexport class Document {\r\n  public root: Node\r\n  public schema: Schema\r\n\r\n  constructor(content?: Node | string, schema: Schema = defaultSchema) {\r\n    this.schema = schema\r\n\r\n    if (typeof content === 'string') {\r\n      this.root = this.fromHTML(content)\r\n    }\r\n    else if (content) {\r\n      this.root = content\r\n    }\r\n    else {\r\n      // 默认创建空文档\r\n      this.root = {\r\n        type: 'doc',\r\n        content: [{ type: 'paragraph', content: [] }],\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 从 HTML 解析文档\r\n   */\r\n  fromHTML(html: string): Node {\r\n    const parser = new DOMParser()\r\n    const doc = parser.parseFromString(html, 'text/html')\r\n    return this.parseDOM(doc.body)\r\n  }\r\n\r\n  /**\r\n   * 转换为 HTML\r\n   */\r\n  toHTML(): string {\r\n    return this.nodeToHTML(this.root)\r\n  }\r\n\r\n  /**\r\n   * 转换为 JSON\r\n   */\r\n  toJSON(): Node {\r\n    return JSON.parse(JSON.stringify(this.root))\r\n  }\r\n\r\n  /**\r\n   * 转换为纯文本\r\n   */\r\n  toText(): string {\r\n    return this.nodeToText(this.root)\r\n  }\r\n\r\n  /**\r\n   * 从 JSON 创建文档\r\n   */\r\n  static fromJSON(json: Node, schema?: Schema): Document {\r\n    return new Document(json, schema)\r\n  }\r\n\r\n  /**\r\n   * 解析 DOM 节点\r\n   */\r\n  private parseDOM(dom: HTMLElement): Node {\r\n    const children: Node[] = []\r\n\r\n    // 遍历子节点\r\n    for (let i = 0; i < dom.childNodes.length; i++) {\r\n      const child = dom.childNodes[i]\r\n\r\n      if (child.nodeType === Node.TEXT_NODE) {\r\n        const text = child.textContent || ''\r\n        if (text.trim()) {\r\n          children.push({\r\n            type: 'text',\r\n            text,\r\n          })\r\n        }\r\n      }\r\n      else if (child.nodeType === Node.ELEMENT_NODE) {\r\n        const element = child as HTMLElement\r\n        const node = this.parseElement(element)\r\n        if (node)\r\n          children.push(node)\r\n      }\r\n    }\r\n\r\n    // 如果是根节点\r\n    if (dom.tagName === 'BODY' || !dom.tagName) {\r\n      return {\r\n        type: 'doc',\r\n        content: children.length > 0 ? children : [{ type: 'paragraph', content: [] }],\r\n      }\r\n    }\r\n\r\n    return {\r\n      type: 'paragraph',\r\n      content: children,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 解析元素节点\r\n   */\r\n  private parseElement(element: HTMLElement): Node | null {\r\n    const tagName = element.tagName.toLowerCase()\r\n\r\n    // 段落\r\n    if (tagName === 'p') {\r\n      return {\r\n        type: 'paragraph',\r\n        content: this.parseInlineContent(element),\r\n      }\r\n    }\r\n\r\n    // 标题\r\n    if (/^h[1-6]$/.test(tagName)) {\r\n      return {\r\n        type: 'heading',\r\n        attrs: { level: Number.parseInt(tagName[1]) },\r\n        content: this.parseInlineContent(element),\r\n      }\r\n    }\r\n\r\n    // 引用\r\n    if (tagName === 'blockquote') {\r\n      return {\r\n        type: 'blockquote',\r\n        content: Array.from(element.children).map(child =>\r\n          this.parseElement(child as HTMLElement),\r\n        ).filter(Boolean) as Node[],\r\n      }\r\n    }\r\n\r\n    // 代码块\r\n    if (tagName === 'pre') {\r\n      const code = element.querySelector('code')\r\n      return {\r\n        type: 'codeBlock',\r\n        content: [{\r\n          type: 'text',\r\n          text: (code || element).textContent || '',\r\n        }],\r\n      }\r\n    }\r\n\r\n    // 水平线\r\n    if (tagName === 'hr')\r\n      return { type: 'horizontalRule' }\r\n\r\n    // 列表\r\n    if (tagName === 'ul') {\r\n      return {\r\n        type: 'bulletList',\r\n        content: Array.from(element.children)\r\n          .filter(child => child.tagName.toLowerCase() === 'li')\r\n          .map(child => ({\r\n            type: 'listItem' as const,\r\n            content: [this.parseDOM(child as HTMLElement)],\r\n          })),\r\n      }\r\n    }\r\n\r\n    if (tagName === 'ol') {\r\n      return {\r\n        type: 'orderedList',\r\n        attrs: { start: Number.parseInt(element.getAttribute('start') || '1') },\r\n        content: Array.from(element.children)\r\n          .filter(child => child.tagName.toLowerCase() === 'li')\r\n          .map(child => ({\r\n            type: 'listItem' as const,\r\n            content: [this.parseDOM(child as HTMLElement)],\r\n          })),\r\n      }\r\n    }\r\n\r\n    // 图片\r\n    if (tagName === 'img') {\r\n      return {\r\n        type: 'image',\r\n        attrs: {\r\n          src: element.getAttribute('src'),\r\n          alt: element.getAttribute('alt'),\r\n          title: element.getAttribute('title'),\r\n        },\r\n      }\r\n    }\r\n\r\n    // 视频\r\n    if (tagName === 'video') {\r\n      // 优先从 <source> 子节点读取 src/type\r\n      let src = element.getAttribute('src')\r\n      let type = element.getAttribute('type')\r\n      const source = element.querySelector('source')\r\n      if (source) {\r\n        src = src || source.getAttribute('src') || undefined as any\r\n        type = type || source.getAttribute('type') || undefined as any\r\n      }\r\n      return {\r\n        type: 'video',\r\n        attrs: {\r\n          src,\r\n          type,\r\n          controls: element.hasAttribute('controls') ? true : undefined,\r\n        },\r\n      }\r\n    }\r\n\r\n    // 音频\r\n    if (tagName === 'audio') {\r\n      let src = element.getAttribute('src')\r\n      let type = element.getAttribute('type')\r\n      const source = element.querySelector('source')\r\n      if (source) {\r\n        src = src || source.getAttribute('src') || undefined as any\r\n        type = type || source.getAttribute('type') || undefined as any\r\n      }\r\n      return {\r\n        type: 'audio',\r\n        attrs: {\r\n          src,\r\n          type,\r\n          controls: element.hasAttribute('controls') ? true : undefined,\r\n        },\r\n      }\r\n    }\r\n\r\n    // 表格 - 保留原始 HTML\r\n    if (tagName === 'table') {\r\n      return {\r\n        type: 'table',\r\n        attrs: {\r\n          html: element.outerHTML,\r\n        },\r\n      }\r\n    }\r\n\r\n    // 忽略表格内部元素（它们会被表格整体处理）\r\n    if (tagName === 'thead' || tagName === 'tbody' || tagName === 'tr' || tagName === 'th' || tagName === 'td')\r\n      return null\r\n\r\n    // 默认作为段落处理\r\n    return {\r\n      type: 'paragraph',\r\n      content: this.parseInlineContent(element),\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 解析内联内容\r\n   */\r\n  private parseInlineContent(element: HTMLElement): Node[] {\r\n    const nodes: Node[] = []\r\n\r\n    const parseNode = (node: ChildNode, marks: any[] = []): void => {\r\n      if (node.nodeType === Node.TEXT_NODE) {\r\n        const text = node.textContent || ''\r\n        if (text) {\r\n          nodes.push({\r\n            type: 'text',\r\n            text,\r\n            marks: marks.length > 0 ? marks : undefined,\r\n          })\r\n        }\r\n      }\r\n      else if (node.nodeType === Node.ELEMENT_NODE) {\r\n        const el = node as HTMLElement\r\n        const tag = el.tagName.toLowerCase()\r\n        const newMarks = [...marks]\r\n\r\n        // 解析标记\r\n        if (tag === 'strong' || tag === 'b') {\r\n          newMarks.push({ type: 'bold' })\r\n        }\r\n        else if (tag === 'em' || tag === 'i') {\r\n          newMarks.push({ type: 'italic' })\r\n        }\r\n        else if (tag === 'u') {\r\n          newMarks.push({ type: 'underline' })\r\n        }\r\n        else if (tag === 's' || tag === 'strike') {\r\n          newMarks.push({ type: 'strike' })\r\n        }\r\n        else if (tag === 'code') {\r\n          newMarks.push({ type: 'code' })\r\n        }\r\n        else if (tag === 'a') {\r\n          newMarks.push({\r\n            type: 'link',\r\n            attrs: {\r\n              href: el.getAttribute('href'),\r\n              title: el.getAttribute('title'),\r\n            },\r\n          })\r\n        }\r\n        else if (tag === 'img') {\r\n          nodes.push({\r\n            type: 'image',\r\n            attrs: {\r\n              src: el.getAttribute('src'),\r\n              alt: el.getAttribute('alt'),\r\n              title: el.getAttribute('title'),\r\n            },\r\n          })\r\n          return\r\n        }\r\n\r\n        // 递归处理子节点\r\n        el.childNodes.forEach(child => parseNode(child, newMarks))\r\n      }\r\n    }\r\n\r\n    element.childNodes.forEach(node => parseNode(node))\r\n    return nodes\r\n  }\r\n\r\n  /**\r\n   * 节点转 HTML\r\n   */\r\n  private nodeToHTML(node: Node): string {\r\n    if (node.type === 'text') {\r\n      let html = this.escapeHTML(node.text || '')\r\n\r\n      // 应用标记\r\n      if (node.marks) {\r\n        node.marks.forEach((mark) => {\r\n          html = this.wrapMark(html, mark)\r\n        })\r\n      }\r\n\r\n      return html\r\n    }\r\n\r\n    // 获取子内容\r\n    const content = node.content?.map(child => this.nodeToHTML(child)).join('') || ''\r\n\r\n    // 根据节点类型生成 HTML\r\n    switch (node.type) {\r\n      case 'doc':\r\n        return content\r\n      case 'paragraph':\r\n        return `<p>${content}</p>`\r\n      case 'heading':\r\n        return `<h${node.attrs?.level || 1}>${content}</h${node.attrs?.level || 1}>`\r\n      case 'blockquote':\r\n        return `<blockquote>${content}</blockquote>`\r\n      case 'codeBlock':\r\n        return `<pre><code>${content}</code></pre>`\r\n      case 'horizontalRule':\r\n        return '<hr>'\r\n      case 'bulletList':\r\n        return `<ul>${content}</ul>`\r\n      case 'orderedList':\r\n        return `<ol start=\"${node.attrs?.start || 1}\">${content}</ol>`\r\n      case 'listItem':\r\n        return `<li>${content}</li>`\r\n      case 'image':\r\n        return `<img src=\"${node.attrs?.src || ''}\" alt=\"${node.attrs?.alt || ''}\" ${node.attrs?.title ? `title=\\\"${node.attrs.title}\\\"` : ''}>`\r\n      case 'video': {\r\n        const src = node.attrs?.src || ''\r\n        const type = node.attrs?.type ? ` type=\\\"${node.attrs.type}\\\"` : ''\r\n        const controls = node.attrs?.controls === false ? '' : ' controls'\r\n        // 使用 video[src] 简化生成，保证样式匹配\r\n        return `<video${controls} src=\"${src}\"${type} style=\"max-width: 100%; height: auto; display: block; margin: 10px auto;\"></video>`\r\n      }\r\n      case 'audio': {\r\n        const src = node.attrs?.src || ''\r\n        const type = node.attrs?.type ? ` type=\\\"${node.attrs.type}\\\"` : ''\r\n        const controls = node.attrs?.controls === false ? '' : ' controls'\r\n        return `<audio${controls} src=\"${src}\"${type} style=\"width: 100%; max-width: 400px; display: block; margin: 10px auto;\"></audio>`\r\n      }\r\n      case 'table':\r\n        // 直接返回原始的表格 HTML\r\n        return node.attrs?.html || '<table></table>'\r\n      default:\r\n        return content\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 包装标记\r\n   */\r\n  private wrapMark(html: string, mark: any): string {\r\n    switch (mark.type) {\r\n      case 'bold':\r\n        return `<strong>${html}</strong>`\r\n      case 'italic':\r\n        return `<em>${html}</em>`\r\n      case 'underline':\r\n        return `<u>${html}</u>`\r\n      case 'strike':\r\n        return `<s>${html}</s>`\r\n      case 'code':\r\n        return `<code>${html}</code>`\r\n      case 'link':\r\n        return `<a href=\"${mark.attrs?.href || ''}\" ${mark.attrs?.title ? `title=\"${mark.attrs.title}\"` : ''}>${html}</a>`\r\n      default:\r\n        return html\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 转义 HTML\r\n   */\r\n  private escapeHTML(text: string): string {\r\n    const div = document.createElement('div')\r\n    div.textContent = text\r\n    return div.innerHTML\r\n  }\r\n\r\n  /**\r\n   * 节点转纯文本\r\n   */\r\n  private nodeToText(node: Node): string {\r\n    if (node.type === 'text')\r\n      return node.text || ''\r\n\r\n    // 处理特殊节点\r\n    switch (node.type) {\r\n      case 'horizontalRule':\r\n        return '---\\n'\r\n      case 'image':\r\n        return `[图片: ${node.attrs?.alt || node.attrs?.src || ''}]\\n`\r\n      case 'video':\r\n        return `[视频: ${node.attrs?.src || ''}]\\n`\r\n      case 'audio':\r\n        return `[音频: ${node.attrs?.src || ''}]\\n`\r\n      case 'table':\r\n        return '[表格]\\n'\r\n    }\r\n\r\n    // 获取子内容\r\n    let content = ''\r\n    if (node.content)\r\n      content = node.content.map(child => this.nodeToText(child)).join('')\r\n\r\n    // 添加块级元素的换行\r\n    switch (node.type) {\r\n      case 'paragraph':\r\n      case 'heading':\r\n      case 'blockquote':\r\n      case 'codeBlock':\r\n      case 'listItem':\r\n        return `${content}\\n`\r\n      case 'bulletList':\r\n      case 'orderedList':\r\n        return `${content}\\n`\r\n      default:\r\n        return content\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取文档大小\r\n   */\r\n  get size(): number {\r\n    return this.getNodeSize(this.root)\r\n  }\r\n\r\n  /**\r\n   * 计算节点大小\r\n   */\r\n  private getNodeSize(node: Node): number {\r\n    if (node.type === 'text')\r\n      return node.text?.length || 0\r\n\r\n    let size = 1 // 节点开始\r\n    if (node.content) {\r\n      node.content.forEach((child) => {\r\n        size += this.getNodeSize(child)\r\n      })\r\n    }\r\n    size += 1 // 节点结束\r\n\r\n    return size\r\n  }\r\n}\r\n"],"names":["Document","constructor","content","schema","defaultSchema","root","fromHTML","type","html","parser","DOMParser","doc","parseFromString","parseDOM","body","toHTML","nodeToHTML","toJSON","JSON","parse","stringify","toText","nodeToText","fromJSON","json","dom","children","i","childNodes","length","child","nodeType","Node","TEXT_NODE","text","textContent","trim","push","ELEMENT_NODE","element","node","parseElement","tagName","toLowerCase","parseInlineContent","test","attrs","level","Number","parseInt","Array","from","map","filter","Boolean","code","querySelector","start","getAttribute","src","alt","title","source","undefined","controls","hasAttribute","outerHTML","nodes","parseNode","marks","el","tag","newMarks","href","forEach","escapeHTML","mark","wrapMark","join","div","document","createElement","innerHTML","size","getNodeSize"],"mappings":"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"}