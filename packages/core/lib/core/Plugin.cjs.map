{"version":3,"file":"Plugin.cjs","sources":["../../src/core/Plugin.ts"],"sourcesContent":["/**\r\n * Plugin - 插件基类\r\n * 提供插件系统的基础功能\r\n */\r\n\r\nimport type { EditorInstance, PluginConfig, Plugin as PluginType } from '../types'\r\n\r\n/**\r\n * 插件基类\r\n * 所有插件都应该继承此类\r\n *\r\n * @example\r\n * ```typescript\r\n * class MyPlugin extends Plugin {\r\n *   name = 'my-plugin'\r\n *   config: PluginConfig = {\r\n *     name: 'my-plugin',\r\n *     commands: {\r\n *       myCommand: (state) => true\r\n *     }\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport abstract class Plugin implements PluginType {\r\n  /** 插件名称（必须唯一） */\r\n  public abstract name: string\r\n\r\n  /** 插件配置 */\r\n  public abstract config: PluginConfig\r\n\r\n  /** 编辑器实例引用 */\r\n  protected editor?: EditorInstance\r\n\r\n  /**\r\n   * 安装插件\r\n   * @param editor - 编辑器实例\r\n   */\r\n  install(editor: EditorInstance): void {\r\n    this.editor = editor\r\n\r\n    // 注册命令\r\n    if (this.config.commands) {\r\n      Object.entries(this.config.commands).forEach(([name, command]) => {\r\n        editor.commands.register(name, command)\r\n      })\r\n    }\r\n\r\n    // 注册快捷键\r\n    if (this.config.keys) {\r\n      Object.entries(this.config.keys).forEach(([keys, command]) => {\r\n        editor.keymap.register(keys, command)\r\n      })\r\n    }\r\n\r\n    // 合并 Schema\r\n    if (this.config.schema && 'extendSchema' in editor)\r\n      (editor as EditorInstance & { extendSchema: (schema: unknown) => void }).extendSchema(this.config.schema)\r\n\r\n    // 调用自定义初始化\r\n    this.onInstall?.(editor)\r\n  }\r\n\r\n  /**\r\n   * 销毁插件\r\n   * 清理插件注册的所有资源\r\n   */\r\n  destroy(): void {\r\n    if (!this.editor)\r\n      return\r\n\r\n    // 移除命令\r\n    if (this.config.commands) {\r\n      Object.keys(this.config.commands).forEach((name) => {\r\n        this.editor!.commands.unregister(name)\r\n      })\r\n    }\r\n\r\n    // 移除快捷键\r\n    if (this.config.keys) {\r\n      Object.keys(this.config.keys).forEach((keys) => {\r\n        this.editor!.keymap.unregister(keys)\r\n      })\r\n    }\r\n\r\n    // 调用自定义清理\r\n    this.onDestroy?.(this.editor)\r\n\r\n    // 清除编辑器引用\r\n    this.editor = undefined\r\n  }\r\n\r\n  /**\r\n   * 插件安装时的钩子\r\n   * 子类可以重写此方法来添加自定义初始化逻辑\r\n   *\r\n   * @param editor - 编辑器实例\r\n   */\r\n  protected onInstall?(editor: EditorInstance): void\r\n\r\n  /**\r\n   * 插件销毁时的钩子\r\n   * 子类可以重写此方法来添加自定义清理逻辑\r\n   *\r\n   * @param editor - 编辑器实例\r\n   */\r\n  protected onDestroy?(editor: EditorInstance): void\r\n}\r\n\r\n/**\r\n * 插件管理器\r\n * 管理编辑器中的所有插件\r\n *\r\n * @example\r\n * ```typescript\r\n * const manager = new PluginManager(editor)\r\n * manager.register(new MyPlugin())\r\n * manager.get('my-plugin')\r\n * ```\r\n */\r\nexport class PluginManager {\r\n  private plugins: Map<string, PluginType> = new Map()\r\n  private editor: EditorInstance\r\n\r\n  constructor(editor: EditorInstance) {\r\n    this.editor = editor\r\n  }\r\n\r\n  /**\r\n   * 注册插件\r\n   * @param plugin - 要注册的插件实例\r\n   */\r\n  register(plugin: PluginType): void {\r\n    if (this.plugins.has(plugin.name)) {\r\n      if (process.env.NODE_ENV !== 'production')\r\n        console.warn(`[PluginManager] Plugin \"${plugin.name}\" is already registered`)\r\n\r\n      return\r\n    }\r\n\r\n    this.plugins.set(plugin.name, plugin)\r\n\r\n    if (plugin.install) {\r\n      try {\r\n        plugin.install(this.editor)\r\n        if (process.env.NODE_ENV !== 'production')\r\n          console.log(`[PluginManager] Plugin \"${plugin.name}\" installed successfully`)\r\n      }\r\n      catch (error) {\r\n        console.error(`[PluginManager] Failed to install plugin \"${plugin.name}\":`, error)\r\n        this.plugins.delete(plugin.name)\r\n        throw error\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取插件实例\r\n   * @param name - 插件名称\r\n   * @returns 插件实例，如果不存在则返回undefined\r\n   */\r\n  get(name: string): PluginType | undefined {\r\n    return this.plugins.get(name)\r\n  }\r\n\r\n  /**\r\n   * 注销插件\r\n   * @param name - 插件名称\r\n   */\r\n  unregister(name: string): void {\r\n    const plugin = this.plugins.get(name)\r\n    if (plugin) {\r\n      try {\r\n        plugin.destroy?.()\r\n      }\r\n      catch (error) {\r\n        console.error(`[PluginManager] Error destroying plugin \"${name}\":`, error)\r\n      }\r\n      this.plugins.delete(name)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取所有插件\r\n   * @returns 所有插件实例的数组\r\n   */\r\n  getAll(): PluginType[] {\r\n    return Array.from(this.plugins.values())\r\n  }\r\n\r\n  /**\r\n   * 检查插件是否已注册\r\n   * @param name - 插件名称\r\n   * @returns 如果插件已注册返回true，否则返回false\r\n   */\r\n  has(name: string): boolean {\r\n    return this.plugins.has(name)\r\n  }\r\n\r\n  /**\r\n   * 清除所有插件\r\n   * 销毁并移除所有已注册的插件\r\n   */\r\n  clear(): void {\r\n    this.plugins.forEach((plugin, name) => {\r\n      try {\r\n        plugin.destroy?.()\r\n      }\r\n      catch (error) {\r\n        console.error(`[PluginManager] Error destroying plugin \"${name}\":`, error)\r\n      }\r\n    })\r\n    this.plugins.clear()\r\n  }\r\n}\r\n\r\n/**\r\n * 创建插件辅助函数\r\n * 快速创建一个简单的插件，无需继承Plugin类\r\n *\r\n * @param config - 插件配置\r\n * @returns 插件实例\r\n *\r\n * @example\r\n * ```typescript\r\n * const myPlugin = createPlugin({\r\n *   name: 'my-plugin',\r\n *   commands: {\r\n *     myCommand: (state) => {\r\n *       console.log('Command executed')\r\n *       return true\r\n *     }\r\n *   },\r\n *   init: (editor) => {\r\n *     console.log('Plugin initialized')\r\n *   }\r\n * })\r\n * ```\r\n */\r\nexport function createPlugin(config: PluginConfig): PluginType {\r\n  return {\r\n    name: config.name,\r\n    config,\r\n    install(editor: EditorInstance) {\r\n      if (process.env.NODE_ENV !== 'production')\r\n        console.log(`[createPlugin] Installing plugin: ${config.name}`)\r\n\r\n      // 注册命令\r\n      if (config.commands) {\r\n        Object.entries(config.commands).forEach(([name, command]) => {\r\n          editor.commands.register(name, command)\r\n          if (process.env.NODE_ENV !== 'production')\r\n            console.log(`[createPlugin] Command \"${name}\" registered for plugin: ${config.name}`)\r\n        })\r\n      }\r\n\r\n      // 注册快捷键\r\n      if (config.keys) {\r\n        Object.entries(config.keys).forEach(([keys, command]) => {\r\n          editor.keymap.register(keys, command)\r\n        })\r\n      }\r\n\r\n      // 合并 Schema\r\n      if (config.schema && 'extendSchema' in editor)\r\n        (editor as EditorInstance & { extendSchema: (schema: unknown) => void }).extendSchema(config.schema)\r\n\r\n      // 调用 init 钩子\r\n      if (config.init) {\r\n        const result = config.init(editor)\r\n        if (result instanceof Promise) {\r\n          result.catch((error) => {\r\n            console.error(`[createPlugin] Error in init hook for plugin \"${config.name}\":`, error)\r\n          })\r\n        }\r\n      }\r\n    },\r\n    destroy() {\r\n      // 调用 destroy 钩子\r\n      if (config.destroy) {\r\n        const result = config.destroy()\r\n        if (result instanceof Promise) {\r\n          result.catch((error) => {\r\n            console.error(`[createPlugin] Error in destroy hook for plugin \"${config.name}\":`, error)\r\n          })\r\n        }\r\n      }\r\n    },\r\n  }\r\n}\r\n"],"names":["Plugin","install","editor","config","commands","Object","entries","forEach","name","command","register","keys","keymap","schema","extendSchema","onInstall","destroy","unregister","onDestroy","undefined","PluginManager","constructor","plugins","Map","plugin","has","process","env","NODE_ENV","console","warn","set","log","error","delete","get","getAll","Array","from","values","clear","createPlugin","init","result","Promise","catch"],"mappings":"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"}