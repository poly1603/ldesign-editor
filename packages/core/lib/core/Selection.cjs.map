{"version":3,"file":"Selection.cjs","sources":["../../src/core/Selection.ts"],"sourcesContent":["/**\r\n * Selection - 选区管理\r\n * 处理光标和选中内容\r\n */\r\n\r\nimport type { Range, Selection as SelectionType } from '../types'\r\n\r\nexport class Selection {\r\n  public anchor: number\r\n  public head: number\r\n\r\n  constructor(anchor: number, head?: number) {\r\n    this.anchor = anchor\r\n    this.head = head !== undefined ? head : anchor\r\n  }\r\n\r\n  /**\r\n   * 是否为空选区（光标）\r\n   */\r\n  get empty(): boolean {\r\n    return this.anchor === this.head\r\n  }\r\n\r\n  /**\r\n   * 选区起始位置\r\n   */\r\n  get from(): number {\r\n    return Math.min(this.anchor, this.head)\r\n  }\r\n\r\n  /**\r\n   * 选区结束位置\r\n   */\r\n  get to(): number {\r\n    return Math.max(this.anchor, this.head)\r\n  }\r\n\r\n  /**\r\n   * 获取范围\r\n   */\r\n  get range(): Range {\r\n    return {\r\n      from: this.from,\r\n      to: this.to,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 转换为类型\r\n   */\r\n  toJSON(): SelectionType {\r\n    return {\r\n      anchor: this.anchor,\r\n      head: this.head,\r\n      empty: this.empty,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 从类型创建\r\n   */\r\n  static fromJSON(json: SelectionType): Selection {\r\n    return new Selection(json.anchor, json.head)\r\n  }\r\n\r\n  /**\r\n   * 创建空选区（光标）\r\n   */\r\n  static cursor(pos: number): Selection {\r\n    return new Selection(pos, pos)\r\n  }\r\n\r\n  /**\r\n   * 创建范围选区\r\n   */\r\n  static range(from: number, to: number): Selection {\r\n    return new Selection(from, to)\r\n  }\r\n\r\n  /**\r\n   * 比较两个选区是否相等\r\n   */\r\n  equals(other: Selection): boolean {\r\n    return this.anchor === other.anchor && this.head === other.head\r\n  }\r\n\r\n  /**\r\n   * 克隆选区\r\n   */\r\n  clone(): Selection {\r\n    return new Selection(this.anchor, this.head)\r\n  }\r\n}\r\n\r\n/**\r\n * 选区管理器\r\n * 管理 DOM 选区和编辑器选区的同步\r\n */\r\nexport class SelectionManager {\r\n  private editor: any\r\n  private selection: Selection\r\n\r\n  constructor(editor: any) {\r\n    this.editor = editor\r\n    this.selection = Selection.cursor(0)\r\n  }\r\n\r\n  /**\r\n   * 获取当前选区\r\n   */\r\n  getSelection(): Selection {\r\n    return this.selection\r\n  }\r\n\r\n  /**\r\n   * 设置选区\r\n   */\r\n  setSelection(selection: Selection): void {\r\n    this.selection = selection\r\n    this.syncToDOM()\r\n  }\r\n\r\n  /**\r\n   * 从 DOM 同步选区\r\n   */\r\n  syncFromDOM(): void {\r\n    const domSelection = window.getSelection()\r\n    if (!domSelection || domSelection.rangeCount === 0)\r\n      return\r\n\r\n    const range = domSelection.getRangeAt(0)\r\n    const anchor = this.domPositionToEditorPosition(range.startContainer, range.startOffset)\r\n    const head = this.domPositionToEditorPosition(range.endContainer, range.endOffset)\r\n\r\n    this.selection = new Selection(anchor, head)\r\n  }\r\n\r\n  /**\r\n   * 同步到 DOM\r\n   */\r\n  syncToDOM(): void {\r\n    const domSelection = window.getSelection()\r\n    if (!domSelection)\r\n      return\r\n\r\n    const range = this.editorRangeToDOMRange(this.selection.range)\r\n    if (range) {\r\n      domSelection.removeAllRanges()\r\n      domSelection.addRange(range)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * DOM 位置转编辑器位置\r\n   */\r\n  private domPositionToEditorPosition(node: Node, offset: number): number {\r\n    // 简化实现，实际需要遍历 DOM 树计算位置\r\n    return offset\r\n  }\r\n\r\n  /**\r\n   * 编辑器范围转 DOM 范围\r\n   */\r\n  private editorRangeToDOMRange(range: Range): Range | null {\r\n    // 简化实现，实际需要将编辑器位置转换为 DOM 位置\r\n    return null\r\n  }\r\n\r\n  /**\r\n   * 清除选区\r\n   */\r\n  clear(): void {\r\n    this.selection = Selection.cursor(0)\r\n    window.getSelection()?.removeAllRanges()\r\n  }\r\n}\r\n"],"names":["Selection","constructor","anchor","head","undefined","empty","from","Math","min","to","max","range","toJSON","fromJSON","json","cursor","pos","equals","other","clone","SelectionManager","editor","selection","getSelection","setSelection","syncToDOM","syncFromDOM","domSelection","window","rangeCount","getRangeAt","domPositionToEditorPosition","startContainer","startOffset","endContainer","endOffset","editorRangeToDOMRange","removeAllRanges","addRange","node","offset","clear"],"mappings":"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"}