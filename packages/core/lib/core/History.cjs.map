{"version":3,"file":"History.cjs","sources":["../../src/core/History.ts"],"sourcesContent":["/**\r\n * 历史记录管理（撤销/重做）\r\n */\r\n\r\nimport type { Editor } from './Editor'\r\nimport { EDITOR_CONFIG } from '../config/constants'\r\nimport { createLogger } from '../utils/logger'\r\n\r\nconst logger = createLogger('History')\r\n\r\n/**\r\n * 历史记录状态\r\n */\r\nexport interface HistoryState {\r\n  /** HTML 内容 */\r\n  html: string\r\n\r\n  /** 选区信息 */\r\n  selection: {\r\n    start: number\r\n    end: number\r\n  } | null\r\n\r\n  /** 时间戳 */\r\n  timestamp: number\r\n}\r\n\r\n/**\r\n * 历史记录管理类\r\n */\r\nexport class History {\r\n  private editor: Editor\r\n  private undoStack: HistoryState[] = []\r\n  private redoStack: HistoryState[] = []\r\n  private maxStackSize: number\r\n  private isUndoing: boolean = false\r\n  private isRedoing: boolean = false\r\n  private isSaving: boolean = false\r\n  private lastSavedState: string = ''\r\n  private saveTimeout: number | null = null\r\n\r\n  constructor(editor: Editor, maxStackSize?: number) {\r\n    this.editor = editor\r\n    this.maxStackSize = maxStackSize || EDITOR_CONFIG.MAX_HISTORY_SIZE\r\n    this.init()\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  private init(): void {\r\n    // 保存初始状态\r\n    this.saveState()\r\n\r\n    // 监听内容变化\r\n    this.editor.on('update', () => {\r\n      if (!this.isUndoing && !this.isRedoing && !this.isSaving)\r\n        this.debouncedSave()\r\n    })\r\n\r\n    logger.debug('History initialized')\r\n  }\r\n\r\n  /**\r\n   * 防抖保存（避免频繁保存）\r\n   */\r\n  private debouncedSave(): void {\r\n    if (this.saveTimeout !== null)\r\n      clearTimeout(this.saveTimeout)\r\n\r\n    this.saveTimeout = window.setTimeout(() => {\r\n      this.saveState()\r\n      this.saveTimeout = null\r\n    }, EDITOR_CONFIG.DEBOUNCE_DELAY)\r\n  }\r\n\r\n  /**\r\n   * 保存当前状态\r\n   */\r\n  saveState(): void {\r\n    this.isSaving = true\r\n\r\n    try {\r\n      const html = this.editor.getHTML()\r\n\r\n      // 如果内容没变化，不保存\r\n      if (html === this.lastSavedState)\r\n        return\r\n\r\n      const state: HistoryState = {\r\n        html,\r\n        selection: this.getCurrentSelection(),\r\n        timestamp: Date.now(),\r\n      }\r\n\r\n      this.undoStack.push(state)\r\n      this.lastSavedState = html\r\n\r\n      // 限制栈大小\r\n      if (this.undoStack.length > this.maxStackSize)\r\n        this.undoStack.shift()\r\n\r\n      // 清空重做栈\r\n      this.redoStack = []\r\n\r\n      logger.debug('State saved', { stackSize: this.undoStack.length })\r\n    }\r\n    finally {\r\n      this.isSaving = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 撤销\r\n   */\r\n  undo(): boolean {\r\n    if (this.undoStack.length <= 1) {\r\n      logger.debug('Cannot undo: no more history')\r\n      return false\r\n    }\r\n\r\n    this.isUndoing = true\r\n\r\n    try {\r\n      // 将当前状态移到重做栈\r\n      const currentState = this.undoStack.pop()!\r\n      this.redoStack.push(currentState)\r\n\r\n      // 恢复上一个状态\r\n      const previousState = this.undoStack[this.undoStack.length - 1]\r\n      this.restoreState(previousState)\r\n\r\n      logger.debug('Undo successful', {\r\n        undoStackSize: this.undoStack.length,\r\n        redoStackSize: this.redoStack.length,\r\n      })\r\n\r\n      return true\r\n    }\r\n    finally {\r\n      this.isUndoing = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 重做\r\n   */\r\n  redo(): boolean {\r\n    if (this.redoStack.length === 0) {\r\n      logger.debug('Cannot redo: no redo history')\r\n      return false\r\n    }\r\n\r\n    this.isRedoing = true\r\n\r\n    try {\r\n      // 从重做栈取出状态\r\n      const state = this.redoStack.pop()!\r\n      this.undoStack.push(state)\r\n\r\n      // 恢复状态\r\n      this.restoreState(state)\r\n\r\n      logger.debug('Redo successful', {\r\n        undoStackSize: this.undoStack.length,\r\n        redoStackSize: this.redoStack.length,\r\n      })\r\n\r\n      return true\r\n    }\r\n    finally {\r\n      this.isRedoing = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 恢复状态\r\n   */\r\n  private restoreState(state: HistoryState): void {\r\n    // 恢复内容\r\n    this.editor.setHTML(state.html)\r\n    this.lastSavedState = state.html\r\n\r\n    // 延迟恢复选区（等待 DOM 更新）\r\n    setTimeout(() => {\r\n      if (state.selection)\r\n        this.restoreSelection(state.selection)\r\n    }, 0)\r\n  }\r\n\r\n  /**\r\n   * 获取当前选区\r\n   */\r\n  private getCurrentSelection(): { start: number, end: number } | null {\r\n    if (!this.editor.contentElement)\r\n      return null\r\n\r\n    const selection = window.getSelection()\r\n    if (!selection || selection.rangeCount === 0)\r\n      return null\r\n\r\n    const range = selection.getRangeAt(0)\r\n\r\n    try {\r\n      return {\r\n        start: this.getOffset(this.editor.contentElement, range.startContainer, range.startOffset),\r\n        end: this.getOffset(this.editor.contentElement, range.endContainer, range.endOffset),\r\n      }\r\n    }\r\n    catch (e) {\r\n      logger.warn('Failed to get selection', e)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 恢复选区\r\n   */\r\n  private restoreSelection(selection: { start: number, end: number }): void {\r\n    if (!this.editor.contentElement)\r\n      return\r\n\r\n    try {\r\n      const range = this.createRangeFromOffsets(\r\n        this.editor.contentElement,\r\n        selection.start,\r\n        selection.end,\r\n      )\r\n\r\n      if (range) {\r\n        const sel = window.getSelection()\r\n        sel?.removeAllRanges()\r\n        sel?.addRange(range)\r\n        logger.debug('Selection restored')\r\n      }\r\n    }\r\n    catch (e) {\r\n      logger.warn('Failed to restore selection', e)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取节点在编辑器中的偏移量\r\n   */\r\n  private getOffset(root: Node, node: Node, offset: number): number {\r\n    const walker = document.createTreeWalker(\r\n      root,\r\n      NodeFilter.SHOW_TEXT,\r\n      null,\r\n    )\r\n\r\n    let totalOffset = 0\r\n    let currentNode: Node | null\r\n\r\n    while ((currentNode = walker.nextNode())) {\r\n      if (currentNode === node)\r\n        return totalOffset + offset\r\n\r\n      totalOffset += currentNode.textContent?.length || 0\r\n    }\r\n\r\n    return totalOffset\r\n  }\r\n\r\n  /**\r\n   * 从偏移量创建 Range\r\n   */\r\n  private createRangeFromOffsets(root: Node, start: number, end: number): Range | null {\r\n    const walker = document.createTreeWalker(\r\n      root,\r\n      NodeFilter.SHOW_TEXT,\r\n      null,\r\n    )\r\n\r\n    let currentOffset = 0\r\n    let startNode: Node | null = null\r\n    let startOffset = 0\r\n    let endNode: Node | null = null\r\n    let endOffset = 0\r\n    let currentNode: Node | null\r\n\r\n    while ((currentNode = walker.nextNode())) {\r\n      const nodeLength = currentNode.textContent?.length || 0\r\n\r\n      if (!startNode && currentOffset + nodeLength >= start) {\r\n        startNode = currentNode\r\n        startOffset = start - currentOffset\r\n      }\r\n\r\n      if (!endNode && currentOffset + nodeLength >= end) {\r\n        endNode = currentNode\r\n        endOffset = end - currentOffset\r\n        break\r\n      }\r\n\r\n      currentOffset += nodeLength\r\n    }\r\n\r\n    if (startNode && endNode) {\r\n      const range = document.createRange()\r\n      range.setStart(startNode, Math.min(startOffset, startNode.textContent?.length || 0))\r\n      range.setEnd(endNode, Math.min(endOffset, endNode.textContent?.length || 0))\r\n      return range\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  /**\r\n   * 清空历史\r\n   */\r\n  clear(): void {\r\n    this.undoStack = []\r\n    this.redoStack = []\r\n    this.lastSavedState = ''\r\n    logger.debug('History cleared')\r\n  }\r\n\r\n  /**\r\n   * 检查是否可以撤销\r\n   */\r\n  canUndo(): boolean {\r\n    return this.undoStack.length > 1\r\n  }\r\n\r\n  /**\r\n   * 检查是否可以重做\r\n   */\r\n  canRedo(): boolean {\r\n    return this.redoStack.length > 0\r\n  }\r\n\r\n  /**\r\n   * 获取历史记录信息\r\n   */\r\n  getInfo(): {\r\n    undoCount: number\r\n    redoCount: number\r\n    canUndo: boolean\r\n    canRedo: boolean\r\n  } {\r\n    return {\r\n      undoCount: this.undoStack.length,\r\n      redoCount: this.redoStack.length,\r\n      canUndo: this.canUndo(),\r\n      canRedo: this.canRedo(),\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   */\r\n  destroy(): void {\r\n    if (this.saveTimeout !== null) {\r\n      clearTimeout(this.saveTimeout)\r\n      this.saveTimeout = null\r\n    }\r\n    this.clear()\r\n    logger.debug('History destroyed')\r\n  }\r\n}\r\n"],"names":["logger","createLogger","History","constructor","editor","maxStackSize","undoStack","redoStack","isUndoing","isRedoing","isSaving","lastSavedState","saveTimeout","EDITOR_CONFIG","MAX_HISTORY_SIZE","init","saveState","on","debouncedSave","debug","clearTimeout","window","setTimeout","DEBOUNCE_DELAY","html","getHTML","state","selection","getCurrentSelection","timestamp","Date","now","push","length","shift","stackSize","undo","currentState","pop","previousState","restoreState","undoStackSize","redoStackSize","redo","setHTML","restoreSelection","contentElement","getSelection","rangeCount","range","getRangeAt","start","getOffset","startContainer","startOffset","end","endContainer","endOffset","e","warn","createRangeFromOffsets","sel","removeAllRanges","addRange","root","node","offset","walker","document","createTreeWalker","NodeFilter","SHOW_TEXT","totalOffset","currentNode","nextNode","textContent","currentOffset","startNode","endNode","nodeLength","createRange","setStart","Math","min","setEnd","clear","canUndo","canRedo","getInfo","undoCount","redoCount","destroy"],"mappings":"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"}