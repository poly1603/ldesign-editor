{"version":3,"file":"LocalTemplateStorage.cjs","sources":["../../../src/template/storage/LocalTemplateStorage.ts"],"sourcesContent":["/**\r\n * 本地存储模板适配器\r\n * 使用 localStorage 存储自定义模板\r\n */\r\n\r\nimport type { Template, TemplateCategory, TemplateStorage } from '../types'\r\n\r\nexport class LocalTemplateStorage implements TemplateStorage {\r\n  private readonly STORAGE_KEY = 'editor_templates'\r\n  private readonly MAX_STORAGE_SIZE = 5 * 1024 * 1024 // 5MB limit\r\n\r\n  /**\r\n   * 获取所有模板\r\n   */\r\n  async getAll(): Promise<Template[]> {\r\n    try {\r\n      const data = localStorage.getItem(this.STORAGE_KEY)\r\n      if (!data)\r\n        return []\r\n\r\n      const templates = JSON.parse(data)\r\n      // 转换日期字符串为Date对象\r\n      return templates.map((t: any) => ({\r\n        ...t,\r\n        metadata: {\r\n          ...t.metadata,\r\n          createdAt: t.metadata.createdAt ? new Date(t.metadata.createdAt) : undefined,\r\n          updatedAt: t.metadata.updatedAt ? new Date(t.metadata.updatedAt) : undefined,\r\n        },\r\n      }))\r\n    }\r\n    catch (error) {\r\n      console.error('Failed to load templates from localStorage:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 根据ID获取模板\r\n   */\r\n  async getById(id: string): Promise<Template | null> {\r\n    const templates = await this.getAll()\r\n    return templates.find(t => t.metadata.id === id) || null\r\n  }\r\n\r\n  /**\r\n   * 根据分类获取模板\r\n   */\r\n  async getByCategory(category: TemplateCategory): Promise<Template[]> {\r\n    const templates = await this.getAll()\r\n    return templates.filter(t => t.metadata.category === category)\r\n  }\r\n\r\n  /**\r\n   * 保存模板\r\n   */\r\n  async save(template: Template): Promise<void> {\r\n    const templates = await this.getAll()\r\n\r\n    // 检查是否已存在\r\n    const existingIndex = templates.findIndex(t => t.metadata.id === template.metadata.id)\r\n    if (existingIndex >= 0)\r\n      templates[existingIndex] = template\r\n    else\r\n      templates.push(template)\r\n\r\n    await this.saveAll(templates)\r\n  }\r\n\r\n  /**\r\n   * 更新模板\r\n   */\r\n  async update(id: string, template: Partial<Template>): Promise<void> {\r\n    const templates = await this.getAll()\r\n    const index = templates.findIndex(t => t.metadata.id === id)\r\n\r\n    if (index === -1)\r\n      throw new Error(`Template with id ${id} not found`)\r\n\r\n    templates[index] = {\r\n      ...templates[index],\r\n      ...template,\r\n      metadata: {\r\n        ...templates[index].metadata,\r\n        ...template.metadata,\r\n      },\r\n    }\r\n\r\n    await this.saveAll(templates)\r\n  }\r\n\r\n  /**\r\n   * 删除模板\r\n   */\r\n  async delete(id: string): Promise<void> {\r\n    const templates = await this.getAll()\r\n    const filtered = templates.filter(t => t.metadata.id !== id)\r\n\r\n    if (filtered.length === templates.length)\r\n      throw new Error(`Template with id ${id} not found`)\r\n\r\n    await this.saveAll(filtered)\r\n  }\r\n\r\n  /**\r\n   * 搜索模板\r\n   */\r\n  async search(query: string): Promise<Template[]> {\r\n    const templates = await this.getAll()\r\n    const lowerQuery = query.toLowerCase()\r\n\r\n    return templates.filter((template) => {\r\n      const metadata = template.metadata\r\n      return (\r\n        metadata.name.toLowerCase().includes(lowerQuery)\r\n        || metadata.description?.toLowerCase().includes(lowerQuery)\r\n        || metadata.tags?.some(tag => tag.toLowerCase().includes(lowerQuery))\r\n      )\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 保存所有模板到存储\r\n   */\r\n  private async saveAll(templates: Template[]): Promise<void> {\r\n    try {\r\n      const data = JSON.stringify(templates)\r\n\r\n      // 检查存储大小\r\n      if (data.length > this.MAX_STORAGE_SIZE)\r\n        throw new Error('Templates data exceeds maximum storage size (5MB)')\r\n\r\n      localStorage.setItem(this.STORAGE_KEY, data)\r\n    }\r\n    catch (error) {\r\n      if (error instanceof DOMException && error.name === 'QuotaExceededError')\r\n        throw new Error('Local storage quota exceeded. Please delete some templates.')\r\n\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 清空所有模板\r\n   */\r\n  async clear(): Promise<void> {\r\n    localStorage.removeItem(this.STORAGE_KEY)\r\n  }\r\n\r\n  /**\r\n   * 获取存储使用情况\r\n   */\r\n  async getStorageInfo(): Promise<{\r\n    used: number\r\n    limit: number\r\n    percentage: number\r\n  }> {\r\n    const data = localStorage.getItem(this.STORAGE_KEY) || ''\r\n    const used = new Blob([data]).size\r\n\r\n    return {\r\n      used,\r\n      limit: this.MAX_STORAGE_SIZE,\r\n      percentage: (used / this.MAX_STORAGE_SIZE) * 100,\r\n    }\r\n  }\r\n}\r\n"],"names":["LocalTemplateStorage","STORAGE_KEY","MAX_STORAGE_SIZE","getAll","data","localStorage","getItem","templates","JSON","parse","map","t","metadata","createdAt","Date","undefined","updatedAt","error","console","getById","id","find","getByCategory","category","filter","save","template","existingIndex","findIndex","push","saveAll","update","index","Error","delete","filtered","length","search","query","lowerQuery","toLowerCase","name","includes","description","tags","some","tag","stringify","setItem","DOMException","clear","removeItem","getStorageInfo","used","Blob","size","limit","percentage"],"mappings":"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"}