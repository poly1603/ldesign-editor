{"version":3,"file":"CRDT.cjs","sources":["../../../src/collaboration/crdt/CRDT.ts"],"sourcesContent":["/**\r\n * CRDT (Conflict-free Replicated Data Type) 核心实现\r\n * 基于Logoot算法的无冲突复制数据类型\r\n */\r\n\r\nimport type { CRDTOperation, CRDTState, Identifier, Position } from './types'\r\nimport { createLogger } from '../../utils/logger'\r\n\r\nconst logger = createLogger('CRDT')\r\n\r\nexport class CRDT {\r\n  /** 站点ID（唯一标识此客户端） */\r\n  private siteId: string\r\n\r\n  /** 逻辑时钟 */\r\n  private clock = 0\r\n\r\n  /** 文档状态（位置 -> 字符） */\r\n  private state = new Map<string, { char: string, id: Identifier, visible: boolean }>()\r\n\r\n  /** 操作历史 */\r\n  private history: CRDTOperation[] = []\r\n\r\n  /** 版本向量（站点ID -> 时钟值） */\r\n  private versionVector = new Map<string, number>()\r\n\r\n  constructor(siteId?: string) {\r\n    this.siteId = siteId || this.generateSiteId()\r\n    this.versionVector.set(this.siteId, 0)\r\n    logger.info(`CRDT initialized with site ID: ${this.siteId}`)\r\n  }\r\n\r\n  /**\r\n   * 生成站点ID\r\n   */\r\n  private generateSiteId(): string {\r\n    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`\r\n  }\r\n\r\n  /**\r\n   * 插入字符\r\n   */\r\n  insert(index: number, char: string): CRDTOperation {\r\n    this.clock++\r\n    this.versionVector.set(this.siteId, this.clock)\r\n\r\n    // 生成位置标识符\r\n    const position = this.generatePosition(index)\r\n    const identifier: Identifier = {\r\n      position,\r\n      siteId: this.siteId,\r\n      clock: this.clock,\r\n    }\r\n\r\n    // 创建操作\r\n    const operation: CRDTOperation = {\r\n      type: 'insert',\r\n      identifier,\r\n      char,\r\n      siteId: this.siteId,\r\n      clock: this.clock,\r\n      timestamp: Date.now(),\r\n    }\r\n\r\n    // 应用操作\r\n    this.applyOperation(operation)\r\n\r\n    // 记录历史\r\n    this.history.push(operation)\r\n\r\n    logger.debug(`Insert: ${char} at position ${index}`)\r\n\r\n    return operation\r\n  }\r\n\r\n  /**\r\n   * 删除字符\r\n   */\r\n  delete(index: number): CRDTOperation | null {\r\n    const items = this.getVisibleItems()\r\n    if (index < 0 || index >= items.length) {\r\n      logger.warn(`Invalid delete index: ${index}`)\r\n      return null\r\n    }\r\n\r\n    this.clock++\r\n    this.versionVector.set(this.siteId, this.clock)\r\n\r\n    const item = items[index]\r\n\r\n    // 创建删除操作\r\n    const operation: CRDTOperation = {\r\n      type: 'delete',\r\n      identifier: item.id,\r\n      siteId: this.siteId,\r\n      clock: this.clock,\r\n      timestamp: Date.now(),\r\n    }\r\n\r\n    // 应用操作\r\n    this.applyOperation(operation)\r\n\r\n    // 记录历史\r\n    this.history.push(operation)\r\n\r\n    logger.debug(`Delete at index ${index}`)\r\n\r\n    return operation\r\n  }\r\n\r\n  /**\r\n   * 应用操作\r\n   */\r\n  applyOperation(operation: CRDTOperation): void {\r\n    const key = this.identifierToKey(operation.identifier)\r\n\r\n    switch (operation.type) {\r\n      case 'insert':\r\n        this.state.set(key, {\r\n          char: operation.char!,\r\n          id: operation.identifier,\r\n          visible: true,\r\n        })\r\n        break\r\n\r\n      case 'delete':\r\n        const item = this.state.get(key)\r\n        if (item)\r\n          item.visible = false\r\n\r\n        break\r\n    }\r\n\r\n    // 更新版本向量\r\n    const remoteClock = this.versionVector.get(operation.siteId) || 0\r\n    if (operation.clock > remoteClock)\r\n      this.versionVector.set(operation.siteId, operation.clock)\r\n  }\r\n\r\n  /**\r\n   * 生成位置标识符\r\n   */\r\n  private generatePosition(index: number): Position {\r\n    const items = this.getVisibleItems()\r\n\r\n    let prevPos: Position = [{ digit: 0, siteId: '' }]\r\n    let nextPos: Position = [{ digit: Number.MAX_SAFE_INTEGER, siteId: '' }]\r\n\r\n    if (index > 0 && items[index - 1])\r\n      prevPos = items[index - 1].id.position\r\n\r\n    if (index < items.length && items[index])\r\n      nextPos = items[index].id.position\r\n\r\n    return this.generatePositionBetween(prevPos, nextPos)\r\n  }\r\n\r\n  /**\r\n   * 在两个位置之间生成新位置\r\n   */\r\n  private generatePositionBetween(prev: Position, next: Position): Position {\r\n    const maxDepth = Math.max(prev.length, next.length)\r\n    const newPos: Position = []\r\n\r\n    for (let i = 0; i < maxDepth; i++) {\r\n      const prevDigit = prev[i]?.digit || 0\r\n      const nextDigit = next[i]?.digit || Number.MAX_SAFE_INTEGER\r\n\r\n      if (nextDigit - prevDigit > 1) {\r\n        // 有空间，在中间插入\r\n        const midDigit = Math.floor((prevDigit + nextDigit) / 2)\r\n        newPos.push({ digit: midDigit, siteId: this.siteId })\r\n        break\r\n      }\r\n      else if (i === maxDepth - 1) {\r\n        // 已到末尾，追加新层级\r\n        newPos.push(...prev.slice(0, i + 1))\r\n        newPos.push({ digit: prevDigit + 1, siteId: this.siteId })\r\n        break\r\n      }\r\n      else {\r\n        // 继续下一层\r\n        newPos.push({ digit: prevDigit, siteId: prev[i]?.siteId || this.siteId })\r\n      }\r\n    }\r\n\r\n    return newPos\r\n  }\r\n\r\n  /**\r\n   * 将标识符转换为键\r\n   */\r\n  private identifierToKey(identifier: Identifier): string {\r\n    return identifier.position\r\n      .map(p => `${p.digit}:${p.siteId}`)\r\n      .join('|')\r\n  }\r\n\r\n  /**\r\n   * 获取可见项\r\n   */\r\n  private getVisibleItems() {\r\n    return Array.from(this.state.values())\r\n      .filter(item => item.visible)\r\n      .sort((a, b) => this.comparePositions(a.id.position, b.id.position))\r\n  }\r\n\r\n  /**\r\n   * 比较位置\r\n   */\r\n  private comparePositions(a: Position, b: Position): number {\r\n    const maxLen = Math.max(a.length, b.length)\r\n\r\n    for (let i = 0; i < maxLen; i++) {\r\n      const aDigit = a[i]?.digit || 0\r\n      const bDigit = b[i]?.digit || 0\r\n\r\n      if (aDigit !== bDigit)\r\n        return aDigit - bDigit\r\n\r\n      // 数字相同，比较站点ID\r\n      const aSiteId = a[i]?.siteId || ''\r\n      const bSiteId = b[i]?.siteId || ''\r\n\r\n      if (aSiteId !== bSiteId)\r\n        return aSiteId.localeCompare(bSiteId)\r\n    }\r\n\r\n    return 0\r\n  }\r\n\r\n  /**\r\n   * 获取文本内容\r\n   */\r\n  getText(): string {\r\n    return this.getVisibleItems()\r\n      .map(item => item.char)\r\n      .join('')\r\n  }\r\n\r\n  /**\r\n   * 设置文本内容\r\n   */\r\n  setText(text: string): CRDTOperation[] {\r\n    const operations: CRDTOperation[] = []\r\n\r\n    // 清空当前内容\r\n    const items = this.getVisibleItems()\r\n    for (let i = items.length - 1; i >= 0; i--) {\r\n      const op = this.delete(i)\r\n      if (op)\r\n        operations.push(op)\r\n    }\r\n\r\n    // 插入新内容\r\n    for (let i = 0; i < text.length; i++)\r\n      operations.push(this.insert(i, text[i]))\r\n\r\n    return operations\r\n  }\r\n\r\n  /**\r\n   * 获取状态\r\n   */\r\n  getState(): CRDTState {\r\n    return {\r\n      siteId: this.siteId,\r\n      clock: this.clock,\r\n      versionVector: Object.fromEntries(this.versionVector),\r\n      operations: this.history,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 合并远程状态\r\n   */\r\n  merge(remoteState: CRDTState): CRDTOperation[] {\r\n    logger.info(`Merging state from site: ${remoteState.siteId}`)\r\n\r\n    const newOperations: CRDTOperation[] = []\r\n\r\n    // 找出本地没有的操作\r\n    remoteState.operations.forEach((remoteOp) => {\r\n      const localClock = this.versionVector.get(remoteOp.siteId) || 0\r\n\r\n      if (remoteOp.clock > localClock) {\r\n        // 应用远程操作\r\n        this.applyOperation(remoteOp)\r\n        this.history.push(remoteOp)\r\n        newOperations.push(remoteOp)\r\n      }\r\n    })\r\n\r\n    logger.info(`Merged ${newOperations.length} new operations`)\r\n\r\n    return newOperations\r\n  }\r\n\r\n  /**\r\n   * 获取增量操作（自指定版本向量以来的操作）\r\n   */\r\n  getDelta(remoteVersionVector: Record<string, number>): CRDTOperation[] {\r\n    const delta: CRDTOperation[] = []\r\n\r\n    this.history.forEach((op) => {\r\n      const remoteClock = remoteVersionVector[op.siteId] || 0\r\n      if (op.clock > remoteClock)\r\n        delta.push(op)\r\n    })\r\n\r\n    return delta\r\n  }\r\n\r\n  /**\r\n   * 清空所有数据\r\n   */\r\n  clear(): void {\r\n    this.state.clear()\r\n    this.history = []\r\n    this.clock = 0\r\n    this.versionVector.clear()\r\n    this.versionVector.set(this.siteId, 0)\r\n  }\r\n\r\n  /**\r\n   * 获取站点ID\r\n   */\r\n  getSiteId(): string {\r\n    return this.siteId\r\n  }\r\n\r\n  /**\r\n   * 获取时钟值\r\n   */\r\n  getClock(): number {\r\n    return this.clock\r\n  }\r\n}\r\n"],"names":["logger","createLogger","CRDT","constructor","siteId","clock","state","Map","history","versionVector","generateSiteId","set","info","Date","now","Math","random","toString","substr","insert","index","char","position","generatePosition","identifier","operation","type","timestamp","applyOperation","push","debug","delete","items","getVisibleItems","length","warn","item","id","key","identifierToKey","visible","get","remoteClock","prevPos","digit","nextPos","Number","MAX_SAFE_INTEGER","generatePositionBetween","prev","next","maxDepth","max","newPos","i","prevDigit","nextDigit","midDigit","floor","slice","map","p","join","Array","from","values","filter","sort","a","b","comparePositions","maxLen","aDigit","bDigit","aSiteId","bSiteId","localeCompare","getText","setText","text","operations","op","getState","Object","fromEntries","merge","remoteState","newOperations","forEach","remoteOp","localClock","getDelta","remoteVersionVector","delta","clear","getSiteId","getClock"],"mappings":"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"}