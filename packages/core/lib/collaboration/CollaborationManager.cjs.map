{"version":3,"file":"CollaborationManager.cjs","sources":["../../src/collaboration/CollaborationManager.ts"],"sourcesContent":["/**\r\n * 协作管理器\r\n * 管理实时协作编辑、CRDT同步、P2P连接\r\n */\r\n\r\nimport type { Editor } from '../core/Editor'\r\nimport type {\r\n  CollaborationConfig,\r\n  CollaborationMessage,\r\n  CollaborationUser,\r\n  ConnectionStatus,\r\n  CRDTOperation,\r\n} from './crdt/types'\r\nimport { EventEmitter } from '../core/EventEmitter'\r\nimport { createLogger } from '../utils/logger'\r\nimport { CRDT } from './crdt/CRDT'\r\n\r\nconst logger = createLogger('CollaborationManager')\r\n\r\nexport class CollaborationManager extends EventEmitter<any> {\r\n  private editor: Editor\r\n  private config: Required<CollaborationConfig>\r\n  private crdt: CRDT\r\n  private users = new Map<string, CollaborationUser>()\r\n  private ws?: WebSocket\r\n  private rtcConnections = new Map<string, RTCPeerConnection>()\r\n  private status: ConnectionStatus = 'disconnected'\r\n  private heartbeatTimer?: number\r\n  private syncTimer?: number\r\n  private reconnectAttempts = 0\r\n\r\n  constructor(editor: Editor, config: CollaborationConfig) {\r\n    super()\r\n    this.editor = editor\r\n    this.config = {\r\n      heartbeatInterval: 30000,\r\n      syncInterval: 5000,\r\n      autoReconnect: true,\r\n      maxReconnectAttempts: 5,\r\n      enableP2P: false,\r\n      cursorColor: this.generateColor(),\r\n      ...config,\r\n      siteId: config.siteId,\r\n      user: config.user,\r\n    } as Required<CollaborationConfig>\r\n\r\n    // 初始化CRDT\r\n    this.crdt = new CRDT(config.siteId)\r\n\r\n    // 设置当前用户\r\n    this.users.set(this.crdt.getSiteId(), {\r\n      id: config.user.id,\r\n      name: config.user.name,\r\n      siteId: this.crdt.getSiteId(),\r\n      avatar: config.user.avatar,\r\n      color: this.config.cursorColor,\r\n      lastActive: Date.now(),\r\n      online: true,\r\n    })\r\n\r\n    this.setupEditorListeners()\r\n  }\r\n\r\n  /**\r\n   * 连接到协作服务器\r\n   */\r\n  async connect(): Promise<void> {\r\n    if (!this.config.serverUrl) {\r\n      logger.warn('No server URL configured')\r\n      return\r\n    }\r\n\r\n    try {\r\n      this.setStatus('connecting')\r\n\r\n      logger.info(`Connecting to ${this.config.serverUrl}`)\r\n\r\n      this.ws = new WebSocket(this.config.serverUrl)\r\n      this.setupWebSocketListeners()\r\n\r\n      // 等待连接建立\r\n      await new Promise<void>((resolve, reject) => {\r\n        if (!this.ws)\r\n          return reject(new Error('WebSocket not created'))\r\n\r\n        this.ws.onopen = () => resolve()\r\n        this.ws.onerror = () => reject(new Error('Connection failed'))\r\n\r\n        setTimeout(() => reject(new Error('Connection timeout')), 10000)\r\n      })\r\n\r\n      this.setStatus('connected')\r\n\r\n      // 发送加入消息\r\n      this.sendJoin()\r\n\r\n      // 启动心跳\r\n      this.startHeartbeat()\r\n\r\n      // 启动定期同步\r\n      this.startSync()\r\n\r\n      logger.info('Connected to collaboration server')\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to connect:', error)\r\n      this.setStatus('error')\r\n      this.emit('error', [error as Error])\r\n\r\n      // 自动重连\r\n      if (this.config.autoReconnect && this.reconnectAttempts < this.config.maxReconnectAttempts)\r\n        this.reconnect()\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 断开连接\r\n   */\r\n  disconnect(): void {\r\n    if (this.ws) {\r\n      this.sendLeave()\r\n      this.ws.close()\r\n      this.ws = undefined\r\n    }\r\n\r\n    this.stopHeartbeat()\r\n    this.stopSync()\r\n    this.closeAllP2PConnections()\r\n\r\n    this.setStatus('disconnected')\r\n    logger.info('Disconnected from collaboration server')\r\n  }\r\n\r\n  /**\r\n   * 重新连接\r\n   */\r\n  private async reconnect(): Promise<void> {\r\n    this.reconnectAttempts++\r\n    this.setStatus('reconnecting')\r\n\r\n    logger.info(`Reconnecting... (attempt ${this.reconnectAttempts}/${this.config.maxReconnectAttempts})`)\r\n\r\n    // 等待一段时间后重连\r\n    const delay = Math.min(1000 * 2 ** (this.reconnectAttempts - 1), 30000)\r\n    await new Promise(resolve => setTimeout(resolve, delay))\r\n\r\n    await this.connect()\r\n  }\r\n\r\n  /**\r\n   * 设置状态\r\n   */\r\n  private setStatus(status: ConnectionStatus): void {\r\n    this.status = status\r\n    this.emit('connection-status', [status])\r\n  }\r\n\r\n  /**\r\n   * 设置编辑器监听\r\n   */\r\n  private setupEditorListeners(): void {\r\n    // 监听编辑器变化\r\n    let isRemoteChange = false\r\n\r\n    this.editor.on('change', (change: any) => {\r\n      if (isRemoteChange)\r\n        return\r\n\r\n      // 将编辑器变化转换为CRDT操作\r\n      const operations = this.handleEditorChange(change)\r\n\r\n      // 广播操作\r\n      operations.forEach(op => this.broadcastOperation(op))\r\n    })\r\n\r\n    // 应用远程操作时设置标志\r\n    this.on('remote-operation', (...args: any[]) => {\r\n      isRemoteChange = true\r\n      this.applyRemoteOperation(args[0])\r\n      isRemoteChange = false\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 处理编辑器变化\r\n   */\r\n  private handleEditorChange(change: any): CRDTOperation[] {\r\n    const operations: CRDTOperation[] = []\r\n\r\n    // 根据变化类型生成CRDT操作\r\n    if (change.type === 'insert') {\r\n      for (let i = 0; i < change.text.length; i++)\r\n        operations.push(this.crdt.insert(change.from + i, change.text[i]))\r\n    }\r\n    else if (change.type === 'delete') {\r\n      for (let i = 0; i < change.length; i++) {\r\n        const op = this.crdt.delete(change.from)\r\n        if (op)\r\n          operations.push(op)\r\n      }\r\n    }\r\n\r\n    return operations\r\n  }\r\n\r\n  /**\r\n   * 应用远程操作\r\n   */\r\n  private applyRemoteOperation(operation: CRDTOperation): void {\r\n    this.crdt.applyOperation(operation)\r\n\r\n    // 更新编辑器内容\r\n    const newText = this.crdt.getText()\r\n    if ('setContent' in this.editor && typeof this.editor.setContent === 'function') {\r\n      (this.editor as any).setContent(newText)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 设置WebSocket监听\r\n   */\r\n  private setupWebSocketListeners(): void {\r\n    if (!this.ws)\r\n      return\r\n\r\n    this.ws.onmessage = (event) => {\r\n      try {\r\n        const message: CollaborationMessage = JSON.parse(event.data)\r\n        this.handleMessage(message)\r\n      }\r\n      catch (error) {\r\n        logger.error('Failed to parse message:', error)\r\n      }\r\n    }\r\n\r\n    this.ws.onclose = () => {\r\n      logger.info('WebSocket closed')\r\n      this.setStatus('disconnected')\r\n\r\n      if (this.config.autoReconnect)\r\n        this.reconnect()\r\n    }\r\n\r\n    this.ws.onerror = (error) => {\r\n      logger.error('WebSocket error:', error)\r\n      this.emit('error', [new Error('WebSocket error')])\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理消息\r\n   */\r\n  private handleMessage(message: CollaborationMessage): void {\r\n    logger.debug(`Received message: ${message.type}`)\r\n\r\n    switch (message.type) {\r\n      case 'operation':\r\n        this.handleOperationMessage(message)\r\n        break\r\n\r\n      case 'cursor':\r\n        this.handleCursorMessage(message)\r\n        break\r\n\r\n      case 'join':\r\n        this.handleJoinMessage(message)\r\n        break\r\n\r\n      case 'leave':\r\n        this.handleLeaveMessage(message)\r\n        break\r\n\r\n      case 'sync-response':\r\n        this.handleSyncResponse(message)\r\n        break\r\n\r\n      case 'heartbeat':\r\n        // 心跳响应\r\n        break\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理操作消息\r\n   */\r\n  private handleOperationMessage(message: CollaborationMessage): void {\r\n    const operation: CRDTOperation = message.payload\r\n    this.emit('remote-operation', [operation])\r\n  }\r\n\r\n  /**\r\n   * 处理光标消息\r\n   */\r\n  private handleCursorMessage(message: CollaborationMessage): void {\r\n    const { userId, cursor } = message.payload\r\n\r\n    const user = Array.from(this.users.values()).find(u => u.id === userId)\r\n    if (user) {\r\n      user.cursor = cursor\r\n      user.lastActive = Date.now()\r\n      this.emit('cursor-update', [userId, cursor])\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理加入消息\r\n   */\r\n  private handleJoinMessage(message: CollaborationMessage): void {\r\n    const user: CollaborationUser = message.payload\r\n    this.users.set(user.siteId, user)\r\n    this.emit('user-joined', [user])\r\n    logger.info(`User joined: ${user.name}`)\r\n  }\r\n\r\n  /**\r\n   * 处理离开消息\r\n   */\r\n  private handleLeaveMessage(message: CollaborationMessage): void {\r\n    const userId = message.payload.userId\r\n    const user = Array.from(this.users.values()).find(u => u.id === userId)\r\n\r\n    if (user) {\r\n      this.users.delete(user.siteId)\r\n      this.emit('user-left', [userId])\r\n      logger.info(`User left: ${user.name}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理同步响应\r\n   */\r\n  private handleSyncResponse(message: CollaborationMessage): void {\r\n    const state: any = message.payload\r\n\r\n    // 合并远程状态\r\n    const newOps = this.crdt.merge(state)\r\n\r\n    // 应用新操作\r\n    newOps.forEach(op => this.emit('remote-operation', [op]))\r\n\r\n    this.emit('sync-complete', [])\r\n  }\r\n\r\n  /**\r\n   * 广播操作\r\n   */\r\n  private broadcastOperation(operation: CRDTOperation): void {\r\n    this.sendMessage({\r\n      type: 'operation',\r\n      payload: operation,\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 发送消息\r\n   */\r\n  private sendMessage(message: Omit<CollaborationMessage, 'from' | 'timestamp' | 'id'>): void {\r\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\r\n      logger.warn('Cannot send message: not connected')\r\n      return\r\n    }\r\n\r\n    const fullMessage: CollaborationMessage = {\r\n      ...message,\r\n      from: this.crdt.getSiteId(),\r\n      timestamp: Date.now(),\r\n      id: `${Date.now()}-${Math.random()}`,\r\n    }\r\n\r\n    this.ws.send(JSON.stringify(fullMessage))\r\n  }\r\n\r\n  /**\r\n   * 发送加入消息\r\n   */\r\n  private sendJoin(): void {\r\n    const user = this.users.get(this.crdt.getSiteId())!\r\n\r\n    this.sendMessage({\r\n      type: 'join',\r\n      payload: user,\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 发送离开消息\r\n   */\r\n  private sendLeave(): void {\r\n    this.sendMessage({\r\n      type: 'leave',\r\n      payload: {\r\n        userId: this.config.user.id,\r\n      },\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 启动心跳\r\n   */\r\n  private startHeartbeat(): void {\r\n    this.heartbeatTimer = window.setInterval(() => {\r\n      this.sendMessage({\r\n        type: 'heartbeat',\r\n        payload: {\r\n          siteId: this.crdt.getSiteId(),\r\n          clock: this.crdt.getClock(),\r\n        },\r\n      })\r\n    }, this.config.heartbeatInterval)\r\n  }\r\n\r\n  /**\r\n   * 停止心跳\r\n   */\r\n  private stopHeartbeat(): void {\r\n    if (this.heartbeatTimer)\r\n      clearInterval(this.heartbeatTimer)\r\n  }\r\n\r\n  /**\r\n   * 启动定期同步\r\n   */\r\n  private startSync(): void {\r\n    this.syncTimer = window.setInterval(() => {\r\n      this.requestSync()\r\n    }, this.config.syncInterval)\r\n  }\r\n\r\n  /**\r\n   * 停止同步\r\n   */\r\n  private stopSync(): void {\r\n    if (this.syncTimer)\r\n      clearInterval(this.syncTimer)\r\n  }\r\n\r\n  /**\r\n   * 请求同步\r\n   */\r\n  private requestSync(): void {\r\n    this.sendMessage({\r\n      type: 'sync-request',\r\n      payload: {\r\n        versionVector: Object.fromEntries((this.crdt as any).versionVector),\r\n      },\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 关闭所有P2P连接\r\n   */\r\n  private closeAllP2PConnections(): void {\r\n    this.rtcConnections.forEach(conn => conn.close())\r\n    this.rtcConnections.clear()\r\n  }\r\n\r\n  /**\r\n   * 生成颜色\r\n   */\r\n  private generateColor(): string {\r\n    const colors = [\r\n      '#FF6B6B',\r\n      '#4ECDC4',\r\n      '#45B7D1',\r\n      '#FFA07A',\r\n      '#98D8C8',\r\n      '#F7DC6F',\r\n      '#BB8FCE',\r\n      '#85C1E2',\r\n      '#F8B739',\r\n      '#52B788',\r\n    ]\r\n    return colors[Math.floor(Math.random() * colors.length)]\r\n  }\r\n\r\n  /**\r\n   * 获取在线用户\r\n   */\r\n  getOnlineUsers(): CollaborationUser[] {\r\n    return Array.from(this.users.values()).filter(u => u.online)\r\n  }\r\n\r\n  /**\r\n   * 获取连接状态\r\n   */\r\n  getStatus(): ConnectionStatus {\r\n    return this.status\r\n  }\r\n\r\n  /**\r\n   * 获取CRDT状态\r\n   */\r\n  getCRDTState() {\r\n    return this.crdt.getState()\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   */\r\n  destroy(): void {\r\n    this.disconnect()\r\n    // Remove all listeners by calling parent method\r\n    if (typeof (this as any).removeAllListeners === 'function') {\r\n      (this as any).removeAllListeners()\r\n    }\r\n    logger.info('Collaboration manager destroyed')\r\n  }\r\n}\r\n"],"names":["logger","createLogger","CollaborationManager","EventEmitter","constructor","editor","config","users","Map","rtcConnections","status","reconnectAttempts","heartbeatInterval","syncInterval","autoReconnect","maxReconnectAttempts","enableP2P","cursorColor","generateColor","siteId","user","crdt","CRDT","set","getSiteId","id","name","avatar","color","lastActive","Date","now","online","setupEditorListeners","connect","serverUrl","warn","setStatus","info","ws","WebSocket","setupWebSocketListeners","Promise","resolve","reject","Error","onopen","onerror","setTimeout","sendJoin","startHeartbeat","startSync","error","emit","reconnect","disconnect","sendLeave","close","undefined","stopHeartbeat","stopSync","closeAllP2PConnections","delay","Math","min","isRemoteChange","on","change","operations","handleEditorChange","forEach","op","broadcastOperation","args","applyRemoteOperation","type","i","text","length","push","insert","from","delete","operation","applyOperation","newText","getText","setContent","onmessage","event","message","JSON","parse","data","handleMessage","onclose","debug","handleOperationMessage","handleCursorMessage","handleJoinMessage","handleLeaveMessage","handleSyncResponse","payload","userId","cursor","Array","values","find","u","state","newOps","merge","sendMessage","readyState","OPEN","fullMessage","timestamp","random","send","stringify","get","heartbeatTimer","window","setInterval","clock","getClock","clearInterval","syncTimer","requestSync","versionVector","Object","fromEntries","conn","clear","colors","floor","getOnlineUsers","filter","getStatus","getCRDTState","getState","destroy","removeAllListeners"],"mappings":"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"}