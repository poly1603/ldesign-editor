{"version":3,"file":"PermissionManager.cjs","sources":["../../../src/enterprise/auth/PermissionManager.ts"],"sourcesContent":["/**\r\n * 权限管理器\r\n * 实现基于角色的访问控制（RBAC）\r\n */\r\n\r\nimport type { Permission, PermissionConfig, PermissionEvents, Role, User } from './types'\r\nimport { EventEmitter } from '../../core/EventEmitter'\r\nimport { createLogger } from '../../utils/logger'\r\n\r\nconst logger = createLogger('PermissionManager')\r\n\r\nexport class PermissionManager extends EventEmitter<PermissionEvents> {\r\n  private config: PermissionConfig\r\n  private currentUser?: User\r\n  private roles = new Map<string, Role>()\r\n  private permissions = new Map<string, Permission>()\r\n  private userRoles = new Map<string, string[]>()\r\n\r\n  constructor(config: PermissionConfig = {}) {\r\n    super()\r\n    this.config = {\r\n      strictMode: true,\r\n      cachePermissions: true,\r\n      inheritRoles: true,\r\n      ...config,\r\n    }\r\n\r\n    this.initializeDefaultRoles()\r\n    this.initializeDefaultPermissions()\r\n  }\r\n\r\n  /**\r\n   * 初始化默认角色\r\n   */\r\n  private initializeDefaultRoles(): void {\r\n    // 管理员角色\r\n    this.addRole({\r\n      id: 'admin',\r\n      name: '管理员',\r\n      description: '拥有所有权限',\r\n      permissions: ['*'],\r\n      priority: 100,\r\n    })\r\n\r\n    // 编辑角色\r\n    this.addRole({\r\n      id: 'editor',\r\n      name: '编辑者',\r\n      description: '可以编辑和查看内容',\r\n      permissions: [\r\n        'document.read',\r\n        'document.write',\r\n        'document.create',\r\n        'document.delete',\r\n        'comment.create',\r\n        'comment.read',\r\n      ],\r\n      priority: 50,\r\n    })\r\n\r\n    // 查看者角色\r\n    this.addRole({\r\n      id: 'viewer',\r\n      name: '查看者',\r\n      description: '只能查看内容',\r\n      permissions: [\r\n        'document.read',\r\n        'comment.read',\r\n      ],\r\n      priority: 10,\r\n    })\r\n\r\n    // 评论者角色\r\n    this.addRole({\r\n      id: 'commenter',\r\n      name: '评论者',\r\n      description: '可以查看和评论',\r\n      permissions: [\r\n        'document.read',\r\n        'comment.read',\r\n        'comment.create',\r\n      ],\r\n      inherits: ['viewer'],\r\n      priority: 20,\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 初始化默认权限\r\n   */\r\n  private initializeDefaultPermissions(): void {\r\n    const permissions: Permission[] = [\r\n      // 文档权限\r\n      { id: 'document.read', name: '读取文档', resource: 'document', action: 'read' },\r\n      { id: 'document.write', name: '编辑文档', resource: 'document', action: 'write' },\r\n      { id: 'document.create', name: '创建文档', resource: 'document', action: 'create' },\r\n      { id: 'document.delete', name: '删除文档', resource: 'document', action: 'delete' },\r\n      { id: 'document.share', name: '分享文档', resource: 'document', action: 'share' },\r\n      { id: 'document.export', name: '导出文档', resource: 'document', action: 'export' },\r\n\r\n      // 评论权限\r\n      { id: 'comment.read', name: '读取评论', resource: 'comment', action: 'read' },\r\n      { id: 'comment.create', name: '创建评论', resource: 'comment', action: 'create' },\r\n      { id: 'comment.update', name: '编辑评论', resource: 'comment', action: 'update' },\r\n      { id: 'comment.delete', name: '删除评论', resource: 'comment', action: 'delete' },\r\n\r\n      // 协作权限\r\n      { id: 'collaboration.join', name: '加入协作', resource: 'collaboration', action: 'join' },\r\n      { id: 'collaboration.invite', name: '邀请协作', resource: 'collaboration', action: 'invite' },\r\n\r\n      // 管理权限\r\n      { id: 'admin.users', name: '管理用户', resource: 'admin', action: 'users' },\r\n      { id: 'admin.roles', name: '管理角色', resource: 'admin', action: 'roles' },\r\n      { id: 'admin.settings', name: '管理设置', resource: 'admin', action: 'settings' },\r\n    ]\r\n\r\n    permissions.forEach(p => this.permissions.set(p.id, p))\r\n  }\r\n\r\n  /**\r\n   * 设置当前用户\r\n   */\r\n  setCurrentUser(user: User): void {\r\n    this.currentUser = user\r\n    logger.info(`Current user set: ${user.name} (${user.id})`)\r\n\r\n    // 加载用户角色\r\n    if (user.roles)\r\n      this.userRoles.set(user.id, user.roles)\r\n\r\n    this.emit('user-changed', user)\r\n  }\r\n\r\n  /**\r\n   * 获取当前用户\r\n   */\r\n  getCurrentUser(): User | undefined {\r\n    return this.currentUser\r\n  }\r\n\r\n  /**\r\n   * 添加角色\r\n   */\r\n  addRole(role: Role): void {\r\n    this.roles.set(role.id, role)\r\n    logger.debug(`Role added: ${role.name}`)\r\n  }\r\n\r\n  /**\r\n   * 获取角色\r\n   */\r\n  getRole(roleId: string): Role | undefined {\r\n    return this.roles.get(roleId)\r\n  }\r\n\r\n  /**\r\n   * 分配角色给用户\r\n   */\r\n  assignRole(userId: string, roleId: string): void {\r\n    const role = this.roles.get(roleId)\r\n    if (!role)\r\n      throw new Error(`Role not found: ${roleId}`)\r\n\r\n    const userRoles = this.userRoles.get(userId) || []\r\n    if (!userRoles.includes(roleId)) {\r\n      userRoles.push(roleId)\r\n      this.userRoles.set(userId, userRoles)\r\n\r\n      logger.info(`Assigned role ${roleId} to user ${userId}`)\r\n      this.emit('role-assigned', { userId, roleId })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 移除用户角色\r\n   */\r\n  removeRole(userId: string, roleId: string): void {\r\n    const userRoles = this.userRoles.get(userId) || []\r\n    const index = userRoles.indexOf(roleId)\r\n\r\n    if (index > -1) {\r\n      userRoles.splice(index, 1)\r\n      this.userRoles.set(userId, userRoles)\r\n\r\n      logger.info(`Removed role ${roleId} from user ${userId}`)\r\n      this.emit('role-removed', { userId, roleId })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取用户的所有权限\r\n   */\r\n  getUserPermissions(userId?: string): string[] {\r\n    const uid = userId || this.currentUser?.id\r\n    if (!uid)\r\n      return []\r\n\r\n    const userRoles = this.userRoles.get(uid) || []\r\n    const permissions = new Set<string>()\r\n\r\n    userRoles.forEach((roleId) => {\r\n      const role = this.roles.get(roleId)\r\n      if (role)\r\n        this.resolveRolePermissions(role, permissions)\r\n    })\r\n\r\n    return Array.from(permissions)\r\n  }\r\n\r\n  /**\r\n   * 解析角色权限（包括继承）\r\n   */\r\n  private resolveRolePermissions(role: Role, permissions: Set<string>): void {\r\n    // 添加角色的直接权限\r\n    if (role.permissions.includes('*')) {\r\n      // 通配符，拥有所有权限\r\n      this.permissions.forEach(p => permissions.add(p.id))\r\n      return\r\n    }\r\n\r\n    role.permissions.forEach(p => permissions.add(p))\r\n\r\n    // 处理继承\r\n    if (this.config.inheritRoles && role.inherits) {\r\n      role.inherits.forEach((parentRoleId) => {\r\n        const parentRole = this.roles.get(parentRoleId)\r\n        if (parentRole)\r\n          this.resolveRolePermissions(parentRole, permissions)\r\n      })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 检查权限\r\n   */\r\n  hasPermission(permissionId: string, userId?: string): boolean {\r\n    const uid = userId || this.currentUser?.id\r\n    if (!uid)\r\n      return !this.config.strictMode\r\n\r\n    const userPermissions = this.getUserPermissions(uid)\r\n\r\n    // 检查精确匹配\r\n    if (userPermissions.includes(permissionId))\r\n      return true\r\n\r\n    // 检查通配符\r\n    if (userPermissions.includes('*'))\r\n      return true\r\n\r\n    // 检查资源级别通配符\r\n    const parts = permissionId.split('.')\r\n    if (parts.length > 1) {\r\n      const resourceWildcard = `${parts[0]}.*`\r\n      if (userPermissions.includes(resourceWildcard))\r\n        return true\r\n    }\r\n\r\n    return false\r\n  }\r\n\r\n  /**\r\n   * 检查多个权限（AND）\r\n   */\r\n  hasAllPermissions(permissionIds: string[], userId?: string): boolean {\r\n    return permissionIds.every(id => this.hasPermission(id, userId))\r\n  }\r\n\r\n  /**\r\n   * 检查多个权限（OR）\r\n   */\r\n  hasAnyPermission(permissionIds: string[], userId?: string): boolean {\r\n    return permissionIds.some(id => this.hasPermission(id, userId))\r\n  }\r\n\r\n  /**\r\n   * 检查角色\r\n   */\r\n  hasRole(roleId: string, userId?: string): boolean {\r\n    const uid = userId || this.currentUser?.id\r\n    if (!uid)\r\n      return false\r\n\r\n    const userRoles = this.userRoles.get(uid) || []\r\n    return userRoles.includes(roleId)\r\n  }\r\n\r\n  /**\r\n   * 权限断言（失败抛出异常）\r\n   */\r\n  assertPermission(permissionId: string, userId?: string): void {\r\n    if (!this.hasPermission(permissionId, userId)) {\r\n      const error = new Error(`Permission denied: ${permissionId}`)\r\n      this.emit('permission-denied', { permissionId, userId: userId || this.currentUser?.id })\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取所有角色\r\n   */\r\n  getAllRoles(): Role[] {\r\n    return Array.from(this.roles.values())\r\n  }\r\n\r\n  /**\r\n   * 获取所有权限\r\n   */\r\n  getAllPermissions(): Permission[] {\r\n    return Array.from(this.permissions.values())\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   */\r\n  destroy(): void {\r\n    this.roles.clear()\r\n    this.permissions.clear()\r\n    this.userRoles.clear()\r\n    this.currentUser = undefined\r\n    this.removeAllListeners()\r\n  }\r\n}\r\n"],"names":["logger","createLogger","PermissionManager","EventEmitter","constructor","config","roles","Map","permissions","userRoles","strictMode","cachePermissions","inheritRoles","initializeDefaultRoles","initializeDefaultPermissions","addRole","id","name","description","priority","inherits","resource","action","forEach","p","set","setCurrentUser","user","currentUser","info","emit","getCurrentUser","role","debug","getRole","roleId","get","assignRole","userId","Error","includes","push","removeRole","index","indexOf","splice","getUserPermissions","uid","Set","resolveRolePermissions","Array","from","add","parentRoleId","parentRole","hasPermission","permissionId","userPermissions","parts","split","length","resourceWildcard","hasAllPermissions","permissionIds","every","hasAnyPermission","some","hasRole","assertPermission","error","getAllRoles","values","getAllPermissions","destroy","clear","undefined","removeAllListeners"],"mappings":"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"}