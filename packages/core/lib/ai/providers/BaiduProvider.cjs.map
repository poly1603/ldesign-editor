{"version":3,"file":"BaiduProvider.cjs","sources":["../../../src/ai/providers/BaiduProvider.ts"],"sourcesContent":["/**\r\n * 百度文心一言（ERNIE-Bot）提供商\r\n */\r\n\r\nimport type {\r\n  AIModelConfig,\r\n  AIProviderInterface,\r\n  AIRequest,\r\n  AIResponse,\r\n} from '../types'\r\nimport { createLogger } from '../../utils/logger'\r\n\r\nconst logger = createLogger('BaiduProvider')\r\n\r\nexport class BaiduProvider implements AIProviderInterface {\r\n  name = 'baidu' as const\r\n  config: AIModelConfig\r\n  private accessToken?: string\r\n  private tokenExpiry?: number\r\n\r\n  constructor(config: AIModelConfig) {\r\n    this.config = {\r\n      ...config,\r\n      provider: 'baidu',\r\n      model: config.model || 'ernie-bot',\r\n      apiEndpoint: config.apiEndpoint || 'https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat',\r\n    }\r\n  }\r\n\r\n  async initialize(config: AIModelConfig): Promise<void> {\r\n    this.config = { ...this.config, ...config }\r\n\r\n    // 获取访问令牌\r\n    await this.refreshAccessToken()\r\n  }\r\n\r\n  async request(request: AIRequest): Promise<AIResponse> {\r\n    try {\r\n      // 确保有有效的访问令牌\r\n      await this.ensureAccessToken()\r\n\r\n      const messages = this.buildMessages(request)\r\n\r\n      const response = await fetch(`${this.config.apiEndpoint}/${this.getModelEndpoint()}?access_token=${this.accessToken}`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          messages,\r\n          temperature: this.config.temperature || 0.7,\r\n          top_p: 0.9,\r\n          penalty_score: 1.0,\r\n          stream: this.config.stream || false,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text()\r\n        throw new Error(`百度文心一言请求失败: ${response.status} - ${error}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n\r\n      if (data.error_code)\r\n        throw new Error(`百度文心一言错误: ${data.error_code} - ${data.error_msg}`)\r\n\r\n      return {\r\n        success: true,\r\n        text: data.result,\r\n        usage: data.usage\r\n          ? {\r\n            promptTokens: data.usage.prompt_tokens,\r\n            completionTokens: data.usage.completion_tokens,\r\n            totalTokens: data.usage.total_tokens,\r\n          }\r\n          : undefined,\r\n      }\r\n    }\r\n    catch (error) {\r\n      logger.error('文心一言请求失败:', error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : '未知错误',\r\n      }\r\n    }\r\n  }\r\n\r\n  validateConfig(): boolean {\r\n    if (!this.config.apiKey) {\r\n      logger.error('缺少百度API密钥')\r\n      return false\r\n    }\r\n\r\n    // 百度需要API Key和Secret Key（用:分隔）\r\n    const [apiKey, secretKey] = this.config.apiKey.split(':')\r\n    if (!apiKey || !secretKey) {\r\n      logger.error('百度API密钥格式错误，应为 \"API_KEY:SECRET_KEY\"')\r\n      return false\r\n    }\r\n\r\n    return true\r\n  }\r\n\r\n  cleanup(): void {\r\n    this.accessToken = undefined\r\n    this.tokenExpiry = undefined\r\n  }\r\n\r\n  private buildMessages(request: AIRequest): any[] {\r\n    const systemPrompt = this.getSystemPrompt(request.type)\r\n    const messages = []\r\n\r\n    if (systemPrompt) {\r\n      messages.push({\r\n        role: 'user',\r\n        content: `${systemPrompt}\\n\\n${request.text}`,\r\n      })\r\n    }\r\n    else {\r\n      messages.push({\r\n        role: 'user',\r\n        content: request.text,\r\n      })\r\n    }\r\n\r\n    return messages\r\n  }\r\n\r\n  private getSystemPrompt(type: AIRequest['type']): string {\r\n    const prompts = {\r\n      correct: '请纠正以下文本中的错误，包括拼写、语法和表达问题：',\r\n      complete: '请根据上下文完成以下内容：',\r\n      continue: '请继续写下去：',\r\n      rewrite: '请重写以下内容，使其更加清晰、专业：',\r\n      suggest: '请为以下内容提供改进建议：',\r\n    }\r\n    return prompts[type] || ''\r\n  }\r\n\r\n  private getModelEndpoint(): string {\r\n    const modelMap: Record<string, string> = {\r\n      'ernie-bot': 'ernie_bot',\r\n      'ernie-bot-turbo': 'ernie_bot_turbo',\r\n      'ernie-bot-4': 'ernie_bot_4',\r\n      'ernie-3.5-8k': 'ernie_3.5_8k',\r\n      'ernie-3.5-128k': 'ernie_3.5_128k',\r\n    }\r\n    return modelMap[this.config.model] || 'ernie_bot'\r\n  }\r\n\r\n  private async refreshAccessToken(): Promise<void> {\r\n    if (!this.validateConfig())\r\n      throw new Error('百度配置无效')\r\n\r\n    const [apiKey, secretKey] = this.config.apiKey.split(':')\r\n\r\n    const response = await fetch(\r\n      `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${apiKey}&client_secret=${secretKey}`,\r\n      { method: 'POST' },\r\n    )\r\n\r\n    if (!response.ok)\r\n      throw new Error('获取百度访问令牌失败')\r\n\r\n    const data = await response.json()\r\n\r\n    if (data.error)\r\n      throw new Error(`获取百度访问令牌失败: ${data.error} - ${data.error_description}`)\r\n\r\n    this.accessToken = data.access_token\r\n    this.tokenExpiry = Date.now() + (data.expires_in * 1000) - 60000 // 提前1分钟刷新\r\n\r\n    logger.info('百度访问令牌刷新成功')\r\n  }\r\n\r\n  private async ensureAccessToken(): Promise<void> {\r\n    if (!this.accessToken || !this.tokenExpiry || Date.now() >= this.tokenExpiry)\r\n      await this.refreshAccessToken()\r\n  }\r\n}\r\n"],"names":["logger","createLogger","BaiduProvider","constructor","config","name","provider","model","apiEndpoint","initialize","refreshAccessToken","request","ensureAccessToken","messages","buildMessages","response","fetch","getModelEndpoint","accessToken","method","headers","body","JSON","stringify","temperature","top_p","penalty_score","stream","ok","error","text","Error","status","data","json","error_code","error_msg","success","result","usage","promptTokens","prompt_tokens","completionTokens","completion_tokens","totalTokens","total_tokens","undefined","message","validateConfig","apiKey","secretKey","split","cleanup","tokenExpiry","systemPrompt","getSystemPrompt","type","push","role","content","prompts","correct","complete","continue","rewrite","suggest","modelMap","error_description","access_token","Date","now","expires_in","info"],"mappings":"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"}