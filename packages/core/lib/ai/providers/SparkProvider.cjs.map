{"version":3,"file":"SparkProvider.cjs","sources":["../../../src/ai/providers/SparkProvider.ts"],"sourcesContent":["/**\r\n * 讯飞星火（Spark）提供商\r\n */\r\n\r\nimport type {\r\n  AIModelConfig,\r\n  AIProviderInterface,\r\n  AIRequest,\r\n  AIResponse,\r\n} from '../types'\r\nimport { createLogger } from '../../utils/logger'\r\n\r\nconst logger = createLogger('SparkProvider')\r\n\r\nexport class SparkProvider implements AIProviderInterface {\r\n  name = 'spark' as const\r\n  config: AIModelConfig\r\n  private wsUrl: string = ''\r\n\r\n  constructor(config: AIModelConfig) {\r\n    this.config = {\r\n      ...config,\r\n      provider: 'spark',\r\n      model: config.model || 'spark-3.5',\r\n      apiEndpoint: config.apiEndpoint || 'wss://spark-api.xf-yun.com/v3.5/chat',\r\n    }\r\n  }\r\n\r\n  async initialize(config: AIModelConfig): Promise<void> {\r\n    this.config = { ...this.config, ...config }\r\n    this.wsUrl = this.getWebSocketUrl()\r\n  }\r\n\r\n  async request(request: AIRequest): Promise<AIResponse> {\r\n    try {\r\n      // 讯飞星火使用WebSocket接口\r\n      const response = await this.makeWebSocketRequest(request)\r\n\r\n      return {\r\n        success: true,\r\n        text: response.text,\r\n        usage: response.usage,\r\n      }\r\n    }\r\n    catch (error) {\r\n      logger.error('讯飞星火请求失败:', error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : '未知错误',\r\n      }\r\n    }\r\n  }\r\n\r\n  validateConfig(): boolean {\r\n    if (!this.config.apiKey) {\r\n      logger.error('缺少讯飞API密钥')\r\n      return false\r\n    }\r\n\r\n    // 讯飞需要APPID、APIKey和APISecret（用:分隔）\r\n    const parts = this.config.apiKey.split(':')\r\n    if (parts.length !== 3 || !parts[0] || !parts[1] || !parts[2]) {\r\n      logger.error('讯飞API密钥格式错误，应为 \"APP_ID:API_KEY:API_SECRET\"')\r\n      return false\r\n    }\r\n\r\n    return true\r\n  }\r\n\r\n  cleanup(): void {\r\n    // 清理WebSocket连接等资源\r\n  }\r\n\r\n  private async makeWebSocketRequest(request: AIRequest): Promise<{ text: string, usage?: any }> {\r\n    return new Promise((resolve, reject) => {\r\n      const ws = new WebSocket(this.wsUrl)\r\n      let fullText = ''\r\n      let usage: any = null\r\n\r\n      ws.onopen = () => {\r\n        logger.debug('WebSocket连接已建立')\r\n\r\n        // 发送请求\r\n        const params = this.buildWebSocketParams(request)\r\n        ws.send(JSON.stringify(params))\r\n      }\r\n\r\n      ws.onmessage = (event) => {\r\n        const data = JSON.parse(event.data)\r\n\r\n        if (data.header.code !== 0) {\r\n          ws.close()\r\n          reject(new Error(`讯飞星火错误: ${data.header.code} - ${data.header.message}`))\r\n          return\r\n        }\r\n\r\n        // 提取文本\r\n        const payload = data.payload\r\n        if (payload.choices && payload.choices.text) {\r\n          payload.choices.text.forEach((item: any) => {\r\n            fullText += item.content\r\n          })\r\n        }\r\n\r\n        // 提取用量信息\r\n        if (payload.usage) {\r\n          usage = {\r\n            promptTokens: payload.usage.text.prompt_tokens,\r\n            completionTokens: payload.usage.text.completion_tokens,\r\n            totalTokens: payload.usage.text.total_tokens,\r\n          }\r\n        }\r\n\r\n        // 检查是否结束\r\n        if (data.header.status === 2) {\r\n          ws.close()\r\n          resolve({ text: fullText, usage })\r\n        }\r\n      }\r\n\r\n      ws.onerror = (error) => {\r\n        logger.error('WebSocket错误:', error)\r\n        reject(new Error('WebSocket连接错误'))\r\n      }\r\n\r\n      ws.onclose = () => {\r\n        logger.debug('WebSocket连接已关闭')\r\n      }\r\n    })\r\n  }\r\n\r\n  private buildWebSocketParams(request: AIRequest): any {\r\n    const [appId] = this.config.apiKey.split(':')\r\n\r\n    return {\r\n      header: {\r\n        app_id: appId,\r\n        uid: this.generateUID(),\r\n      },\r\n      parameter: {\r\n        chat: {\r\n          domain: this.getDomain(),\r\n          temperature: this.config.temperature || 0.7,\r\n          max_tokens: this.config.maxTokens || 2000,\r\n          top_k: 4,\r\n          chat_id: this.generateUID(),\r\n        },\r\n      },\r\n      payload: {\r\n        message: {\r\n          text: this.buildMessages(request),\r\n        },\r\n      },\r\n    }\r\n  }\r\n\r\n  private buildMessages(request: AIRequest): any[] {\r\n    const messages = []\r\n\r\n    // 添加系统提示\r\n    const systemPrompt = this.getSystemPrompt(request.type)\r\n    if (systemPrompt) {\r\n      messages.push({\r\n        role: 'system',\r\n        content: systemPrompt,\r\n      })\r\n    }\r\n\r\n    // 添加用户消息\r\n    messages.push({\r\n      role: 'user',\r\n      content: request.text,\r\n    })\r\n\r\n    return messages\r\n  }\r\n\r\n  private getSystemPrompt(type: AIRequest['type']): string {\r\n    const prompts = {\r\n      correct: '请纠正文本中的所有错误，包括拼写、语法和标点符号错误。',\r\n      complete: '请自然地完成这段文本。',\r\n      continue: '请继续写作，保持风格一致。',\r\n      rewrite: '请重写这段文本，使其更加专业和清晰。',\r\n      suggest: '请为这段文本提供改进建议。',\r\n    }\r\n    return prompts[type] || ''\r\n  }\r\n\r\n  private getWebSocketUrl(): string {\r\n    // 讯飞需要APPID、APIKey和APISecret进行鉴权\r\n    // 生成鉴权URL（实际实现需要按照讯飞的鉴权规则）\r\n    // const [_appId, _apiKey, apiSecret] = this.config.apiKey.split(':')\r\n    // const date = new Date().toUTCString()\r\n    // const signatureOrigin = `host: spark-api.xf-yun.com\\ndate: ${date}\\nGET /v3.5/chat HTTP/1.1`\r\n    // const signature = crypto.createHmac('sha256', apiSecret).update(signatureOrigin).digest('base64')\r\n\r\n    // 简化处理，实际使用时需要完整的鉴权实现\r\n    return this.config.apiEndpoint!\r\n  }\r\n\r\n  private getDomain(): string {\r\n    const modelMap: Record<string, string> = {\r\n      'spark-1.5': 'general',\r\n      'spark-2.0': 'generalv2',\r\n      'spark-3.0': 'generalv3',\r\n      'spark-3.5': 'generalv3.5',\r\n    }\r\n    return modelMap[this.config.model] || 'generalv3.5'\r\n  }\r\n\r\n  private generateUID(): string {\r\n    return `uid_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n  }\r\n\r\n  /**\r\n   * 支持的模型列表\r\n   */\r\n  static getSupportedModels() {\r\n    return [\r\n      { id: 'spark-1.5', name: '星火1.5', description: '基础版本' },\r\n      { id: 'spark-2.0', name: '星火2.0', description: '增强版本' },\r\n      { id: 'spark-3.0', name: '星火3.0', description: '专业版本' },\r\n      { id: 'spark-3.5', name: '星火3.5', description: '最新版本，能力最强' },\r\n    ]\r\n  }\r\n}\r\n"],"names":["logger","createLogger","SparkProvider","constructor","config","name","wsUrl","provider","model","apiEndpoint","initialize","getWebSocketUrl","request","response","makeWebSocketRequest","success","text","usage","error","Error","message","validateConfig","apiKey","parts","split","length","cleanup","Promise","resolve","reject","ws","WebSocket","fullText","onopen","debug","params","buildWebSocketParams","send","JSON","stringify","onmessage","event","data","parse","header","code","close","payload","choices","forEach","item","content","promptTokens","prompt_tokens","completionTokens","completion_tokens","totalTokens","total_tokens","status","onerror","onclose","appId","app_id","uid","generateUID","parameter","chat","domain","getDomain","temperature","max_tokens","maxTokens","top_k","chat_id","buildMessages","messages","systemPrompt","getSystemPrompt","type","push","role","prompts","correct","complete","continue","rewrite","suggest","modelMap","Date","now","Math","random","toString","substr","getSupportedModels","id","description"],"mappings":"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"}