{"version":3,"file":"OpenAIProvider.cjs","sources":["../../../src/ai/providers/OpenAIProvider.ts"],"sourcesContent":["/**\r\n * OpenAI 提供商\r\n * 支持 GPT-4, GPT-3.5-turbo 等模型\r\n */\r\n\r\nimport type { AIModelConfig, AIProvider, AIProviderInterface, AIRequest, AIResponse } from '../types'\r\n\r\nexport class OpenAIProvider implements AIProviderInterface {\r\n  name: AIProvider = 'openai'\r\n  config: AIModelConfig\r\n  private apiKey: string\r\n  private baseURL: string\r\n  private model: string\r\n  private defaultConfig: Partial<AIModelConfig>\r\n\r\n  constructor(config: AIModelConfig) {\r\n    this.config = config\r\n    this.apiKey = config.apiKey\r\n    this.baseURL = config.baseURL || config.apiEndpoint || 'https://api.openai.com/v1'\r\n    this.model = config.model || 'gpt-3.5-turbo'\r\n    this.defaultConfig = {\r\n      temperature: 0.7,\r\n      maxTokens: 2000,\r\n      topP: 1,\r\n    }\r\n  }\r\n\r\n  async initialize(config: AIModelConfig): Promise<void> {\r\n    this.config = config\r\n    this.apiKey = config.apiKey\r\n    this.baseURL = config.baseURL || config.apiEndpoint || 'https://api.openai.com/v1'\r\n    this.model = config.model || 'gpt-3.5-turbo'\r\n  }\r\n\r\n  validateConfig(): boolean {\r\n    return !!this.apiKey && !!this.model\r\n  }\r\n\r\n  cleanup(): void {\r\n    // No cleanup needed\r\n  }\r\n\r\n  async request(request: AIRequest): Promise<AIResponse> {\r\n    try {\r\n      const response = await fetch(`${this.baseURL}/chat/completions`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n        },\r\n        body: JSON.stringify({\r\n          model: request.model || this.model,\r\n          messages: [\r\n            { role: 'system', content: request.systemPrompt || 'You are a helpful writing assistant.' },\r\n            { role: 'user', content: request.prompt },\r\n          ],\r\n          temperature: request.temperature || this.defaultConfig.temperature,\r\n          max_tokens: request.maxTokens || this.defaultConfig.maxTokens,\r\n          top_p: request.topP || this.defaultConfig.topP,\r\n          stream: request.stream || false,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const error = await response.json()\r\n        throw new Error(error.error?.message || 'OpenAI API request failed')\r\n      }\r\n\r\n      const data = await response.json()\r\n\r\n      return {\r\n        success: true,\r\n        content: data.choices[0]?.message?.content || '',\r\n        text: data.choices[0]?.message?.content || '',\r\n        usage: {\r\n          promptTokens: data.usage?.prompt_tokens || 0,\r\n          completionTokens: data.usage?.completion_tokens || 0,\r\n          totalTokens: data.usage?.total_tokens || 0,\r\n        },\r\n      }\r\n    }\r\n    catch (error) {\r\n      console.error('OpenAI request failed:', error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      }\r\n    }\r\n  }\r\n\r\n  async stream(request: AIRequest, onChunk: (chunk: string) => void): Promise<void> {\r\n    try {\r\n      const response = await fetch(`${this.baseURL}/chat/completions`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n        },\r\n        body: JSON.stringify({\r\n          model: request.model || this.model,\r\n          messages: [\r\n            { role: 'system', content: request.systemPrompt || 'You are a helpful writing assistant.' },\r\n            { role: 'user', content: request.prompt },\r\n          ],\r\n          temperature: request.temperature || this.defaultConfig.temperature,\r\n          max_tokens: request.maxTokens || this.defaultConfig.maxTokens,\r\n          stream: true,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok)\r\n        throw new Error('OpenAI streaming request failed')\r\n\r\n      const reader = response.body?.getReader()\r\n      const decoder = new TextDecoder()\r\n\r\n      if (!reader)\r\n        throw new Error('No reader available')\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read()\r\n        if (done)\r\n          break\r\n\r\n        const chunk = decoder.decode(value)\r\n        const lines = chunk.split('\\n').filter(line => line.trim() !== '')\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6)\r\n            if (data === '[DONE]')\r\n              continue\r\n\r\n            try {\r\n              const json = JSON.parse(data)\r\n              const content = json.choices[0]?.delta?.content\r\n              if (content)\r\n                onChunk(content)\r\n            }\r\n            catch (e) {\r\n              console.warn('Failed to parse SSE data:', e)\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    catch (error) {\r\n      console.error('OpenAI streaming failed:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  getSupportedModels(): string[] {\r\n    return [\r\n      'gpt-4',\r\n      'gpt-4-turbo-preview',\r\n      'gpt-4-32k',\r\n      'gpt-3.5-turbo',\r\n      'gpt-3.5-turbo-16k',\r\n    ]\r\n  }\r\n}\r\n"],"names":["OpenAIProvider","constructor","config","name","apiKey","baseURL","apiEndpoint","model","defaultConfig","temperature","maxTokens","topP","initialize","validateConfig","cleanup","request","response","fetch","method","headers","body","JSON","stringify","messages","role","content","systemPrompt","prompt","max_tokens","top_p","stream","ok","error","json","Error","message","data","success","choices","text","usage","promptTokens","prompt_tokens","completionTokens","completion_tokens","totalTokens","total_tokens","console","onChunk","reader","getReader","decoder","TextDecoder","done","value","read","chunk","decode","lines","split","filter","line","trim","startsWith","slice","parse","delta","e","warn","getSupportedModels"],"mappings":";;;;;;;;;;;AAOO,MAAMA,cAAAA,CAA8C;AAAA,EAQzDC,YAAYC,MAAAA,EAAuB;AAPnCC,IAAAA,IAAAA,CAAAA,IAAAA,GAAmB,QAAA;AAQjB,IAAA,IAAA,CAAKD,MAAAA,GAASA,MAAAA;AACd,IAAA,IAAA,CAAKE,SAASF,MAAAA,CAAOE,MAAAA;AACrB,IAAA,IAAA,CAAKC,OAAAA,GAAUH,MAAAA,CAAOG,OAAAA,IAAWH,MAAAA,CAAOI,WAAAA,IAAe,2BAAA;AACvD,IAAA,IAAA,CAAKC,KAAAA,GAAQL,OAAOK,KAAAA,IAAS,eAAA;AAC7B,IAAA,IAAA,CAAKC,aAAAA,GAAgB;AAAA,MACnBC,WAAAA,EAAa,GAAA;AAAA,MACbC,SAAAA,EAAW,GAAA;AAAA,MACXC,IAAAA,EAAM;AAAA,KACR;AAAA,EACF;AAAA,EAEA,MAAMC,WAAWV,MAAAA,EAAsC;AACrD,IAAA,IAAA,CAAKA,MAAAA,GAASA,MAAAA;AACd,IAAA,IAAA,CAAKE,SAASF,MAAAA,CAAOE,MAAAA;AACrB,IAAA,IAAA,CAAKC,OAAAA,GAAUH,MAAAA,CAAOG,OAAAA,IAAWH,MAAAA,CAAOI,WAAAA,IAAe,2BAAA;AACvD,IAAA,IAAA,CAAKC,KAAAA,GAAQL,OAAOK,KAAAA,IAAS,eAAA;AAAA,EAC/B;AAAA,EAEAM,cAAAA,GAA0B;AACxB,IAAA,OAAO,CAAC,CAAC,IAAA,CAAKT,MAAAA,IAAU,CAAC,CAAC,IAAA,CAAKG,KAAAA;AAAAA,EACjC;AAAA,EAEAO,OAAAA,GAAgB;AAAA,EACd;AAAA,EAGF,MAAMC,QAAQA,OAAAA,EAAyC;AACrD,IAAA,IAAI;AACF,MAAA,MAAMC,WAAW,MAAMC,KAAAA,CAAM,CAAA,EAAG,IAAA,CAAKZ,OAAO,CAAA,iBAAA,CAAA,EAAqB;AAAA,QAC/Da,MAAAA,EAAQ,MAAA;AAAA,QACRC,OAAAA,EAAS;AAAA,UACP,cAAA,EAAgB,kBAAA;AAAA,UAChB,eAAA,EAAiB,CAAA,OAAA,EAAU,IAAA,CAAKf,MAAM,CAAA;AAAA,SACxC;AAAA,QACAgB,IAAAA,EAAMC,KAAKC,SAAAA,CAAU;AAAA,UACnBf,KAAAA,EAAOQ,OAAAA,CAAQR,KAAAA,IAAS,IAAA,CAAKA,KAAAA;AAAAA,UAC7BgB,UAAU,CACR;AAAA,YAAEC,IAAAA,EAAM,QAAA;AAAA,YAAUC,OAAAA,EAASV,QAAQW,YAAAA,IAAgB;AAAA,WAAuC,EAC1F;AAAA,YAAEF,IAAAA,EAAM,MAAA;AAAA,YAAQC,SAASV,OAAAA,CAAQY;AAAAA,WAAQ,CAAA;AAAA,UAE3ClB,WAAAA,EAAaM,OAAAA,CAAQN,WAAAA,IAAe,IAAA,CAAKD,aAAAA,CAAcC,WAAAA;AAAAA,UACvDmB,UAAAA,EAAYb,OAAAA,CAAQL,SAAAA,IAAa,IAAA,CAAKF,aAAAA,CAAcE,SAAAA;AAAAA,UACpDmB,KAAAA,EAAOd,OAAAA,CAAQJ,IAAAA,IAAQ,IAAA,CAAKH,aAAAA,CAAcG,IAAAA;AAAAA,UAC1CmB,MAAAA,EAAQf,QAAQe,MAAAA,IAAU;AAAA,SAC3B;AAAA,OACF,CAAA;AAED,MAAA,IAAI,CAACd,SAASe,EAAAA,EAAI;AAChB,QAAA,MAAMC,KAAAA,GAAQ,MAAMhB,QAAAA,CAASiB,IAAAA,EAAK;AAClC,QAAA,MAAM,IAAIC,KAAAA,CAAMF,KAAAA,CAAMA,KAAAA,EAAOG,WAAW,2BAA2B,CAAA;AAAA,MACrE;AAEA,MAAA,MAAMC,IAAAA,GAAO,MAAMpB,QAAAA,CAASiB,IAAAA,EAAK;AAEjC,MAAA,OAAO;AAAA,QACLI,OAAAA,EAAS,IAAA;AAAA,QACTZ,SAASW,IAAAA,CAAKE,OAAAA,CAAQ,CAAC,CAAA,EAAGH,SAASV,OAAAA,IAAW,EAAA;AAAA,QAC9Cc,MAAMH,IAAAA,CAAKE,OAAAA,CAAQ,CAAC,CAAA,EAAGH,SAASV,OAAAA,IAAW,EAAA;AAAA,QAC3Ce,KAAAA,EAAO;AAAA,UACLC,YAAAA,EAAcL,IAAAA,CAAKI,KAAAA,EAAOE,aAAAA,IAAiB,CAAA;AAAA,UAC3CC,gBAAAA,EAAkBP,IAAAA,CAAKI,KAAAA,EAAOI,iBAAAA,IAAqB,CAAA;AAAA,UACnDC,WAAAA,EAAaT,IAAAA,CAAKI,KAAAA,EAAOM,YAAAA,IAAgB;AAAA;AAC3C,OACF;AAAA,IACF,SACOd,KAAAA,EAAO;AACZe,MAAAA,OAAAA,CAAQf,KAAAA,CAAM,0BAA0BA,KAAK,CAAA;AAC7C,MAAA,OAAO;AAAA,QACLK,OAAAA,EAAS,KAAA;AAAA,QACTL,KAAAA,EAAOA,KAAAA,YAAiBE,KAAAA,GAAQF,KAAAA,CAAMG,OAAAA,GAAU;AAAA,OAClD;AAAA,IACF;AAAA,EACF;AAAA,EAEA,MAAML,MAAAA,CAAOf,OAAAA,EAAoBiC,OAAAA,EAAiD;AAChF,IAAA,IAAI;AACF,MAAA,MAAMhC,WAAW,MAAMC,KAAAA,CAAM,CAAA,EAAG,IAAA,CAAKZ,OAAO,CAAA,iBAAA,CAAA,EAAqB;AAAA,QAC/Da,MAAAA,EAAQ,MAAA;AAAA,QACRC,OAAAA,EAAS;AAAA,UACP,cAAA,EAAgB,kBAAA;AAAA,UAChB,eAAA,EAAiB,CAAA,OAAA,EAAU,IAAA,CAAKf,MAAM,CAAA;AAAA,SACxC;AAAA,QACAgB,IAAAA,EAAMC,KAAKC,SAAAA,CAAU;AAAA,UACnBf,KAAAA,EAAOQ,OAAAA,CAAQR,KAAAA,IAAS,IAAA,CAAKA,KAAAA;AAAAA,UAC7BgB,UAAU,CACR;AAAA,YAAEC,IAAAA,EAAM,QAAA;AAAA,YAAUC,OAAAA,EAASV,QAAQW,YAAAA,IAAgB;AAAA,WAAuC,EAC1F;AAAA,YAAEF,IAAAA,EAAM,MAAA;AAAA,YAAQC,SAASV,OAAAA,CAAQY;AAAAA,WAAQ,CAAA;AAAA,UAE3ClB,WAAAA,EAAaM,OAAAA,CAAQN,WAAAA,IAAe,IAAA,CAAKD,aAAAA,CAAcC,WAAAA;AAAAA,UACvDmB,UAAAA,EAAYb,OAAAA,CAAQL,SAAAA,IAAa,IAAA,CAAKF,aAAAA,CAAcE,SAAAA;AAAAA,UACpDoB,MAAAA,EAAQ;AAAA,SACT;AAAA,OACF,CAAA;AAED,MAAA,IAAI,CAACd,QAAAA,CAASe,EAAAA;AACZ,QAAA,MAAM,IAAIG,MAAM,iCAAiC,CAAA;AAEnD,MAAA,MAAMe,MAAAA,GAASjC,QAAAA,CAASI,IAAAA,EAAM8B,SAAAA,EAAU;AACxC,MAAA,MAAMC,OAAAA,GAAU,IAAIC,WAAAA,EAAY;AAEhC,MAAA,IAAI,CAACH,MAAAA;AACH,QAAA,MAAM,IAAIf,MAAM,qBAAqB,CAAA;AAEvC,MAAA,OAAO,IAAA,EAAM;AACX,QAAA,MAAM;AAAA,UAAEmB,IAAAA;AAAAA,UAAMC;AAAAA,SAAM,GAAI,MAAML,MAAAA,CAAOM,IAAAA,EAAK;AAC1C,QAAA,IAAIF,IAAAA;AACF,UAAA;AAEF,QAAA,MAAMG,KAAAA,GAAQL,OAAAA,CAAQM,MAAAA,CAAOH,KAAK,CAAA;AAClC,QAAA,MAAMI,KAAAA,GAAQF,KAAAA,CAAMG,KAAAA,CAAM,IAAI,CAAA,CAAEC,OAAOC,CAAAA,IAAAA,KAAQA,IAAAA,CAAKC,IAAAA,EAAK,KAAM,EAAE,CAAA;AAEjE,QAAA,KAAA,MAAWD,QAAQH,KAAAA,EAAO;AACxB,UAAA,IAAIG,IAAAA,CAAKE,UAAAA,CAAW,QAAQ,CAAA,EAAG;AAC7B,YAAA,MAAM3B,IAAAA,GAAOyB,IAAAA,CAAKG,KAAAA,CAAM,CAAC,CAAA;AACzB,YAAA,IAAI5B,IAAAA,KAAS,QAAA;AACX,cAAA;AAEF,YAAA,IAAI;AACF,cAAA,MAAMH,IAAAA,GAAOZ,IAAAA,CAAK4C,KAAAA,CAAM7B,IAAI,CAAA;AAC5B,cAAA,MAAMX,OAAAA,GAAUQ,IAAAA,CAAKK,OAAAA,CAAQ,CAAC,GAAG4B,KAAAA,EAAOzC,OAAAA;AACxC,cAAA,IAAIA,OAAAA;AACFuB,gBAAAA,OAAAA,CAAQvB,OAAO,CAAA;AAAA,YACnB,SACO0C,CAAAA,EAAG;AACRpB,cAAAA,OAAAA,CAAQqB,IAAAA,CAAK,6BAA6BD,CAAC,CAAA;AAAA,YAC7C;AAAA,UACF;AAAA,QACF;AAAA,MACF;AAAA,IACF,SACOnC,KAAAA,EAAO;AACZe,MAAAA,OAAAA,CAAQf,KAAAA,CAAM,4BAA4BA,KAAK,CAAA;AAC/C,MAAA,MAAMA,KAAAA;AAAAA,IACR;AAAA,EACF;AAAA,EAEAqC,kBAAAA,GAA+B;AAC7B,IAAA,OAAO,CACL,OAAA,EACA,qBAAA,EACA,WAAA,EACA,iBACA,mBAAmB,CAAA;AAAA,EAEvB;AACF;;;;;;;"}