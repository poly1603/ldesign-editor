{"version":3,"file":"PluginRegistry.js","sources":["../../src/core/PluginRegistry.ts"],"sourcesContent":["/**\r\n * 插件注册中心\r\n * 支持插件的按需加载、配置管理和生命周期管理\r\n */\r\n\r\nimport type { Editor } from './Editor'\r\nimport type { Plugin } from './Plugin'\r\nimport { EventEmitter } from './EventEmitter'\r\n\r\n/**\r\n * 插件配置接口\r\n */\r\nexport interface PluginConfig {\r\n  enabled: boolean\r\n  priority?: number\r\n  lazy?: boolean\r\n  dependencies?: string[]\r\n  config?: Record<string, any>\r\n}\r\n\r\n/**\r\n * 插件元数据\r\n */\r\nexport interface PluginMetadata {\r\n  name: string\r\n  version?: string\r\n  description?: string\r\n  author?: string\r\n  category?: PluginCategory\r\n  tags?: string[]\r\n}\r\n\r\n/**\r\n * 插件分类\r\n */\r\nexport enum PluginCategory {\r\n  FORMAT = 'format',\r\n  BLOCK = 'block',\r\n  INLINE = 'inline',\r\n  MEDIA = 'media',\r\n  TOOL = 'tool',\r\n  AI = 'ai',\r\n  OTHER = 'other',\r\n}\r\n\r\n/**\r\n * 插件加载器类型\r\n */\r\nexport type PluginLoader = () => Promise<Plugin> | Plugin\r\n\r\n/**\r\n * 插件注册信息\r\n */\r\ninterface PluginRegistration {\r\n  metadata: PluginMetadata\r\n  config: PluginConfig\r\n  loader: PluginLoader\r\n  instance?: Plugin\r\n  loaded: boolean\r\n  loading: boolean\r\n  error?: Error\r\n}\r\n\r\n/**\r\n * 插件注册中心类\r\n */\r\nexport class PluginRegistry extends EventEmitter {\r\n  private registry: Map<string, PluginRegistration> = new Map()\r\n  private editor?: Editor\r\n  private loadedPlugins: Set<string> = new Set()\r\n\r\n  constructor() {\r\n    super()\r\n  }\r\n\r\n  /**\r\n   * 设置编辑器实例\r\n   */\r\n  setEditor(editor: Editor): void {\r\n    this.editor = editor\r\n  }\r\n\r\n  /**\r\n   * 注册插件\r\n   */\r\n  register(\r\n    name: string,\r\n    loader: PluginLoader,\r\n    metadata: Partial<PluginMetadata> = {},\r\n    config: Partial<PluginConfig> = {},\r\n  ): void {\r\n    if (this.registry.has(name)) {\r\n      console.warn(`Plugin \"${name}\" is already registered`)\r\n      return\r\n    }\r\n\r\n    const registration: PluginRegistration = {\r\n      metadata: {\r\n        name,\r\n        ...metadata,\r\n      },\r\n      config: {\r\n        enabled: true,\r\n        lazy: false,\r\n        priority: 0,\r\n        ...config,\r\n      },\r\n      loader,\r\n      loaded: false,\r\n      loading: false,\r\n    }\r\n\r\n    this.registry.set(name, registration)\r\n    this.emit('plugin:registered', { name, metadata, config })\r\n  }\r\n\r\n  /**\r\n   * 批量注册插件\r\n   */\r\n  registerBatch(plugins: Array<{\r\n    name: string\r\n    loader: PluginLoader\r\n    metadata?: Partial<PluginMetadata>\r\n    config?: Partial<PluginConfig>\r\n  }>): void {\r\n    plugins.forEach(({ name, loader, metadata, config }) => {\r\n      this.register(name, loader, metadata, config)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 加载插件\r\n   */\r\n  async load(name: string): Promise<Plugin | null> {\r\n    const registration = this.registry.get(name)\r\n\r\n    if (!registration) {\r\n      console.error(`Plugin \"${name}\" not found`)\r\n      return null\r\n    }\r\n\r\n    if (!registration.config.enabled) {\r\n      console.log(`Plugin \"${name}\" is disabled`)\r\n      return null\r\n    }\r\n\r\n    if (registration.loaded && registration.instance)\r\n      return registration.instance\r\n\r\n    if (registration.loading) {\r\n      // 等待加载完成\r\n      return new Promise((resolve) => {\r\n        const checkLoaded = () => {\r\n          if (registration.loaded) {\r\n            this.off('plugin:loaded', checkLoaded)\r\n            resolve(registration.instance || null)\r\n          }\r\n        }\r\n        this.on('plugin:loaded', checkLoaded)\r\n      })\r\n    }\r\n\r\n    // 检查依赖\r\n    if (registration.config.dependencies) {\r\n      for (const dep of registration.config.dependencies) {\r\n        if (!this.isLoaded(dep))\r\n          await this.load(dep)\r\n      }\r\n    }\r\n\r\n    registration.loading = true\r\n    this.emit('plugin:loading', { name })\r\n\r\n    try {\r\n      const plugin = await registration.loader()\r\n\r\n      if (!this.editor)\r\n        throw new Error('Editor instance not set')\r\n\r\n      // 应用插件配置\r\n      if (registration.config.config && plugin.config)\r\n        Object.assign(plugin.config, registration.config.config)\r\n\r\n      // 初始化插件\r\n      if (plugin.init)\r\n        await plugin.init(this.editor)\r\n\r\n      registration.instance = plugin\r\n      registration.loaded = true\r\n      registration.loading = false\r\n      this.loadedPlugins.add(name)\r\n\r\n      this.emit('plugin:loaded', { name, plugin })\r\n\r\n      return plugin\r\n    }\r\n    catch (error) {\r\n      registration.error = error as Error\r\n      registration.loading = false\r\n      this.emit('plugin:error', { name, error })\r\n      console.error(`Failed to load plugin \"${name}\":`, error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 批量加载插件\r\n   */\r\n  async loadBatch(names: string[]): Promise<Array<Plugin | null>> {\r\n    // 按优先级排序\r\n    const sorted = names\r\n      .map(name => ({ name, priority: this.registry.get(name)?.config.priority || 0 }))\r\n      .sort((a, b) => b.priority - a.priority)\r\n      .map(item => item.name)\r\n\r\n    return Promise.all(sorted.map(name => this.load(name)))\r\n  }\r\n\r\n  /**\r\n   * 卸载插件\r\n   */\r\n  async unload(name: string): Promise<void> {\r\n    const registration = this.registry.get(name)\r\n\r\n    if (!registration || !registration.loaded || !registration.instance)\r\n      return\r\n\r\n    try {\r\n      // 调用销毁方法\r\n      if (registration.instance.destroy)\r\n        await registration.instance.destroy()\r\n\r\n      registration.loaded = false\r\n      registration.instance = undefined\r\n      this.loadedPlugins.delete(name)\r\n\r\n      this.emit('plugin:unloaded', { name })\r\n    }\r\n    catch (error) {\r\n      console.error(`Failed to unload plugin \"${name}\":`, error)\r\n      this.emit('plugin:error', { name, error })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 启用插件\r\n   */\r\n  async enable(name: string): Promise<void> {\r\n    const registration = this.registry.get(name)\r\n\r\n    if (!registration) {\r\n      console.error(`Plugin \"${name}\" not found`)\r\n      return\r\n    }\r\n\r\n    registration.config.enabled = true\r\n    this.emit('plugin:enabled', { name })\r\n\r\n    // 如果不是懒加载，立即加载\r\n    if (!registration.config.lazy)\r\n      await this.load(name)\r\n  }\r\n\r\n  /**\r\n   * 禁用插件\r\n   */\r\n  async disable(name: string): Promise<void> {\r\n    const registration = this.registry.get(name)\r\n\r\n    if (!registration) {\r\n      console.error(`Plugin \"${name}\" not found`)\r\n      return\r\n    }\r\n\r\n    registration.config.enabled = false\r\n\r\n    // 如果已加载，卸载它\r\n    if (registration.loaded)\r\n      await this.unload(name)\r\n\r\n    this.emit('plugin:disabled', { name })\r\n  }\r\n\r\n  /**\r\n   * 更新插件配置\r\n   */\r\n  updateConfig(name: string, config: Partial<PluginConfig>): void {\r\n    const registration = this.registry.get(name)\r\n\r\n    if (!registration) {\r\n      console.error(`Plugin \"${name}\" not found`)\r\n      return\r\n    }\r\n\r\n    Object.assign(registration.config, config)\r\n\r\n    // 如果插件已加载，更新实例配置\r\n    if (registration.instance && registration.instance.config)\r\n      Object.assign(registration.instance.config, config.config || {})\r\n\r\n    this.emit('plugin:config-updated', { name, config })\r\n  }\r\n\r\n  /**\r\n   * 获取插件配置\r\n   */\r\n  getConfig(name: string): PluginConfig | null {\r\n    return this.registry.get(name)?.config || null\r\n  }\r\n\r\n  /**\r\n   * 获取插件元数据\r\n   */\r\n  getMetadata(name: string): PluginMetadata | null {\r\n    return this.registry.get(name)?.metadata || null\r\n  }\r\n\r\n  /**\r\n   * 获取插件实例\r\n   */\r\n  getInstance(name: string): Plugin | null {\r\n    return this.registry.get(name)?.instance || null\r\n  }\r\n\r\n  /**\r\n   * 检查插件是否已注册\r\n   */\r\n  isRegistered(name: string): boolean {\r\n    return this.registry.has(name)\r\n  }\r\n\r\n  /**\r\n   * 检查插件是否已加载\r\n   */\r\n  isLoaded(name: string): boolean {\r\n    return this.loadedPlugins.has(name)\r\n  }\r\n\r\n  /**\r\n   * 检查插件是否已启用\r\n   */\r\n  isEnabled(name: string): boolean {\r\n    return this.registry.get(name)?.config.enabled || false\r\n  }\r\n\r\n  /**\r\n   * 获取所有注册的插件名称\r\n   */\r\n  getRegistered(): string[] {\r\n    return Array.from(this.registry.keys())\r\n  }\r\n\r\n  /**\r\n   * 获取所有已加载的插件名称\r\n   */\r\n  getLoaded(): string[] {\r\n    return Array.from(this.loadedPlugins)\r\n  }\r\n\r\n  /**\r\n   * 获取所有启用的插件名称\r\n   */\r\n  getEnabled(): string[] {\r\n    return Array.from(this.registry.entries())\r\n      .filter(([_, reg]) => reg.config.enabled)\r\n      .map(([name]) => name)\r\n  }\r\n\r\n  /**\r\n   * 按分类获取插件\r\n   */\r\n  getByCategory(category: PluginCategory): string[] {\r\n    return Array.from(this.registry.entries())\r\n      .filter(([_, reg]) => reg.metadata.category === category)\r\n      .map(([name]) => name)\r\n  }\r\n\r\n  /**\r\n   * 获取插件统计信息\r\n   */\r\n  getStats(): {\r\n    total: number\r\n    loaded: number\r\n    enabled: number\r\n    disabled: number\r\n    errors: number\r\n  } {\r\n    const registrations = Array.from(this.registry.values())\r\n\r\n    return {\r\n      total: registrations.length,\r\n      loaded: this.loadedPlugins.size,\r\n      enabled: registrations.filter(r => r.config.enabled).length,\r\n      disabled: registrations.filter(r => !r.config.enabled).length,\r\n      errors: registrations.filter(r => r.error).length,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 导出配置\r\n   */\r\n  exportConfig(): Record<string, Partial<PluginConfig>> {\r\n    const config: Record<string, Partial<PluginConfig>> = {}\r\n\r\n    this.registry.forEach((reg, name) => {\r\n      config[name] = {\r\n        enabled: reg.config.enabled,\r\n        priority: reg.config.priority,\r\n        lazy: reg.config.lazy,\r\n        config: reg.config.config,\r\n      }\r\n    })\r\n\r\n    return config\r\n  }\r\n\r\n  /**\r\n   * 导入配置\r\n   */\r\n  importConfig(config: Record<string, Partial<PluginConfig>>): void {\r\n    Object.entries(config).forEach(([name, pluginConfig]) => {\r\n      if (this.registry.has(name))\r\n        this.updateConfig(name, pluginConfig)\r\n    })\r\n\r\n    this.emit('plugins:config-imported', config)\r\n  }\r\n\r\n  /**\r\n   * 重置所有配置\r\n   */\r\n  reset(): void {\r\n    this.registry.forEach((reg) => {\r\n      reg.config.enabled = true\r\n      reg.config.priority = 0\r\n      reg.config.lazy = false\r\n      reg.config.config = {}\r\n    })\r\n\r\n    this.emit('plugins:reset')\r\n  }\r\n\r\n  /**\r\n   * 清理所有插件\r\n   */\r\n  async destroy(): Promise<void> {\r\n    const loaded = Array.from(this.loadedPlugins)\r\n\r\n    for (const name of loaded)\r\n      await this.unload(name)\r\n\r\n    this.registry.clear()\r\n    this.loadedPlugins.clear()\r\n    this.removeAllListeners()\r\n  }\r\n}\r\n\r\n// 全局单例\r\nlet globalRegistry: PluginRegistry | null = null\r\n\r\n/**\r\n * 获取全局插件注册中心\r\n */\r\nexport function getPluginRegistry(): PluginRegistry {\r\n  if (!globalRegistry)\r\n    globalRegistry = new PluginRegistry()\r\n\r\n  return globalRegistry\r\n}\r\n\r\n/**\r\n * 重置全局插件注册中心\r\n */\r\nexport function resetPluginRegistry(): void {\r\n  if (globalRegistry) {\r\n    globalRegistry.destroy()\r\n    globalRegistry = null\r\n  }\r\n}\r\n"],"names":["PluginCategory","FORMAT","BLOCK","INLINE","MEDIA","TOOL","AI","OTHER","PluginRegistry","EventEmitter","constructor","registry","Map","loadedPlugins","Set","setEditor","editor","register","name","loader","metadata","config","has","console","warn","registration","enabled","lazy","priority","loaded","loading","set","emit","registerBatch","plugins","forEach","load","get","error","log","instance","Promise","resolve","checkLoaded","off","on","dependencies","dep","isLoaded","plugin","Error","Object","assign","init","add","loadBatch","names","sorted","map","sort","a","b","item","all","unload","destroy","undefined","delete","enable","disable","updateConfig","getConfig","getMetadata","getInstance","isRegistered","isEnabled","getRegistered","Array","from","keys","getLoaded","getEnabled","entries","filter","_","reg","getByCategory","category","getStats","registrations","values","total","length","size","r","disabled","errors","exportConfig","importConfig","pluginConfig","reset","clear","removeAllListeners","globalRegistry","getPluginRegistry","resetPluginRegistry"],"mappings":"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"}