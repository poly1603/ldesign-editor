{"version":3,"file":"ClaudeProvider.js","sources":["../../../src/ai/providers/ClaudeProvider.ts"],"sourcesContent":["/**\r\n * Claude (Anthropic) 提供商\r\n * 支持 Claude 3 系列模型\r\n */\r\n\r\nimport type { AIModelConfig, AIProvider, AIProviderInterface, AIRequest, AIResponse } from '../types'\r\n\r\nexport class ClaudeProvider implements AIProviderInterface {\r\n  name: AIProvider = 'claude'\r\n  config: AIModelConfig\r\n  private apiKey: string\r\n  private baseURL: string\r\n  private model: string\r\n  private defaultConfig: Partial<AIModelConfig>\r\n\r\n  constructor(config: AIModelConfig) {\r\n    this.config = config\r\n    this.apiKey = config.apiKey\r\n    this.baseURL = config.baseURL || config.apiEndpoint || 'https://api.anthropic.com/v1'\r\n    this.model = config.model || 'claude-3-sonnet-20240229'\r\n    this.defaultConfig = {\r\n      temperature: 0.7,\r\n      maxTokens: 4000,\r\n      topP: 1,\r\n    }\r\n  }\r\n\r\n  async initialize(config: AIModelConfig): Promise<void> {\r\n    this.config = config\r\n    this.apiKey = config.apiKey\r\n    this.baseURL = config.baseURL || config.apiEndpoint || 'https://api.anthropic.com/v1'\r\n    this.model = config.model || 'claude-3-sonnet-20240229'\r\n  }\r\n\r\n  validateConfig(): boolean {\r\n    return !!this.apiKey && !!this.model\r\n  }\r\n\r\n  cleanup(): void {\r\n    // No cleanup needed\r\n  }\r\n\r\n  async request(request: AIRequest): Promise<AIResponse> {\r\n    try {\r\n      const response = await fetch(`${this.baseURL}/messages`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'x-api-key': this.apiKey,\r\n          'anthropic-version': '2023-06-01',\r\n        },\r\n        body: JSON.stringify({\r\n          model: request.model || this.model,\r\n          messages: [\r\n            { role: 'user', content: request.prompt },\r\n          ],\r\n          system: request.systemPrompt || 'You are a helpful writing assistant.',\r\n          temperature: request.temperature || this.defaultConfig.temperature,\r\n          max_tokens: request.maxTokens || this.defaultConfig.maxTokens,\r\n          top_p: request.topP || this.defaultConfig.topP,\r\n          stream: request.stream || false,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const error = await response.json()\r\n        throw new Error(error.error?.message || 'Claude API request failed')\r\n      }\r\n\r\n      const data = await response.json()\r\n\r\n      return {\r\n        success: true,\r\n        content: data.content[0]?.text || '',\r\n        text: data.content[0]?.text || '',\r\n        usage: {\r\n          promptTokens: data.usage?.input_tokens || 0,\r\n          completionTokens: data.usage?.output_tokens || 0,\r\n          totalTokens: (data.usage?.input_tokens || 0) + (data.usage?.output_tokens || 0),\r\n        },\r\n      }\r\n    }\r\n    catch (error) {\r\n      console.error('Claude request failed:', error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n      }\r\n    }\r\n  }\r\n\r\n  async stream(request: AIRequest, onChunk: (chunk: string) => void): Promise<void> {\r\n    try {\r\n      const response = await fetch(`${this.baseURL}/messages`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'x-api-key': this.apiKey,\r\n          'anthropic-version': '2023-06-01',\r\n        },\r\n        body: JSON.stringify({\r\n          model: request.model || this.model,\r\n          messages: [\r\n            { role: 'user', content: request.prompt },\r\n          ],\r\n          system: request.systemPrompt || 'You are a helpful writing assistant.',\r\n          temperature: request.temperature || this.defaultConfig.temperature,\r\n          max_tokens: request.maxTokens || this.defaultConfig.maxTokens,\r\n          stream: true,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok)\r\n        throw new Error('Claude streaming request failed')\r\n\r\n      const reader = response.body?.getReader()\r\n      const decoder = new TextDecoder()\r\n\r\n      if (!reader)\r\n        throw new Error('No reader available')\r\n\r\n      while (true) {\r\n        const { done, value } = await reader.read()\r\n        if (done)\r\n          break\r\n\r\n        const chunk = decoder.decode(value)\r\n        const lines = chunk.split('\\n').filter(line => line.trim() !== '')\r\n\r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            const data = line.slice(6)\r\n\r\n            try {\r\n              const json = JSON.parse(data)\r\n\r\n              if (json.type === 'content_block_delta') {\r\n                const content = json.delta?.text\r\n                if (content)\r\n                  onChunk(content)\r\n              }\r\n            }\r\n            catch (e) {\r\n              console.warn('Failed to parse SSE data:', e)\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    catch (error) {\r\n      console.error('Claude streaming failed:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  getSupportedModels(): string[] {\r\n    return [\r\n      'claude-3-opus-20240229',\r\n      'claude-3-sonnet-20240229',\r\n      'claude-3-haiku-20240307',\r\n      'claude-2.1',\r\n      'claude-2.0',\r\n    ]\r\n  }\r\n}\r\n"],"names":["ClaudeProvider","constructor","config","name","apiKey","baseURL","apiEndpoint","model","defaultConfig","temperature","maxTokens","topP","initialize","validateConfig","cleanup","request","response","fetch","method","headers","body","JSON","stringify","messages","role","content","prompt","system","systemPrompt","max_tokens","top_p","stream","ok","error","json","Error","message","data","success","text","usage","promptTokens","input_tokens","completionTokens","output_tokens","totalTokens","console","onChunk","reader","getReader","decoder","TextDecoder","done","value","read","chunk","decode","lines","split","filter","line","trim","startsWith","slice","parse","type","delta","e","warn","getSupportedModels"],"mappings":"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"}