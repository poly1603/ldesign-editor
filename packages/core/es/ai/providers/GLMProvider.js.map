{"version":3,"file":"GLMProvider.js","sources":["../../../src/ai/providers/GLMProvider.ts"],"sourcesContent":["/**\r\n * 智谱清言（GLM）提供商\r\n */\r\n\r\nimport type {\r\n  AIModelConfig,\r\n  AIProviderInterface,\r\n  AIRequest,\r\n  AIResponse,\r\n} from '../types'\r\nimport { createLogger } from '../../utils/logger'\r\n\r\nconst logger = createLogger('GLMProvider')\r\n\r\nexport class GLMProvider implements AIProviderInterface {\r\n  name = 'glm' as const\r\n  config: AIModelConfig\r\n\r\n  constructor(config: AIModelConfig) {\r\n    this.config = {\r\n      ...config,\r\n      provider: 'glm',\r\n      model: config.model || 'glm-4',\r\n      apiEndpoint: config.apiEndpoint || 'https://open.bigmodel.cn/api/paas/v4/chat/completions',\r\n    }\r\n  }\r\n\r\n  async initialize(config: AIModelConfig): Promise<void> {\r\n    this.config = { ...this.config, ...config }\r\n  }\r\n\r\n  async request(request: AIRequest): Promise<AIResponse> {\r\n    try {\r\n      const messages = this.buildMessages(request)\r\n\r\n      const response = await fetch(this.config.apiEndpoint!, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${this.config.apiKey}`,\r\n          'Accept': this.config.stream ? 'text/event-stream' : 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          model: this.config.model,\r\n          messages,\r\n          temperature: this.config.temperature || 0.7,\r\n          top_p: 0.9,\r\n          max_tokens: this.config.maxTokens || 2000,\r\n          stream: this.config.stream || false,\r\n          stop: null,\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text()\r\n        throw new Error(`智谱清言请求失败: ${response.status} - ${error}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n\r\n      if (data.error)\r\n        throw new Error(`智谱清言错误: ${data.error.code} - ${data.error.message}`)\r\n\r\n      // 提取响应内容\r\n      const content = data.choices?.[0]?.message?.content || ''\r\n\r\n      return {\r\n        success: true,\r\n        text: content,\r\n        usage: data.usage\r\n          ? {\r\n            promptTokens: data.usage.prompt_tokens,\r\n            completionTokens: data.usage.completion_tokens,\r\n            totalTokens: data.usage.total_tokens,\r\n          }\r\n          : undefined,\r\n      }\r\n    }\r\n    catch (error) {\r\n      logger.error('智谱清言请求失败:', error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : '未知错误',\r\n      }\r\n    }\r\n  }\r\n\r\n  validateConfig(): boolean {\r\n    if (!this.config.apiKey) {\r\n      logger.error('缺少智谱API密钥')\r\n      return false\r\n    }\r\n    return true\r\n  }\r\n\r\n  cleanup(): void {\r\n    // 清理资源\r\n  }\r\n\r\n  private buildMessages(request: AIRequest): any[] {\r\n    const messages = []\r\n\r\n    // 添加系统消息\r\n    const systemPrompt = this.getSystemPrompt(request.type)\r\n    if (systemPrompt) {\r\n      messages.push({\r\n        role: 'system',\r\n        content: systemPrompt,\r\n      })\r\n    }\r\n\r\n    // 添加用户消息\r\n    messages.push({\r\n      role: 'user',\r\n      content: request.text,\r\n    })\r\n\r\n    return messages\r\n  }\r\n\r\n  private getSystemPrompt(type: AIRequest['type']): string {\r\n    const prompts = {\r\n      correct: '你是一个专业的文本校对专家。请仔细检查并纠正文本中的所有错误，包括：\\n1. 拼写错误\\n2. 语法错误\\n3. 标点符号错误\\n4. 不通顺的表达\\n\\n请直接给出修正后的文本，不需要解释。',\r\n      complete: '你是一个智能写作助手。请根据给定的上下文，自然地完成后续内容。要求：\\n1. 保持语言风格一致\\n2. 内容连贯自然\\n3. 符合逻辑',\r\n      continue: '你是一个创意写作助手。请基于已有内容继续写作。要求：\\n1. 保持故事的连贯性\\n2. 维持相同的写作风格\\n3. 情节发展要合理',\r\n      rewrite: '你是一个资深的文案编辑。请将给定的内容重写，要求：\\n1. 表达更加清晰准确\\n2. 语言更加专业得体\\n3. 结构更加合理\\n4. 保持原意不变',\r\n      suggest: '你是一个专业的内容顾问。请仔细分析给定的内容，并从以下方面提供具体的改进建议：\\n1. 内容结构\\n2. 表达方式\\n3. 逻辑性\\n4. 可读性\\n5. 专业性\\n\\n请以条目形式给出建议。',\r\n    }\r\n    return prompts[type] || '你是一个智能助手，请根据用户需求处理文本内容。'\r\n  }\r\n\r\n  /**\r\n   * 支持的模型列表\r\n   */\r\n  static getSupportedModels() {\r\n    return [\r\n      { id: 'glm-4', name: 'GLM-4', description: '最新一代模型，能力全面提升' },\r\n      { id: 'glm-4-air', name: 'GLM-4-Air', description: '性能与价格平衡的模型' },\r\n      { id: 'glm-4-airx', name: 'GLM-4-AirX', description: '高性价比模型' },\r\n      { id: 'glm-4-flash', name: 'GLM-4-Flash', description: '超快速响应，适合简单任务' },\r\n      { id: 'glm-3-turbo', name: 'GLM-3-Turbo', description: '上一代主力模型，稳定可靠' },\r\n    ]\r\n  }\r\n\r\n  /**\r\n   * 获取模型定价信息\r\n   */\r\n  static getPricing() {\r\n    return {\r\n      'glm-4': { input: 0.1, output: 0.1, unit: '元/千tokens' },\r\n      'glm-4-air': { input: 0.01, output: 0.01, unit: '元/千tokens' },\r\n      'glm-4-airx': { input: 0.01, output: 0.01, unit: '元/千tokens' },\r\n      'glm-4-flash': { input: 0.0001, output: 0.0001, unit: '元/千tokens' },\r\n      'glm-3-turbo': { input: 0.005, output: 0.005, unit: '元/千tokens' },\r\n    }\r\n  }\r\n}\r\n"],"names":["logger","createLogger","GLMProvider","constructor","config","name","provider","model","apiEndpoint","initialize","request","messages","buildMessages","response","fetch","method","headers","apiKey","stream","body","JSON","stringify","temperature","top_p","max_tokens","maxTokens","stop","ok","error","text","Error","status","data","json","code","message","content","choices","success","usage","promptTokens","prompt_tokens","completionTokens","completion_tokens","totalTokens","total_tokens","undefined","validateConfig","cleanup","systemPrompt","getSystemPrompt","type","push","role","prompts","correct","complete","continue","rewrite","suggest","getSupportedModels","id","description","getPricing","input","output","unit"],"mappings":"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"}