{"version":3,"file":"QwenProvider.js","sources":["../../../src/ai/providers/QwenProvider.ts"],"sourcesContent":["/**\r\n * 阿里通义千问（Qwen）提供商\r\n */\r\n\r\nimport type {\r\n  AIModelConfig,\r\n  AIProviderInterface,\r\n  AIRequest,\r\n  AIResponse,\r\n} from '../types'\r\nimport { createLogger } from '../../utils/logger'\r\n\r\nconst logger = createLogger('QwenProvider')\r\n\r\nexport class QwenProvider implements AIProviderInterface {\r\n  name = 'qwen' as const\r\n  config: AIModelConfig\r\n\r\n  constructor(config: AIModelConfig) {\r\n    this.config = {\r\n      ...config,\r\n      provider: 'qwen',\r\n      model: config.model || 'qwen-turbo',\r\n      apiEndpoint: config.apiEndpoint || 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',\r\n    }\r\n  }\r\n\r\n  async initialize(config: AIModelConfig): Promise<void> {\r\n    this.config = { ...this.config, ...config }\r\n  }\r\n\r\n  async request(request: AIRequest): Promise<AIResponse> {\r\n    try {\r\n      const messages = this.buildMessages(request)\r\n\r\n      const response = await fetch(this.config.apiEndpoint!, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${this.config.apiKey}`,\r\n          'X-DashScope-SSE': this.config.stream ? 'enable' : 'disable',\r\n        },\r\n        body: JSON.stringify({\r\n          model: this.config.model,\r\n          input: {\r\n            messages,\r\n          },\r\n          parameters: {\r\n            temperature: this.config.temperature || 0.7,\r\n            top_p: 0.9,\r\n            max_tokens: this.config.maxTokens || 2000,\r\n            stop: null,\r\n            stream: this.config.stream || false,\r\n            enable_search: false,\r\n            incremental_output: this.config.stream || false,\r\n          },\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const error = await response.text()\r\n        throw new Error(`通义千问请求失败: ${response.status} - ${error}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n\r\n      if (data.code && data.code !== 'Success')\r\n        throw new Error(`通义千问错误: ${data.code} - ${data.message}`)\r\n\r\n      // 处理响应\r\n      const content = data.output?.text || data.output?.choices?.[0]?.message?.content || ''\r\n\r\n      return {\r\n        success: true,\r\n        text: content,\r\n        usage: data.usage\r\n          ? {\r\n            promptTokens: data.usage.input_tokens,\r\n            completionTokens: data.usage.output_tokens,\r\n            totalTokens: data.usage.total_tokens || (data.usage.input_tokens + data.usage.output_tokens),\r\n          }\r\n          : undefined,\r\n      }\r\n    }\r\n    catch (error) {\r\n      logger.error('通义千问请求失败:', error)\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : '未知错误',\r\n      }\r\n    }\r\n  }\r\n\r\n  validateConfig(): boolean {\r\n    if (!this.config.apiKey) {\r\n      logger.error('缺少阿里云API密钥')\r\n      return false\r\n    }\r\n    return true\r\n  }\r\n\r\n  cleanup(): void {\r\n    // 清理资源\r\n  }\r\n\r\n  private buildMessages(request: AIRequest): any[] {\r\n    const messages = []\r\n\r\n    // 添加系统消息\r\n    const systemPrompt = this.getSystemPrompt(request.type)\r\n    if (systemPrompt) {\r\n      messages.push({\r\n        role: 'system',\r\n        content: systemPrompt,\r\n      })\r\n    }\r\n\r\n    // 添加用户消息\r\n    messages.push({\r\n      role: 'user',\r\n      content: request.text,\r\n    })\r\n\r\n    return messages\r\n  }\r\n\r\n  private getSystemPrompt(type: AIRequest['type']): string {\r\n    const prompts = {\r\n      correct: '你是一个专业的文本校对助手。请仔细检查并纠正文本中的所有错误，包括拼写、语法、标点符号和表达问题。保持原意不变，只修正错误。',\r\n      complete: '你是一个智能写作助手。请根据上下文和已有内容，自然地完成后续内容。保持风格和语气的一致性。',\r\n      continue: '你是一个创意写作助手。请基于已有内容，继续创作下去。保持故事的连贯性和风格的一致性。',\r\n      rewrite: '你是一个专业的文案编辑。请重写给定的内容，使其更加清晰、专业、有吸引力。可以调整结构和表达方式，但要保持核心信息不变。',\r\n      suggest: '你是一个资深的内容顾问。请仔细分析给定的内容，并提供具体的改进建议，包括内容结构、表达方式、逻辑性等方面。',\r\n    }\r\n    return prompts[type] || '你是一个智能助手，请帮助用户处理文本内容。'\r\n  }\r\n\r\n  /**\r\n   * 支持的模型列表\r\n   */\r\n  static getSupportedModels() {\r\n    return [\r\n      { id: 'qwen-turbo', name: '通义千问-Turbo', description: '速度更快，成本更低' },\r\n      { id: 'qwen-plus', name: '通义千问-Plus', description: '能力更强，效果更好' },\r\n      { id: 'qwen-max', name: '通义千问-Max', description: '最强大的模型' },\r\n      { id: 'qwen-max-1201', name: '通义千问-Max-1201', description: '支持更长上下文' },\r\n      { id: 'qwen-max-longcontext', name: '通义千问-超长上下文', description: '支持30万字上下文' },\r\n    ]\r\n  }\r\n}\r\n"],"names":["logger","createLogger","QwenProvider","constructor","config","name","provider","model","apiEndpoint","initialize","request","messages","buildMessages","response","fetch","method","headers","apiKey","stream","body","JSON","stringify","input","parameters","temperature","top_p","max_tokens","maxTokens","stop","enable_search","incremental_output","ok","error","text","Error","status","data","json","code","message","content","output","choices","success","usage","promptTokens","input_tokens","completionTokens","output_tokens","totalTokens","total_tokens","undefined","validateConfig","cleanup","systemPrompt","getSystemPrompt","type","push","role","prompts","correct","complete","continue","rewrite","suggest","getSupportedModels","id","description"],"mappings":"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"}