{"version":3,"file":"link.js","sources":["../../../src/plugins/text/link.ts"],"sourcesContent":["/**\r\n * 链接插件\r\n */\r\n\r\nimport type { Command, Plugin } from '../../types'\r\nimport { createPlugin } from '../../core/Plugin'\r\nimport { showUnifiedDialog } from '../../ui/UnifiedDialog'\r\n\r\n/**\r\n * 插入或编辑链接\r\n */\r\nconst toggleLink: Command = (state, dispatch) => {\r\n  if (!dispatch)\r\n    return true\r\n\r\n  const selection = window.getSelection()\r\n  if (!selection || selection.rangeCount === 0)\r\n    return false\r\n\r\n  // 检查当前是否在链接中\r\n  let node = selection.anchorNode\r\n  let linkElement: HTMLAnchorElement | null = null\r\n\r\n  while (node && node !== document.body) {\r\n    if (node.nodeName === 'A') {\r\n      linkElement = node as HTMLAnchorElement\r\n      break\r\n    }\r\n    node = node.parentNode\r\n  }\r\n\r\n  if (linkElement) {\r\n    // 移除链接\r\n    const text = document.createTextNode(linkElement.textContent || '')\r\n    linkElement.parentNode?.replaceChild(text, linkElement)\r\n  }\r\n  else {\r\n    // 获取选中的文本\r\n    const selectedText = selection.toString()\r\n\r\n    // 显示链接对话框\r\n    showUnifiedDialog({\r\n      title: '插入链接',\r\n      width: 500,\r\n      icon: `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n        <path d=\"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71\"></path>\r\n        <path d=\"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71\"></path>\r\n      </svg>`,\r\n      fields: [\r\n        {\r\n          id: 'text',\r\n          type: 'text',\r\n          label: '链接文本',\r\n          placeholder: '请输入链接文本',\r\n          required: !selectedText,\r\n          defaultValue: selectedText,\r\n          disabled: !!selectedText,\r\n        },\r\n        {\r\n          id: 'url',\r\n          type: 'url',\r\n          label: '链接地址',\r\n          placeholder: 'https://example.com',\r\n          required: true,\r\n          helpText: '请输入完整的URL地址，包括 http:// 或 https://',\r\n        },\r\n      ],\r\n      onSubmit: (data) => {\r\n        const text = selectedText || data.text\r\n        const url = data.url\r\n        if (selectedText) {\r\n          // 有选中文本，直接创建链接\r\n          document.execCommand('createLink', false, url)\r\n        }\r\n        else {\r\n          // 没有选中文本，插入新的链接\r\n          const link = document.createElement('a')\r\n          link.href = url\r\n          link.textContent = text\r\n\r\n          const range = selection.getRangeAt(0)\r\n          range.deleteContents()\r\n          range.insertNode(link)\r\n\r\n          // 将光标移到链接后面\r\n          range.setStartAfter(link)\r\n          range.setEndAfter(link)\r\n          selection.removeAllRanges()\r\n          selection.addRange(range)\r\n        }\r\n      },\r\n    })\r\n  }\r\n\r\n  return true\r\n}\r\n\r\n/**\r\n * 检查是否在链接中\r\n */\r\nfunction isLinkActive() {\r\n  return () => {\r\n    const selection = window.getSelection()\r\n    if (!selection || selection.rangeCount === 0)\r\n      return false\r\n\r\n    let node = selection.anchorNode\r\n    while (node && node !== document.body) {\r\n      if (node.nodeName === 'A')\r\n        return true\r\n      node = node.parentNode\r\n    }\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * 链接插件\r\n */\r\nexport const LinkPlugin: Plugin = createPlugin({\r\n  name: 'link',\r\n  commands: {\r\n    toggleLink,\r\n    insertLink: (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n\r\n      const selection = window.getSelection()\r\n      const selectedText = selection?.toString() || ''\r\n\r\n      showUnifiedDialog({\r\n        title: '插入链接',\r\n        width: 500,\r\n        icon: `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n          <path d=\"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71\"></path>\r\n          <path d=\"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71\"></path>\r\n        </svg>`,\r\n        fields: [\r\n          {\r\n            id: 'text',\r\n            type: 'text',\r\n            label: '链接文本',\r\n            placeholder: '请输入链接文本',\r\n            required: !selectedText,\r\n            defaultValue: selectedText,\r\n            disabled: !!selectedText,\r\n          },\r\n          {\r\n            id: 'url',\r\n            type: 'url',\r\n            label: '链接地址',\r\n            placeholder: 'https://example.com',\r\n            required: true,\r\n            helpText: '请输入完整的URL地址，包括 http:// 或 https://',\r\n          },\r\n        ],\r\n        onSubmit: (data) => {\r\n          const text = selectedText || data.text\r\n          const url = data.url\r\n          if (selectedText) {\r\n            // 有选中文本，直接创建链接\r\n            document.execCommand('createLink', false, url)\r\n          }\r\n          else {\r\n            // 没有选中文本，插入新的链接\r\n            const link = document.createElement('a')\r\n            link.href = url\r\n            link.textContent = text\r\n\r\n            if (selection && selection.rangeCount > 0) {\r\n              const range = selection.getRangeAt(0)\r\n              range.deleteContents()\r\n              range.insertNode(link)\r\n\r\n              // 将光标移到链接后面\r\n              range.setStartAfter(link)\r\n              range.setEndAfter(link)\r\n              selection.removeAllRanges()\r\n              selection.addRange(range)\r\n            }\r\n          }\r\n        },\r\n      })\r\n\r\n      return true\r\n    },\r\n    removeLink: (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n      document.execCommand('unlink', false)\r\n      return true\r\n    },\r\n  },\r\n  keys: {\r\n    'Mod-K': toggleLink,\r\n  },\r\n  toolbar: [{\r\n    name: 'link',\r\n    title: '链接',\r\n    icon: 'link',\r\n    command: toggleLink,\r\n    active: isLinkActive(),\r\n  }],\r\n})\r\n"],"names":["toggleLink","state","dispatch","selection","window","getSelection","rangeCount","node","anchorNode","linkElement","document","body","nodeName","parentNode","text","createTextNode","textContent","replaceChild","selectedText","toString","showUnifiedDialog","title","width","icon","fields","id","type","label","placeholder","required","defaultValue","disabled","helpText","onSubmit","data","url","execCommand","link","createElement","href","range","getRangeAt","deleteContents","insertNode","setStartAfter","setEndAfter","removeAllRanges","addRange","isLinkActive","LinkPlugin","createPlugin","name","commands","insertLink","removeLink","keys","toolbar","command","active"],"mappings":"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"}