{"version":3,"file":"formatting.js","sources":["../../../src/plugins/formatting/formatting.ts"],"sourcesContent":["/**\r\n * 基础格式化插件\r\n * 提供粗体、斜体、下划线、删除线等基础格式\r\n */\r\n\r\nimport type { Command, Plugin } from '../../types'\r\nimport { createPlugin } from '../../core/Plugin'\r\n\r\n/**\r\n * 切换标记命令\r\n */\r\nfunction toggleMarkCommand(markType: string): Command {\r\n  return (state, dispatch) => {\r\n    if (!dispatch)\r\n      return true\r\n\r\n    // 简化实现 - 实际需要操作 DOM 和文档模型\r\n    document.execCommand(markType, false)\r\n    return true\r\n  }\r\n}\r\n\r\n/**\r\n * 检查标记是否激活\r\n */\r\nfunction isMarkActive(markType: string) {\r\n  return () => {\r\n    return document.queryCommandState(markType)\r\n  }\r\n}\r\n\r\n/**\r\n * 粗体插件\r\n */\r\nexport const BoldPlugin: Plugin = createPlugin({\r\n  name: 'bold',\r\n  commands: {\r\n    toggleBold: toggleMarkCommand('bold'),\r\n  },\r\n  keys: {\r\n    'Mod-B': toggleMarkCommand('bold'),\r\n  },\r\n  toolbar: [{\r\n    name: 'bold',\r\n    title: '粗体',\r\n    icon: 'bold',\r\n    command: toggleMarkCommand('bold'),\r\n    active: isMarkActive('bold'),\r\n  }],\r\n})\r\n\r\n/**\r\n * 斜体插件\r\n */\r\nexport const ItalicPlugin: Plugin = createPlugin({\r\n  name: 'italic',\r\n  commands: {\r\n    toggleItalic: toggleMarkCommand('italic'),\r\n  },\r\n  keys: {\r\n    'Mod-I': toggleMarkCommand('italic'),\r\n  },\r\n  toolbar: [{\r\n    name: 'italic',\r\n    title: '斜体',\r\n    icon: 'italic',\r\n    command: toggleMarkCommand('italic'),\r\n    active: isMarkActive('italic'),\r\n  }],\r\n})\r\n\r\n/**\r\n * 下划线插件\r\n */\r\nexport const UnderlinePlugin: Plugin = createPlugin({\r\n  name: 'underline',\r\n  commands: {\r\n    toggleUnderline: toggleMarkCommand('underline'),\r\n  },\r\n  keys: {\r\n    'Mod-U': toggleMarkCommand('underline'),\r\n  },\r\n  toolbar: [{\r\n    name: 'underline',\r\n    title: '下划线',\r\n    icon: 'underline',\r\n    command: toggleMarkCommand('underline'),\r\n    active: isMarkActive('underline'),\r\n  }],\r\n})\r\n\r\n/**\r\n * 删除线插件\r\n */\r\nexport const StrikePlugin: Plugin = createPlugin({\r\n  name: 'strike',\r\n  commands: {\r\n    toggleStrike: toggleMarkCommand('strikeThrough'),\r\n  },\r\n  keys: {\r\n    'Mod-Shift-X': toggleMarkCommand('strikeThrough'),\r\n  },\r\n  toolbar: [{\r\n    name: 'strike',\r\n    title: '删除线',\r\n    icon: 'strikethrough',\r\n    command: toggleMarkCommand('strikeThrough'),\r\n    active: isMarkActive('strikeThrough'),\r\n  }],\r\n})\r\n\r\n/**\r\n * 行内代码插件\r\n */\r\nexport const InlineCodePlugin: Plugin = createPlugin({\r\n  name: 'inlineCode',\r\n  commands: {\r\n    toggleInlineCode: (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n\r\n      const selection = window.getSelection()\r\n      if (!selection || selection.rangeCount === 0)\r\n        return false\r\n\r\n      const range = selection.getRangeAt(0)\r\n      const selectedText = range.toString()\r\n\r\n      if (selectedText) {\r\n        // 检查是否已经是代码\r\n        const parent = range.commonAncestorContainer.parentElement\r\n        if (parent && parent.tagName === 'CODE') {\r\n          // 移除代码标记\r\n          const textNode = document.createTextNode(selectedText)\r\n          parent.parentNode?.replaceChild(textNode, parent)\r\n        }\r\n        else {\r\n          // 添加代码标记\r\n          const code = document.createElement('code')\r\n          code.style.cssText = `\r\n            padding: 2px 4px;\r\n            margin: 0 2px;\r\n            background-color: rgba(135, 131, 120, 0.15);\r\n            border-radius: 3px;\r\n            font-size: 85%;\r\n            font-family: \"SFMono-Regular\", Consolas, \"Liberation Mono\", Menlo, Courier, monospace;\r\n          `\r\n          code.textContent = selectedText\r\n          range.deleteContents()\r\n          range.insertNode(code)\r\n\r\n          // 设置光标到代码后面\r\n          const newRange = document.createRange()\r\n          newRange.setStartAfter(code)\r\n          newRange.collapse(true)\r\n          selection.removeAllRanges()\r\n          selection.addRange(newRange)\r\n        }\r\n      }\r\n\r\n      return true\r\n    },\r\n  },\r\n  keys: {\r\n    'Mod-`': (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n      const selection = window.getSelection()\r\n      if (!selection || selection.rangeCount === 0)\r\n        return false\r\n\r\n      const range = selection.getRangeAt(0)\r\n      const selectedText = range.toString()\r\n\r\n      if (selectedText) {\r\n        // 检查是否已经是代码\r\n        const parent = range.commonAncestorContainer.parentElement\r\n        if (parent && parent.tagName === 'CODE') {\r\n          // 移除代码标记\r\n          const textNode = document.createTextNode(selectedText)\r\n          parent.parentNode?.replaceChild(textNode, parent)\r\n        }\r\n        else {\r\n          // 添加代码标记\r\n          document.execCommand('insertHTML', false, `<code style=\"padding: 2px 4px; margin: 0 2px; background-color: rgba(135, 131, 120, 0.15); border-radius: 3px; font-size: 85%; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;\">${selectedText}</code>`)\r\n        }\r\n      }\r\n      return true\r\n    },\r\n  },\r\n  toolbar: [{\r\n    name: 'inlineCode',\r\n    title: '行内代码 (Ctrl+`)',\r\n    icon: 'code',\r\n    command: (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n      const selection = window.getSelection()\r\n      if (!selection || selection.rangeCount === 0)\r\n        return false\r\n\r\n      const range = selection.getRangeAt(0)\r\n      const selectedText = range.toString()\r\n\r\n      if (selectedText) {\r\n        // 检查是否已经是代码\r\n        const parent = range.commonAncestorContainer.parentElement\r\n        if (parent && parent.tagName === 'CODE') {\r\n          // 移除代码标记\r\n          const textNode = document.createTextNode(selectedText)\r\n          parent.parentNode?.replaceChild(textNode, parent)\r\n        }\r\n        else {\r\n          // 添加代码标记\r\n          document.execCommand('insertHTML', false, `<code style=\"padding: 2px 4px; margin: 0 2px; background-color: rgba(135, 131, 120, 0.15); border-radius: 3px; font-size: 85%; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;\">${selectedText}</code>`)\r\n        }\r\n      }\r\n      return true\r\n    },\r\n    active: () => {\r\n      const selection = window.getSelection()\r\n      if (!selection || selection.rangeCount === 0)\r\n        return false\r\n      const parent = selection.getRangeAt(0).commonAncestorContainer.parentElement\r\n      return parent?.tagName === 'CODE'\r\n    },\r\n  }],\r\n})\r\n\r\n// 为了兼容性保留旧的导出名称\r\nexport const CodePlugin = InlineCodePlugin\r\n\r\n/**\r\n * 清除格式插件\r\n */\r\nexport const ClearFormatPlugin: Plugin = createPlugin({\r\n  name: 'clearFormat',\r\n  commands: {\r\n    clearFormat: (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n      document.execCommand('removeFormat', false)\r\n      return true\r\n    },\r\n  },\r\n  keys: {\r\n    'Mod-\\\\': (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n      document.execCommand('removeFormat', false)\r\n      return true\r\n    },\r\n  },\r\n  toolbar: [{\r\n    name: 'clearFormat',\r\n    title: '清除格式',\r\n    icon: 'eraser',\r\n    command: (state, dispatch) => {\r\n      if (!dispatch)\r\n        return true\r\n      document.execCommand('removeFormat', false)\r\n      return true\r\n    },\r\n  }],\r\n})\r\n"],"names":["toggleMarkCommand","markType","state","dispatch","document","execCommand","isMarkActive","queryCommandState","BoldPlugin","createPlugin","name","commands","toggleBold","keys","toolbar","title","icon","command","active","ItalicPlugin","toggleItalic","UnderlinePlugin","toggleUnderline","StrikePlugin","toggleStrike","InlineCodePlugin","toggleInlineCode","selection","window","getSelection","rangeCount","range","getRangeAt","selectedText","toString","parent","commonAncestorContainer","parentElement","tagName","textNode","createTextNode","parentNode","replaceChild","code","createElement","style","cssText","textContent","deleteContents","insertNode","newRange","createRange","setStartAfter","collapse","removeAllRanges","addRange","Mod-`","CodePlugin","ClearFormatPlugin","clearFormat","Mod-\\"],"mappings":"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"}