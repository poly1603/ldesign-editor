{"version":3,"file":"AIPluginV2.js","sources":["../../../src/plugins/ai/AIPluginV2.ts"],"sourcesContent":["/**\r\n * AI Plugin V2 - 简化版本\r\n * 统一的AI功能插件，避免代码重复\r\n */\r\n\r\nimport type { Command, PluginConfig } from '../../types'\r\nimport type { AIDialogType } from '../../ui/AIDialog'\r\nimport { getAIService } from '../../ai/AIService'\r\nimport { createPlugin } from '../../core/Plugin'\r\nimport { showAIConfigDialog } from '../../ui/AIConfigDialog'\r\nimport { AIMockUtils, showAIDialog } from '../../ui/AIDialog'\r\nimport * as EditorUtils from '../../utils/EditorUtils'\r\n\r\n/**\r\n * 创建统一的AI命令\r\n */\r\nfunction createAICommand(type: AIDialogType): Command {\r\n  return (state, dispatch) => {\r\n    console.log(`[AIPlugin] Executing ai-${type} command`)\r\n    const editor = (window as any).editor\r\n    if (!editor)\r\n      return false\r\n\r\n    const aiService = getAIService()\r\n    let selectedText = ''\r\n    let savedRange: Range | null = null\r\n\r\n    // 纠错和重写需要选中文本\r\n    if (type === 'correct' || type === 'rewrite') {\r\n      selectedText = editor.getSelectedText ? editor.getSelectedText() : EditorUtils.getSelectedText()\r\n\r\n      if (!selectedText) {\r\n        alert(`请先选择要${type === 'correct' ? '纠错' : '重写'}的文本`)\r\n        return false\r\n      }\r\n    }\r\n    else if (type === 'complete' || type === 'continue') {\r\n      // 补全和续写：获取上下文\r\n      const sel = window.getSelection()\r\n      if (sel && sel.rangeCount > 0) {\r\n        const range = sel.getRangeAt(0)\r\n        const container = range.commonAncestorContainer\r\n        const textContent = container.textContent || ''\r\n        const offset = range.startOffset\r\n        // 获取光标前的文本作为上下文\r\n        selectedText = textContent.substring(Math.max(0, offset - 100), offset)\r\n      }\r\n    }\r\n\r\n    // 保存选区\r\n    savedRange = EditorUtils.saveRange()\r\n\r\n    // 显示对话框\r\n    const dialogHandle = showAIDialog({\r\n      type,\r\n      originalText: selectedText,\r\n      onConfirm: (text) => {\r\n        // 替换或插入文本\r\n        if (editor.contentElement) {\r\n          editor.contentElement.focus()\r\n          EditorUtils.replaceSelection(text, savedRange)\r\n          editor.handleInput?.()\r\n        }\r\n      },\r\n    })\r\n\r\n    // 处理API调用\r\n    if (!aiService.getConfig().providers.deepseek?.apiKey) {\r\n      // 模拟响应\r\n      setTimeout(() => {\r\n        let mockResult = ''\r\n        switch (type) {\r\n          case 'correct':\r\n            mockResult = AIMockUtils.mockCorrect(selectedText)\r\n            break\r\n          case 'complete':\r\n            mockResult = AIMockUtils.mockComplete(selectedText)\r\n            break\r\n          case 'continue':\r\n            mockResult = AIMockUtils.mockContinue(selectedText)\r\n            break\r\n          case 'rewrite':\r\n            mockResult = AIMockUtils.mockRewrite(selectedText)\r\n            break\r\n        }\r\n        dialogHandle.updateResult(mockResult, selectedText)\r\n      }, 1000)\r\n    }\r\n    else {\r\n      // 真实API调用\r\n      const apiMethod = type === 'correct'\r\n        ? aiService.correct\r\n        : type === 'complete'\r\n          ? aiService.complete\r\n          : type === 'continue'\r\n            ? aiService.continue\r\n            : aiService.rewrite\r\n\r\n      apiMethod.call(aiService, selectedText).then((response: any) => {\r\n        if (response.success && response.text)\r\n          dialogHandle.updateResult(response.text, selectedText)\r\n        else\r\n          dialogHandle.showError(response.error || `AI ${type} 失败`)\r\n      }).catch((error: any) => {\r\n        console.error(`[AIPlugin] AI ${type} failed:`, error)\r\n        dialogHandle.showError(`AI ${type} 请求失败`)\r\n      })\r\n    }\r\n\r\n    return true\r\n  }\r\n}\r\n\r\n// AI插件配置\r\nconst aiPluginConfig: PluginConfig = {\r\n  name: 'ai',\r\n  commands: {\r\n    'ai-correct': createAICommand('correct'),\r\n    'ai-complete': createAICommand('complete'),\r\n    'ai-continue': createAICommand('continue'),\r\n    'ai-rewrite': createAICommand('rewrite'),\r\n    'ai-config': (state, dispatch) => {\r\n      console.log('[AIPlugin] Opening AI config')\r\n      const editor = (window as any).editor\r\n      if (!editor)\r\n        return false\r\n\r\n      const aiService = getAIService()\r\n      showAIConfigDialog(editor, aiService.getConfig(), (config) => {\r\n        aiService.updateConfig(config)\r\n        console.log('[AIPlugin] AI config updated')\r\n      })\r\n      return true\r\n    },\r\n  },\r\n  init(editor) {\r\n    console.log('[AIPlugin] Initializing AI plugin')\r\n\r\n    // 保存 AI 服务实例到编辑器\r\n    const aiService = getAIService()\r\n    ;(editor as any).ai = aiService\r\n\r\n    console.log('[AIPlugin] AI service attached to editor')\r\n    console.log('[AIPlugin] Commands registered:', Object.keys(aiPluginConfig.commands || {}))\r\n  },\r\n}\r\n\r\n// 创建并导出插件\r\nconst AIPlugin = createPlugin(aiPluginConfig)\r\n\r\nexport default AIPlugin\r\n"],"names":["createAICommand","type","state","dispatch","console","log","editor","window","aiService","getAIService","selectedText","savedRange","getSelectedText","EditorUtils","alert","sel","getSelection","rangeCount","range","getRangeAt","container","commonAncestorContainer","textContent","offset","startOffset","substring","Math","max","saveRange","dialogHandle","showAIDialog","originalText","onConfirm","text","contentElement","focus","replaceSelection","handleInput","getConfig","providers","deepseek","apiKey","setTimeout","mockResult","AIMockUtils","mockCorrect","mockComplete","mockContinue","mockRewrite","updateResult","apiMethod","correct","complete","continue","rewrite","call","then","response","success","showError","error","catch","aiPluginConfig","name","commands","ai-config","showAIConfigDialog","config","updateConfig","init","ai","Object","keys","AIPlugin","createPlugin"],"mappings":";;;;;;;;;;;;;;;AAgBA,SAASA,gBAAgBC,IAAAA,EAA6B;AACpD,EAAA,OAAO,CAACC,OAAOC,QAAAA,KAAa;AAC1BC,IAAAA,OAAAA,CAAQC,GAAAA,CAAI,CAAA,wBAAA,EAA2BJ,IAAI,CAAA,QAAA,CAAU,CAAA;AACrD,IAAA,MAAMK,SAAUC,MAAAA,CAAeD,MAAAA;AAC/B,IAAA,IAAI,CAACA,MAAAA;AACH,MAAA,OAAO,KAAA;AAET,IAAA,MAAME,YAAYC,YAAAA,EAAa;AAC/B,IAAA,IAAIC,YAAAA,GAAe,EAAA;AACnB,IAAA,IAAIC,UAAAA,GAA2B,IAAA;AAG/B,IAAA,IAAIV,IAAAA,KAAS,SAAA,IAAaA,IAAAA,KAAS,SAAA,EAAW;AAC5CS,MAAAA,YAAAA,GAAeJ,OAAOM,eAAAA,GAAkBN,MAAAA,CAAOM,eAAAA,EAAgB,GAAIC,eAAYD,EAAgB;AAE/F,MAAA,IAAI,CAACF,YAAAA,EAAc;AACjBI,QAAAA,KAAAA,CAAM,CAAA,8BAAA,EAAQb,IAAAA,KAAS,SAAA,GAAY,cAAA,GAAO,cAAI,CAAA,kBAAA,CAAK,CAAA;AACnD,QAAA,OAAO,KAAA;AAAA,MACT;AAAA,IACF,CAAA,MAAA,IACSA,IAAAA,KAAS,UAAA,IAAcA,IAAAA,KAAS,UAAA,EAAY;AAEnD,MAAA,MAAMc,GAAAA,GAAMR,OAAOS,YAAAA,EAAa;AAChC,MAAA,IAAID,GAAAA,IAAOA,GAAAA,CAAIE,UAAAA,GAAa,CAAA,EAAG;AAC7B,QAAA,MAAMC,KAAAA,GAAQH,GAAAA,CAAII,UAAAA,CAAW,CAAC,CAAA;AAC9B,QAAA,MAAMC,YAAYF,KAAAA,CAAMG,uBAAAA;AACxB,QAAA,MAAMC,WAAAA,GAAcF,UAAUE,WAAAA,IAAe,EAAA;AAC7C,QAAA,MAAMC,SAASL,KAAAA,CAAMM,WAAAA;AAErBd,QAAAA,YAAAA,GAAeY,WAAAA,CAAYG,UAAUC,IAAAA,CAAKC,GAAAA,CAAI,GAAGJ,MAAAA,GAAS,GAAG,GAAGA,MAAM,CAAA;AAAA,MACxE;AAAA,IACF;AAGAZ,IAAAA,UAAAA,GAAaE,SAAYe,EAAU;AAGnC,IAAA,MAAMC,eAAeC,YAAAA,CAAa;AAAA,MAChC7B,IAAAA;AAAAA,MACA8B,YAAAA,EAAcrB,YAAAA;AAAAA,MACdsB,WAAYC,CAAAA,IAAAA,KAAS;AAEnB,QAAA,IAAI3B,OAAO4B,cAAAA,EAAgB;AACzB5B,UAAAA,MAAAA,CAAO4B,eAAeC,KAAAA,EAAM;AAC5BtB,UAAAA,gBAAYuB,CAAiBH,MAAMtB,UAAU,CAAA;AAC7CL,UAAAA,MAAAA,CAAO+B,WAAAA,IAAc;AAAA,QACvB;AAAA,MACF;AAAA,KACD,CAAA;AAGD,IAAA,IAAI,CAAC7B,SAAAA,CAAU8B,SAAAA,EAAU,CAAEC,SAAAA,CAAUC,UAAUC,MAAAA,EAAQ;AAErDC,MAAAA,UAAAA,CAAW,MAAM;AACf,QAAA,IAAIC,UAAAA,GAAa,EAAA;AACjB,QAAA,QAAQ1C,IAAAA;AAAI,UACV,KAAK,SAAA;AACH0C,YAAAA,UAAAA,GAAaC,WAAAA,CAAYC,YAAYnC,YAAY,CAAA;AACjD,YAAA;AAAA,UACF,KAAK,UAAA;AACHiC,YAAAA,UAAAA,GAAaC,WAAAA,CAAYE,aAAapC,YAAY,CAAA;AAClD,YAAA;AAAA,UACF,KAAK,UAAA;AACHiC,YAAAA,UAAAA,GAAaC,WAAAA,CAAYG,aAAarC,YAAY,CAAA;AAClD,YAAA;AAAA,UACF,KAAK,SAAA;AACHiC,YAAAA,UAAAA,GAAaC,WAAAA,CAAYI,YAAYtC,YAAY,CAAA;AACjD,YAAA;AAAA;AAEJmB,QAAAA,YAAAA,CAAaoB,YAAAA,CAAaN,YAAYjC,YAAY,CAAA;AAAA,MACpD,GAAG,GAAI,CAAA;AAAA,IACT,CAAA,MACK;AAEH,MAAA,MAAMwC,SAAAA,GAAYjD,IAAAA,KAAS,SAAA,GACvBO,SAAAA,CAAU2C,OAAAA,GACVlD,IAAAA,KAAS,UAAA,GACPO,SAAAA,CAAU4C,QAAAA,GACVnD,IAAAA,KAAS,UAAA,GACPO,SAAAA,CAAU6C,WACV7C,SAAAA,CAAU8C,OAAAA;AAElBJ,MAAAA,SAAAA,CAAUK,KAAK/C,SAAAA,EAAWE,YAAY,CAAA,CAAE8C,IAAAA,CAAK,CAACC,QAAAA,KAAkB;AAC9D,QAAA,IAAIA,QAAAA,CAASC,WAAWD,QAAAA,CAASxB,IAAAA;AAC/BJ,UAAAA,YAAAA,CAAaoB,YAAAA,CAAaQ,QAAAA,CAASxB,IAAAA,EAAMvB,YAAY,CAAA;AAAA;AAErDmB,UAAAA,YAAAA,CAAa8B,SAAAA,CAAUF,QAAAA,CAASG,KAAAA,IAAS,CAAA,GAAA,EAAM3D,IAAI,CAAA,aAAA,CAAK,CAAA;AAAA,MAC5D,CAAC,CAAA,CAAE4D,KAAAA,CAAM,CAACD,KAAAA,KAAe;AACvBxD,QAAAA,OAAAA,CAAQwD,KAAAA,CAAM,CAAA,cAAA,EAAiB3D,IAAI,CAAA,QAAA,CAAA,EAAY2D,KAAK,CAAA;AACpD/B,QAAAA,YAAAA,CAAa8B,SAAAA,CAAU,CAAA,GAAA,EAAM1D,IAAI,CAAA,yBAAA,CAAO,CAAA;AAAA,MAC1C,CAAC,CAAA;AAAA,IACH;AAEA,IAAA,OAAO,IAAA;AAAA,EACT,CAAA;AACF;AAGA,MAAM6D,cAAAA,GAA+B;AAAA,EACnCC,IAAAA,EAAM,IAAA;AAAA,EACNC,QAAAA,EAAU;AAAA,IACR,YAAA,EAAchE,gBAAgB,SAAS,CAAA;AAAA,IACvC,aAAA,EAAeA,gBAAgB,UAAU,CAAA;AAAA,IACzC,aAAA,EAAeA,gBAAgB,UAAU,CAAA;AAAA,IACzC,YAAA,EAAcA,gBAAgB,SAAS,CAAA;AAAA,IACvC,WAAA,EAAaiE,CAAC/D,KAAAA,EAAOC,QAAAA,KAAa;AAChCC,MAAAA,OAAAA,CAAQC,IAAI,8BAA8B,CAAA;AAC1C,MAAA,MAAMC,SAAUC,MAAAA,CAAeD,MAAAA;AAC/B,MAAA,IAAI,CAACA,MAAAA;AACH,QAAA,OAAO,KAAA;AAET,MAAA,MAAME,YAAYC,YAAAA,EAAa;AAC/ByD,MAAAA,kBAAAA,CAAmB5D,MAAAA,EAAQE,SAAAA,CAAU8B,SAAAA,EAAU,EAAI6B,CAAAA,MAAAA,KAAW;AAC5D3D,QAAAA,SAAAA,CAAU4D,aAAaD,MAAM,CAAA;AAC7B/D,QAAAA,OAAAA,CAAQC,IAAI,8BAA8B,CAAA;AAAA,MAC5C,CAAC,CAAA;AACD,MAAA,OAAO,IAAA;AAAA,IACT;AAAA,GACF;AAAA,EACAgE,KAAK/D,MAAAA,EAAQ;AACXF,IAAAA,OAAAA,CAAQC,IAAI,mCAAmC,CAAA;AAG/C,IAAA,MAAMG,YAAYC,YAAAA,EAAa;AAC9B,IAACH,OAAegE,EAAAA,GAAK9D,SAAAA;AAEtBJ,IAAAA,OAAAA,CAAQC,IAAI,0CAA0C,CAAA;AACtDD,IAAAA,OAAAA,CAAQC,GAAAA,CAAI,mCAAmCkE,MAAAA,CAAOC,IAAAA,CAAKV,eAAeE,QAAAA,IAAY,EAAE,CAAC,CAAA;AAAA,EAC3F;AACF,CAAA;AAGA,MAAMS,QAAAA,GAAWC,aAAaZ,cAAc;;;;;;;"}