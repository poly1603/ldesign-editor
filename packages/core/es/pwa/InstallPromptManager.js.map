{"version":3,"file":"InstallPromptManager.js","sources":["../../src/pwa/InstallPromptManager.ts"],"sourcesContent":["/**\r\n * 安装提示管理器\r\n */\r\n\r\nimport type { PWAConfig } from './types'\r\nimport { EventEmitter } from '../core/EventEmitter'\r\nimport { createLogger } from '../utils/logger'\r\n\r\nconst logger = createLogger('InstallPromptManager')\r\n\r\n// 扩展Window接口\r\ndeclare global {\r\n  interface Window {\r\n    deferredPrompt?: any\r\n  }\r\n}\r\n\r\nexport class InstallPromptManager extends EventEmitter {\r\n  private config: PWAConfig\r\n  private deferredPrompt?: any\r\n  private installed = false\r\n\r\n  constructor(config: PWAConfig) {\r\n    super()\r\n    this.config = config\r\n    this.checkInstallStatus()\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  async initialize(): Promise<void> {\r\n    logger.info('Initializing install prompt manager')\r\n\r\n    // 监听安装提示事件\r\n    window.addEventListener('beforeinstallprompt', (e) => {\r\n      e.preventDefault()\r\n      this.deferredPrompt = e\r\n      logger.info('Install prompt available')\r\n      this.emit('prompt-available')\r\n\r\n      // 自动显示提示\r\n      if (this.config.installPrompt) {\r\n        setTimeout(() => {\r\n          this.show()\r\n        }, 3000) // 3秒后显示\r\n      }\r\n    })\r\n\r\n    // 监听安装完成\r\n    window.addEventListener('appinstalled', () => {\r\n      logger.info('App installed')\r\n      this.installed = true\r\n      this.deferredPrompt = null\r\n      this.emit('installed')\r\n    })\r\n\r\n    logger.info('Install prompt manager initialized')\r\n  }\r\n\r\n  /**\r\n   * 检查安装状态\r\n   */\r\n  private checkInstallStatus(): void {\r\n    // 检查是否在独立模式运行（已安装）\r\n    this.installed\r\n      = window.matchMedia('(display-mode: standalone)').matches\r\n        || (window.navigator as any).standalone === true\r\n\r\n    if (this.installed)\r\n      logger.info('App is already installed')\r\n  }\r\n\r\n  /**\r\n   * 显示安装提示\r\n   */\r\n  async show(): Promise<boolean> {\r\n    if (!this.deferredPrompt) {\r\n      logger.warn('Install prompt not available')\r\n      return false\r\n    }\r\n\r\n    if (this.installed) {\r\n      logger.info('App already installed')\r\n      return false\r\n    }\r\n\r\n    try {\r\n      // 显示提示\r\n      this.deferredPrompt.prompt()\r\n      this.emit('prompt-shown')\r\n\r\n      // 等待用户响应\r\n      const result = await this.deferredPrompt.userChoice\r\n\r\n      if (result.outcome === 'accepted') {\r\n        logger.info('User accepted install prompt')\r\n        return true\r\n      }\r\n      else {\r\n        logger.info('User dismissed install prompt')\r\n        this.emit('dismissed')\r\n        return false\r\n      }\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to show install prompt:', error)\r\n      return false\r\n    }\r\n    finally {\r\n      this.deferredPrompt = null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 是否可以显示提示\r\n   */\r\n  canShowPrompt(): boolean {\r\n    return !!this.deferredPrompt && !this.installed\r\n  }\r\n\r\n  /**\r\n   * 是否已安装\r\n   */\r\n  isInstalled(): boolean {\r\n    return this.installed\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   */\r\n  destroy(): void {\r\n    this.deferredPrompt = null\r\n    this.removeAllListeners()\r\n  }\r\n}\r\n"],"names":["logger","createLogger","InstallPromptManager","EventEmitter","constructor","config","installed","checkInstallStatus","initialize","info","window","addEventListener","e","preventDefault","deferredPrompt","emit","installPrompt","setTimeout","show","matchMedia","matches","navigator","standalone","warn","prompt","result","userChoice","outcome","error","canShowPrompt","isInstalled","destroy","removeAllListeners"],"mappings":"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"}