{"version":3,"file":"ServiceWorkerManager.js","sources":["../../src/pwa/ServiceWorkerManager.ts"],"sourcesContent":["/**\r\n * Service Worker管理器\r\n */\r\n\r\nimport type { PWAConfig, ServiceWorkerMessage, ServiceWorkerStatus } from './types'\r\nimport { EventEmitter } from '../core/EventEmitter'\r\nimport { createLogger } from '../utils/logger'\r\n\r\nconst logger = createLogger('ServiceWorkerManager')\r\n\r\nexport class ServiceWorkerManager extends EventEmitter {\r\n  private config: PWAConfig\r\n  private registration?: ServiceWorkerRegistration\r\n  private updateCheckTimer?: number\r\n\r\n  constructor(config: PWAConfig) {\r\n    super()\r\n    this.config = config\r\n    this.setupEventListeners()\r\n  }\r\n\r\n  /**\r\n   * 注册Service Worker\r\n   */\r\n  async register(): Promise<ServiceWorkerRegistration> {\r\n    if (!('serviceWorker' in navigator))\r\n      throw new Error('Service Worker not supported')\r\n\r\n    try {\r\n      logger.info('Registering service worker')\r\n\r\n      const swUrl = this.getServiceWorkerURL()\r\n      this.registration = await navigator.serviceWorker.register(swUrl, {\r\n        scope: this.config.scope || '/',\r\n      })\r\n\r\n      logger.info('Service worker registered successfully')\r\n\r\n      // 监听Service Worker状态\r\n      this.watchServiceWorker()\r\n\r\n      return this.registration\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to register service worker:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取Service Worker URL\r\n   */\r\n  private getServiceWorkerURL(): string {\r\n    // 在实际应用中，这应该是构建后的SW文件路径\r\n    return '/sw.js'\r\n  }\r\n\r\n  /**\r\n   * 设置事件监听\r\n   */\r\n  private setupEventListeners(): void {\r\n    // 监听在线/离线状态\r\n    window.addEventListener('online', () => {\r\n      logger.info('Application is online')\r\n      this.emit('online')\r\n    })\r\n\r\n    window.addEventListener('offline', () => {\r\n      logger.info('Application is offline')\r\n      this.emit('offline')\r\n    })\r\n\r\n    // 监听Service Worker消息\r\n    if ('serviceWorker' in navigator) {\r\n      navigator.serviceWorker.addEventListener('message', (event) => {\r\n        this.handleMessage(event.data)\r\n      })\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 监听Service Worker\r\n   */\r\n  private watchServiceWorker(): void {\r\n    if (!this.registration)\r\n      return\r\n\r\n    // 监听更新\r\n    this.registration.addEventListener('updatefound', () => {\r\n      logger.info('Service worker update found')\r\n      const newWorker = this.registration!.installing\r\n\r\n      if (newWorker) {\r\n        newWorker.addEventListener('statechange', () => {\r\n          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\r\n            logger.info('New service worker installed')\r\n            this.emit('update-available')\r\n          }\r\n\r\n          if (newWorker.state === 'activated') {\r\n            logger.info('New service worker activated')\r\n            this.emit('update-activated')\r\n          }\r\n        })\r\n      }\r\n    })\r\n\r\n    // 检查是否有等待的Service Worker\r\n    if (this.registration.waiting)\r\n      this.emit('update-available')\r\n\r\n    // 监听控制器变化\r\n    navigator.serviceWorker.addEventListener('controllerchange', () => {\r\n      logger.info('Service worker controller changed')\r\n      this.emit('controller-change')\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 处理Service Worker消息\r\n   */\r\n  private handleMessage(message: ServiceWorkerMessage): void {\r\n    logger.debug('Received message from service worker:', message)\r\n\r\n    switch (message.type) {\r\n      case 'CACHE_UPDATED':\r\n        this.emit('cache-updated', message.payload)\r\n        break\r\n\r\n      case 'SYNC_COMPLETE':\r\n        this.emit('sync-complete', message.payload)\r\n        break\r\n\r\n      case 'NOTIFICATION':\r\n        this.emit('notification', message.payload)\r\n        break\r\n\r\n      default:\r\n        logger.debug('Unknown message type:', message.type)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 检查更新\r\n   */\r\n  async checkForUpdates(): Promise<boolean> {\r\n    if (!this.registration) {\r\n      logger.warn('No service worker registration')\r\n      return false\r\n    }\r\n\r\n    try {\r\n      await this.registration.update()\r\n      return !!this.registration.waiting\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to check for updates:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 应用更新\r\n   */\r\n  async update(): Promise<void> {\r\n    if (!this.registration?.waiting) {\r\n      logger.warn('No waiting service worker')\r\n      return\r\n    }\r\n\r\n    // 发送跳过等待消息\r\n    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' })\r\n\r\n    // 等待控制器变化\r\n    await new Promise<void>((resolve) => {\r\n      navigator.serviceWorker.addEventListener('controllerchange', () => {\r\n        resolve()\r\n      }, { once: true })\r\n    })\r\n\r\n    this.emit('update-installed')\r\n  }\r\n\r\n  /**\r\n   * 跳过等待\r\n   */\r\n  async skipWaiting(): Promise<void> {\r\n    if (!this.registration?.waiting)\r\n      return\r\n\r\n    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' })\r\n  }\r\n\r\n  /**\r\n   * 发送消息给Service Worker\r\n   */\r\n  async postMessage(message: ServiceWorkerMessage): Promise<void> {\r\n    if (!navigator.serviceWorker.controller) {\r\n      logger.warn('No service worker controller')\r\n      return\r\n    }\r\n\r\n    navigator.serviceWorker.controller.postMessage(message)\r\n  }\r\n\r\n  /**\r\n   * 获取状态\r\n   */\r\n  async getStatus(): Promise<ServiceWorkerStatus> {\r\n    if (!this.registration) {\r\n      return {\r\n        state: 'redundant',\r\n        updateAvailable: false,\r\n      }\r\n    }\r\n\r\n    const sw = this.registration.active || this.registration.installing || this.registration.waiting\r\n\r\n    return {\r\n      state: sw?.state || 'redundant',\r\n      scriptURL: sw?.scriptURL,\r\n      scope: this.registration.scope,\r\n      updateAvailable: !!this.registration.waiting,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 注销Service Worker\r\n   */\r\n  async unregister(): Promise<boolean> {\r\n    if (!this.registration)\r\n      return false\r\n\r\n    try {\r\n      const result = await this.registration.unregister()\r\n      logger.info('Service worker unregistered')\r\n      this.registration = undefined\r\n      return result\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to unregister service worker:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   */\r\n  destroy(): void {\r\n    if (this.updateCheckTimer)\r\n      clearInterval(this.updateCheckTimer)\r\n\r\n    this.removeAllListeners()\r\n  }\r\n}\r\n"],"names":["logger","createLogger","ServiceWorkerManager","EventEmitter","constructor","config","setupEventListeners","register","navigator","Error","info","swUrl","getServiceWorkerURL","registration","serviceWorker","scope","watchServiceWorker","error","window","addEventListener","emit","event","handleMessage","data","newWorker","installing","state","controller","waiting","message","debug","type","payload","checkForUpdates","warn","update","postMessage","Promise","resolve","once","skipWaiting","getStatus","updateAvailable","sw","active","scriptURL","unregister","result","undefined","destroy","updateCheckTimer","clearInterval","removeAllListeners"],"mappings":";;;;;;;;;;;;AAQA,MAAMA,MAAAA,GAASC,aAAa,sBAAsB,CAAA;AAE3C,MAAMC,6BAA6BC,YAAAA,CAAa;AAAA,EAKrDC,YAAYC,MAAAA,EAAmB;AAC7B,IAAA,KAAA,EAAM;AACN,IAAA,IAAA,CAAKA,MAAAA,GAASA,MAAAA;AACd,IAAA,IAAA,CAAKC,mBAAAA,EAAoB;AAAA,EAC3B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMC,QAAAA,GAA+C;AACnD,IAAA,IAAI,EAAE,eAAA,IAAmBC,SAAAA,CAAAA;AACvB,MAAA,MAAM,IAAIC,MAAM,8BAA8B,CAAA;AAEhD,IAAA,IAAI;AACFT,MAAAA,MAAAA,CAAOU,KAAK,4BAA4B,CAAA;AAExC,MAAA,MAAMC,KAAAA,GAAQ,KAAKC,mBAAAA,EAAoB;AACvC,MAAA,IAAA,CAAKC,YAAAA,GAAe,MAAML,SAAAA,CAAUM,aAAAA,CAAcP,SAASI,KAAAA,EAAO;AAAA,QAChEI,KAAAA,EAAO,IAAA,CAAKV,MAAAA,CAAOU,KAAAA,IAAS;AAAA,OAC7B,CAAA;AAEDf,MAAAA,MAAAA,CAAOU,KAAK,wCAAwC,CAAA;AAGpD,MAAA,IAAA,CAAKM,kBAAAA,EAAmB;AAExB,MAAA,OAAO,IAAA,CAAKH,YAAAA;AAAAA,IACd,SACOI,KAAAA,EAAO;AACZjB,MAAAA,MAAAA,CAAOiB,KAAAA,CAAM,sCAAsCA,KAAK,CAAA;AACxD,MAAA,MAAMA,KAAAA;AAAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQL,mBAAAA,GAA8B;AAEpC,IAAA,OAAO,QAAA;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKQN,mBAAAA,GAA4B;AAElCY,IAAAA,MAAAA,CAAOC,gBAAAA,CAAiB,UAAU,MAAM;AACtCnB,MAAAA,MAAAA,CAAOU,KAAK,uBAAuB,CAAA;AACnC,MAAA,IAAA,CAAKU,KAAK,QAAQ,CAAA;AAAA,IACpB,CAAC,CAAA;AAEDF,IAAAA,MAAAA,CAAOC,gBAAAA,CAAiB,WAAW,MAAM;AACvCnB,MAAAA,MAAAA,CAAOU,KAAK,wBAAwB,CAAA;AACpC,MAAA,IAAA,CAAKU,KAAK,SAAS,CAAA;AAAA,IACrB,CAAC,CAAA;AAGD,IAAA,IAAI,mBAAmBZ,SAAAA,EAAW;AAChCA,MAAAA,SAAAA,CAAUM,aAAAA,CAAcK,gBAAAA,CAAiB,SAAA,EAAYE,CAAAA,KAAAA,KAAU;AAC7D,QAAA,IAAA,CAAKC,aAAAA,CAAcD,MAAME,IAAI,CAAA;AAAA,MAC/B,CAAC,CAAA;AAAA,IACH;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQP,kBAAAA,GAA2B;AACjC,IAAA,IAAI,CAAC,IAAA,CAAKH,YAAAA;AACR,MAAA;AAGF,IAAA,IAAA,CAAKA,YAAAA,CAAaM,gBAAAA,CAAiB,aAAA,EAAe,MAAM;AACtDnB,MAAAA,MAAAA,CAAOU,KAAK,6BAA6B,CAAA;AACzC,MAAA,MAAMc,SAAAA,GAAY,KAAKX,YAAAA,CAAcY,UAAAA;AAErC,MAAA,IAAID,SAAAA,EAAW;AACbA,QAAAA,SAAAA,CAAUL,gBAAAA,CAAiB,eAAe,MAAM;AAC9C,UAAA,IAAIK,SAAAA,CAAUE,KAAAA,KAAU,WAAA,IAAelB,SAAAA,CAAUM,cAAca,UAAAA,EAAY;AACzE3B,YAAAA,MAAAA,CAAOU,KAAK,8BAA8B,CAAA;AAC1C,YAAA,IAAA,CAAKU,KAAK,kBAAkB,CAAA;AAAA,UAC9B;AAEA,UAAA,IAAII,SAAAA,CAAUE,UAAU,WAAA,EAAa;AACnC1B,YAAAA,MAAAA,CAAOU,KAAK,8BAA8B,CAAA;AAC1C,YAAA,IAAA,CAAKU,KAAK,kBAAkB,CAAA;AAAA,UAC9B;AAAA,QACF,CAAC,CAAA;AAAA,MACH;AAAA,IACF,CAAC,CAAA;AAGD,IAAA,IAAI,KAAKP,YAAAA,CAAae,OAAAA;AACpB,MAAA,IAAA,CAAKR,KAAK,kBAAkB,CAAA;AAG9BZ,IAAAA,SAAAA,CAAUM,aAAAA,CAAcK,gBAAAA,CAAiB,kBAAA,EAAoB,MAAM;AACjEnB,MAAAA,MAAAA,CAAOU,KAAK,mCAAmC,CAAA;AAC/C,MAAA,IAAA,CAAKU,KAAK,mBAAmB,CAAA;AAAA,IAC/B,CAAC,CAAA;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKQE,cAAcO,OAAAA,EAAqC;AACzD7B,IAAAA,MAAAA,CAAO8B,KAAAA,CAAM,yCAAyCD,OAAO,CAAA;AAE7D,IAAA,QAAQA,QAAQE,IAAAA;AAAI,MAClB,KAAK,eAAA;AACH,QAAA,IAAA,CAAKX,IAAAA,CAAK,eAAA,EAAiBS,OAAAA,CAAQG,OAAO,CAAA;AAC1C,QAAA;AAAA,MAEF,KAAK,eAAA;AACH,QAAA,IAAA,CAAKZ,IAAAA,CAAK,eAAA,EAAiBS,OAAAA,CAAQG,OAAO,CAAA;AAC1C,QAAA;AAAA,MAEF,KAAK,cAAA;AACH,QAAA,IAAA,CAAKZ,IAAAA,CAAK,cAAA,EAAgBS,OAAAA,CAAQG,OAAO,CAAA;AACzC,QAAA;AAAA,MAEF;AACEhC,QAAAA,MAAAA,CAAO8B,KAAAA,CAAM,uBAAA,EAAyBD,OAAAA,CAAQE,IAAI,CAAA;AAAA;AACtD,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAME,eAAAA,GAAoC;AACxC,IAAA,IAAI,CAAC,KAAKpB,YAAAA,EAAc;AACtBb,MAAAA,MAAAA,CAAOkC,KAAK,gCAAgC,CAAA;AAC5C,MAAA,OAAO,KAAA;AAAA,IACT;AAEA,IAAA,IAAI;AACF,MAAA,MAAM,IAAA,CAAKrB,aAAasB,MAAAA,EAAO;AAC/B,MAAA,OAAO,CAAC,CAAC,IAAA,CAAKtB,YAAAA,CAAae,OAAAA;AAAAA,IAC7B,SACOX,KAAAA,EAAO;AACZjB,MAAAA,MAAAA,CAAOiB,KAAAA,CAAM,gCAAgCA,KAAK,CAAA;AAClD,MAAA,OAAO,KAAA;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMkB,MAAAA,GAAwB;AAC5B,IAAA,IAAI,CAAC,IAAA,CAAKtB,YAAAA,EAAce,OAAAA,EAAS;AAC/B5B,MAAAA,MAAAA,CAAOkC,KAAK,2BAA2B,CAAA;AACvC,MAAA;AAAA,IACF;AAGA,IAAA,IAAA,CAAKrB,YAAAA,CAAae,QAAQQ,WAAAA,CAAY;AAAA,MAAEL,IAAAA,EAAM;AAAA,KAAgB,CAAA;AAG9D,IAAA,MAAM,IAAIM,QAAeC,CAAAA,OAAAA,KAAY;AACnC9B,MAAAA,SAAAA,CAAUM,aAAAA,CAAcK,gBAAAA,CAAiB,kBAAA,EAAoB,MAAM;AACjEmB,QAAAA,OAAAA,EAAQ;AAAA,MACV,CAAA,EAAG;AAAA,QAAEC,IAAAA,EAAM;AAAA,OAAM,CAAA;AAAA,IACnB,CAAC,CAAA;AAED,IAAA,IAAA,CAAKnB,KAAK,kBAAkB,CAAA;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMoB,WAAAA,GAA6B;AACjC,IAAA,IAAI,CAAC,KAAK3B,YAAAA,EAAce,OAAAA;AACtB,MAAA;AAEF,IAAA,IAAA,CAAKf,YAAAA,CAAae,QAAQQ,WAAAA,CAAY;AAAA,MAAEL,IAAAA,EAAM;AAAA,KAAgB,CAAA;AAAA,EAChE;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMK,YAAYP,OAAAA,EAA8C;AAC9D,IAAA,IAAI,CAACrB,SAAAA,CAAUM,aAAAA,CAAca,UAAAA,EAAY;AACvC3B,MAAAA,MAAAA,CAAOkC,KAAK,8BAA8B,CAAA;AAC1C,MAAA;AAAA,IACF;AAEA1B,IAAAA,SAAAA,CAAUM,aAAAA,CAAca,UAAAA,CAAWS,WAAAA,CAAYP,OAAO,CAAA;AAAA,EACxD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMY,SAAAA,GAA0C;AAC9C,IAAA,IAAI,CAAC,KAAK5B,YAAAA,EAAc;AACtB,MAAA,OAAO;AAAA,QACLa,KAAAA,EAAO,WAAA;AAAA,QACPgB,eAAAA,EAAiB;AAAA,OACnB;AAAA,IACF;AAEA,IAAA,MAAMC,EAAAA,GAAK,KAAK9B,YAAAA,CAAa+B,MAAAA,IAAU,KAAK/B,YAAAA,CAAaY,UAAAA,IAAc,KAAKZ,YAAAA,CAAae,OAAAA;AAEzF,IAAA,OAAO;AAAA,MACLF,KAAAA,EAAOiB,IAAIjB,KAAAA,IAAS,WAAA;AAAA,MACpBmB,WAAWF,EAAAA,EAAIE,SAAAA;AAAAA,MACf9B,KAAAA,EAAO,KAAKF,YAAAA,CAAaE,KAAAA;AAAAA,MACzB2B,eAAAA,EAAiB,CAAC,CAAC,IAAA,CAAK7B,YAAAA,CAAae;AAAAA,KACvC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMkB,UAAAA,GAA+B;AACnC,IAAA,IAAI,CAAC,IAAA,CAAKjC,YAAAA;AACR,MAAA,OAAO,KAAA;AAET,IAAA,IAAI;AACF,MAAA,MAAMkC,MAAAA,GAAS,MAAM,IAAA,CAAKlC,YAAAA,CAAaiC,UAAAA,EAAW;AAClD9C,MAAAA,MAAAA,CAAOU,KAAK,6BAA6B,CAAA;AACzC,MAAA,IAAA,CAAKG,YAAAA,GAAemC,KAAAA,CAAAA;AACpB,MAAA,OAAOD,MAAAA;AAAAA,IACT,SACO9B,KAAAA,EAAO;AACZjB,MAAAA,MAAAA,CAAOiB,KAAAA,CAAM,wCAAwCA,KAAK,CAAA;AAC1D,MAAA,OAAO,KAAA;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKAgC,OAAAA,GAAgB;AACd,IAAA,IAAI,IAAA,CAAKC,gBAAAA;AACPC,MAAAA,aAAAA,CAAc,KAAKD,gBAAgB,CAAA;AAErC,IAAA,IAAA,CAAKE,kBAAAA,EAAmB;AAAA,EAC1B;AACF;;;;;;;"}