{"version":3,"file":"BackgroundSyncManager.js","sources":["../../src/pwa/BackgroundSyncManager.ts"],"sourcesContent":["/**\r\n * 后台同步管理器\r\n */\r\n\r\nimport type { PWAConfig, SyncQueueItem } from './types'\r\nimport { EventEmitter } from '../core/EventEmitter'\r\nimport { createLogger } from '../utils/logger'\r\n\r\nconst logger = createLogger('BackgroundSyncManager')\r\n\r\nexport class BackgroundSyncManager extends EventEmitter {\r\n  private config: PWAConfig\r\n  private syncQueue: SyncQueueItem[] = []\r\n  private db?: IDBDatabase\r\n\r\n  constructor(config: PWAConfig) {\r\n    super()\r\n    this.config = config\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (!this.isSupported()) {\r\n      logger.warn('Background Sync API not supported')\r\n      return\r\n    }\r\n\r\n    logger.info('Initializing background sync manager')\r\n\r\n    // 初始化IndexedDB\r\n    await this.initDB()\r\n\r\n    // 加载队列\r\n    await this.loadQueue()\r\n\r\n    logger.info('Background sync manager initialized')\r\n  }\r\n\r\n  /**\r\n   * 检查是否支持\r\n   */\r\n  isSupported(): boolean {\r\n    return 'sync' in ServiceWorkerRegistration.prototype\r\n  }\r\n\r\n  /**\r\n   * 初始化数据库\r\n   */\r\n  private async initDB(): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      const request = indexedDB.open('ldesign-sync', 1)\r\n\r\n      request.onerror = () => reject(request.error)\r\n      request.onsuccess = () => {\r\n        this.db = request.result\r\n        resolve()\r\n      }\r\n\r\n      request.onupgradeneeded = (event) => {\r\n        const db = (event.target as IDBOpenDBRequest).result\r\n        if (!db.objectStoreNames.contains('syncQueue'))\r\n          db.createObjectStore('syncQueue', { keyPath: 'id' })\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 加载队列\r\n   */\r\n  private async loadQueue(): Promise<void> {\r\n    if (!this.db)\r\n      return\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = this.db!.transaction(['syncQueue'], 'readonly')\r\n      const store = transaction.objectStore('syncQueue')\r\n      const request = store.getAll()\r\n\r\n      request.onsuccess = () => {\r\n        this.syncQueue = request.result || []\r\n        logger.info(`Loaded ${this.syncQueue.length} sync items from queue`)\r\n        resolve()\r\n      }\r\n\r\n      request.onerror = () => reject(request.error)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 保存队列\r\n   */\r\n  private async saveQueue(): Promise<void> {\r\n    if (!this.db)\r\n      return\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = this.db!.transaction(['syncQueue'], 'readwrite')\r\n      const store = transaction.objectStore('syncQueue')\r\n\r\n      // 清空并重新添加\r\n      store.clear()\r\n      this.syncQueue.forEach(item => store.add(item))\r\n\r\n      transaction.oncomplete = () => resolve()\r\n      transaction.onerror = () => reject(transaction.error)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 注册同步\r\n   */\r\n  async register(tag: string, data?: any): Promise<void> {\r\n    if (!this.isSupported()) {\r\n      logger.warn('Background sync not supported, adding to local queue')\r\n      await this.addToQueue(tag, data)\r\n      return\r\n    }\r\n\r\n    try {\r\n      const registration = await navigator.serviceWorker.ready\r\n      await registration.sync.register(tag)\r\n\r\n      logger.info(`Registered background sync: ${tag}`)\r\n\r\n      // 添加到队列\r\n      await this.addToQueue(tag, data)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to register sync:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 添加到队列\r\n   */\r\n  private async addToQueue(tag: string, data?: any): Promise<void> {\r\n    const item: SyncQueueItem = {\r\n      id: `${Date.now()}-${Math.random()}`,\r\n      tag,\r\n      url: data?.url || '',\r\n      method: data?.method || 'POST',\r\n      data: data?.body,\r\n      headers: data?.headers,\r\n      timestamp: Date.now(),\r\n      retries: 0,\r\n      maxRetries: 3,\r\n    }\r\n\r\n    this.syncQueue.push(item)\r\n    await this.saveQueue()\r\n\r\n    // 如果在线，立即尝试同步\r\n    if (navigator.onLine)\r\n      await this.processQueue()\r\n  }\r\n\r\n  /**\r\n   * 处理队列\r\n   */\r\n  async processQueue(): Promise<void> {\r\n    if (this.syncQueue.length === 0)\r\n      return\r\n\r\n    logger.info(`Processing ${this.syncQueue.length} sync items`)\r\n\r\n    const results = await Promise.allSettled(\r\n      this.syncQueue.map(item => this.processItem(item)),\r\n    )\r\n\r\n    // 移除成功的项\r\n    this.syncQueue = this.syncQueue.filter((item, index) => {\r\n      const result = results[index]\r\n      if (result.status === 'fulfilled') {\r\n        this.emit('sync-success', item.tag)\r\n        return false\r\n      }\r\n\r\n      // 增加重试次数\r\n      item.retries++\r\n\r\n      // 超过最大重试次数则移除\r\n      if (item.retries >= item.maxRetries) {\r\n        this.emit('sync-error', new Error(`Max retries reached for ${item.tag}`))\r\n        return false\r\n      }\r\n\r\n      return true\r\n    })\r\n\r\n    await this.saveQueue()\r\n  }\r\n\r\n  /**\r\n   * 处理单个项\r\n   */\r\n  private async processItem(item: SyncQueueItem): Promise<void> {\r\n    try {\r\n      const response = await fetch(item.url, {\r\n        method: item.method,\r\n        headers: item.headers,\r\n        body: item.data ? JSON.stringify(item.data) : undefined,\r\n      })\r\n\r\n      if (!response.ok)\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\r\n\r\n      logger.info(`Sync completed: ${item.tag}`)\r\n    }\r\n    catch (error) {\r\n      logger.error(`Sync failed: ${item.tag}`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取队列长度\r\n   */\r\n  getQueueLength(): number {\r\n    return this.syncQueue.length\r\n  }\r\n\r\n  /**\r\n   * 清空队列\r\n   */\r\n  async clearQueue(): Promise<void> {\r\n    this.syncQueue = []\r\n    await this.saveQueue()\r\n    logger.info('Sync queue cleared')\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   */\r\n  destroy(): void {\r\n    this.db?.close()\r\n    this.removeAllListeners()\r\n  }\r\n}\r\n"],"names":["logger","createLogger","BackgroundSyncManager","EventEmitter","constructor","config","syncQueue","initialize","isSupported","warn","info","initDB","loadQueue","ServiceWorkerRegistration","prototype","Promise","resolve","reject","request","indexedDB","open","onerror","error","onsuccess","db","result","onupgradeneeded","event","target","objectStoreNames","contains","createObjectStore","keyPath","transaction","store","objectStore","getAll","length","saveQueue","clear","forEach","item","add","oncomplete","register","tag","data","addToQueue","registration","navigator","serviceWorker","ready","sync","id","Date","now","Math","random","url","method","body","headers","timestamp","retries","maxRetries","push","onLine","processQueue","results","allSettled","map","processItem","filter","index","status","emit","Error","response","fetch","JSON","stringify","undefined","ok","statusText","getQueueLength","clearQueue","destroy","close","removeAllListeners"],"mappings":"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"}