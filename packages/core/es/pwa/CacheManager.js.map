{"version":3,"file":"CacheManager.js","sources":["../../src/pwa/CacheManager.ts"],"sourcesContent":["/**\r\n * 缓存管理器\r\n */\r\n\r\nimport type { PWAConfig } from './types'\r\nimport { EventEmitter } from '../core/EventEmitter'\r\nimport { createLogger } from '../utils/logger'\r\n\r\nconst logger = createLogger('CacheManager')\r\n\r\nexport class CacheManager extends EventEmitter {\r\n  private config: PWAConfig\r\n  private cacheName = 'ldesign-editor-v1'\r\n  private cacheVersion = 1\r\n\r\n  constructor(config: PWAConfig) {\r\n    super()\r\n    this.config = config\r\n  }\r\n\r\n  /**\r\n   * 初始化缓存\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (!('caches' in window))\r\n      throw new Error('Cache API not supported')\r\n\r\n    logger.info('Initializing cache manager')\r\n\r\n    // 清理旧版本缓存\r\n    await this.cleanOldCaches()\r\n\r\n    logger.info('Cache manager initialized')\r\n  }\r\n\r\n  /**\r\n   * 添加资源到缓存\r\n   */\r\n  async addResources(urls: string[]): Promise<void> {\r\n    try {\r\n      const cache = await caches.open(this.cacheName)\r\n      await cache.addAll(urls)\r\n      logger.info(`Cached ${urls.length} resources`)\r\n      this.emit('cache-updated', this.cacheName)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to cache resources:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 从缓存获取\r\n   */\r\n  async get(request: Request | string): Promise<Response | undefined> {\r\n    try {\r\n      const cache = await caches.open(this.cacheName)\r\n      return await cache.match(request)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to get from cache:', error)\r\n      return undefined\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 添加到缓存\r\n   */\r\n  async put(request: Request | string, response: Response): Promise<void> {\r\n    try {\r\n      const cache = await caches.open(this.cacheName)\r\n      await cache.put(request, response)\r\n      this.emit('cache-updated', this.cacheName)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to put to cache:', error)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 删除缓存项\r\n   */\r\n  async delete(request: Request | string): Promise<boolean> {\r\n    try {\r\n      const cache = await caches.open(this.cacheName)\r\n      return await cache.delete(request)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to delete from cache:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 清除所有缓存\r\n   */\r\n  async clear(cacheName?: string): Promise<void> {\r\n    try {\r\n      if (cacheName) {\r\n        await caches.delete(cacheName)\r\n      }\r\n      else {\r\n        const keys = await caches.keys()\r\n        await Promise.all(keys.map(key => caches.delete(key)))\r\n      }\r\n      logger.info('Cache cleared')\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to clear cache:', error)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 清理旧版本缓存\r\n   */\r\n  private async cleanOldCaches(): Promise<void> {\r\n    const keys = await caches.keys()\r\n    const oldCaches = keys.filter(key => key !== this.cacheName)\r\n\r\n    await Promise.all(oldCaches.map(key => caches.delete(key)))\r\n\r\n    if (oldCaches.length > 0)\r\n      logger.info(`Cleaned ${oldCaches.length} old caches`)\r\n  }\r\n\r\n  /**\r\n   * 获取缓存大小\r\n   */\r\n  async getSize(): Promise<number> {\r\n    if (!('estimate' in navigator.storage))\r\n      return 0\r\n\r\n    try {\r\n      const estimate = await navigator.storage.estimate()\r\n      return estimate.usage || 0\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to get cache size:', error)\r\n      return 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取所有缓存的URL\r\n   */\r\n  async getCachedUrls(): Promise<string[]> {\r\n    try {\r\n      const cache = await caches.open(this.cacheName)\r\n      const requests = await cache.keys()\r\n      return requests.map(req => req.url)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to get cached URLs:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   */\r\n  destroy(): void {\r\n    this.removeAllListeners()\r\n  }\r\n}\r\n"],"names":["logger","createLogger","CacheManager","EventEmitter","constructor","config","cacheName","cacheVersion","initialize","window","Error","info","cleanOldCaches","addResources","urls","cache","caches","open","addAll","length","emit","error","get","request","match","undefined","put","response","delete","clear","keys","Promise","all","map","key","oldCaches","filter","getSize","navigator","storage","estimate","usage","getCachedUrls","requests","req","url","destroy","removeAllListeners"],"mappings":"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"}