{"version":3,"file":"WasmAccelerator.js","sources":["../../src/wasm/WasmAccelerator.ts"],"sourcesContent":["/**\r\n * WebAssembly加速管理器\r\n * 统一管理和调度WASM模块，提供性能加速\r\n */\r\n\r\nimport type { DiffResult } from './WasmDiff'\r\nimport type { ParseResult } from './WasmParser'\r\nimport { createLogger } from '../utils/logger'\r\nimport { getPerformanceMonitor } from '../utils/PerformanceMonitor'\r\nimport { WasmDiff } from './WasmDiff'\r\nimport { WasmParser } from './WasmParser'\r\n\r\nconst logger = createLogger('WasmAccelerator')\r\nconst performanceMonitor = getPerformanceMonitor()\r\n\r\nexport interface AcceleratorOptions {\r\n  /** 是否启用WASM加速 */\r\n  enabled?: boolean\r\n  /** 是否启用diff加速 */\r\n  enableDiff?: boolean\r\n  /** 是否启用解析加速 */\r\n  enableParser?: boolean\r\n  /** 是否使用Web Worker */\r\n  useWorker?: boolean\r\n  /** 是否启用缓存 */\r\n  enableCache?: boolean\r\n  /** 预热策略 */\r\n  warmupStrategy?: 'eager' | 'lazy' | 'none'\r\n}\r\n\r\nexport interface AcceleratorStats {\r\n  enabled: boolean\r\n  initialized: boolean\r\n  modules: {\r\n    diff: { initialized: boolean, calls: number, totalTime: number, cacheHits: number }\r\n    parser: { initialized: boolean, calls: number, totalTime: number, cacheHits: number }\r\n  }\r\n  memory: {\r\n    used: number\r\n    peak: number\r\n  }\r\n  performance: {\r\n    averageSpeedup: number\r\n    totalTimeSaved: number\r\n  }\r\n}\r\n\r\nexport class WasmAccelerator {\r\n  private options: Required<AcceleratorOptions>\r\n  private diffModule?: WasmDiff\r\n  private parserModule?: WasmParser\r\n  private initialized = false\r\n  private initPromise?: Promise<void>\r\n  private stats = {\r\n    diff: { calls: 0, totalTime: 0, cacheHits: 0, nativeTime: 0 },\r\n    parser: { calls: 0, totalTime: 0, cacheHits: 0, nativeTime: 0 },\r\n  }\r\n\r\n  private memoryPeak = 0\r\n\r\n  constructor(options: AcceleratorOptions = {}) {\r\n    this.options = {\r\n      enabled: true,\r\n      enableDiff: true,\r\n      enableParser: true,\r\n      useWorker: typeof Worker !== 'undefined',\r\n      enableCache: true,\r\n      warmupStrategy: 'lazy',\r\n      ...options,\r\n    }\r\n\r\n    if (this.options.enabled && this.options.warmupStrategy === 'eager')\r\n      this.initialize()\r\n  }\r\n\r\n  /**\r\n   * 初始化WASM模块\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (!this.options.enabled)\r\n      return\r\n    if (this.initialized)\r\n      return\r\n    if (this.initPromise)\r\n      return this.initPromise\r\n\r\n    this.initPromise = this.doInitialize()\r\n    await this.initPromise\r\n  }\r\n\r\n  private async doInitialize(): Promise<void> {\r\n    logger.info('Initializing WebAssembly accelerator')\r\n    const startTime = performance.now()\r\n\r\n    try {\r\n      const promises: Promise<void>[] = []\r\n\r\n      // 初始化Diff模块\r\n      if (this.options.enableDiff) {\r\n        this.diffModule = new WasmDiff({\r\n          enableCache: this.options.enableCache,\r\n          useWorker: this.options.useWorker,\r\n        })\r\n        promises.push(this.diffModule.initialize())\r\n      }\r\n\r\n      // 初始化Parser模块\r\n      if (this.options.enableParser) {\r\n        this.parserModule = new WasmParser({\r\n          enableCache: this.options.enableCache,\r\n        })\r\n        promises.push(this.parserModule.initialize())\r\n      }\r\n\r\n      await Promise.all(promises)\r\n\r\n      // 预热（如果是lazy策略）\r\n      if (this.options.warmupStrategy === 'lazy')\r\n        await this.warmup()\r\n\r\n      this.initialized = true\r\n      const initTime = performance.now() - startTime\r\n      logger.info(`WebAssembly accelerator initialized in ${initTime.toFixed(2)}ms`)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to initialize WebAssembly accelerator:', error)\r\n      // 降级到纯JavaScript实现\r\n      this.options.enabled = false\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 预热WASM模块\r\n   */\r\n  private async warmup(): Promise<void> {\r\n    logger.debug('Warming up WASM modules')\r\n\r\n    // 预热Diff模块\r\n    if (this.diffModule) {\r\n      await this.diffModule.diff('hello', 'world')\r\n      await this.diffModule.compare('test', 'test')\r\n    }\r\n\r\n    // 预热Parser模块\r\n    if (this.parserModule)\r\n      await this.parserModule.parse('# Test\\nHello world')\r\n  }\r\n\r\n  /**\r\n   * 计算文本差异（加速版）\r\n   */\r\n  async diff(text1: string, text2: string): Promise<DiffResult> {\r\n    const mark = performanceMonitor.mark('wasm-diff')\r\n\r\n    if (!this.options.enabled || !this.options.enableDiff) {\r\n      // 降级到JavaScript实现\r\n      return this.jsDiff(text1, text2)\r\n    }\r\n\r\n    await this.initialize()\r\n\r\n    try {\r\n      const startTime = performance.now()\r\n      const result = await this.diffModule!.diff(text1, text2)\r\n      const wasmTime = performance.now() - startTime\r\n\r\n      this.stats.diff.calls++\r\n      this.stats.diff.totalTime += wasmTime\r\n\r\n      // 记录性能对比\r\n      if (this.shouldBenchmark()) {\r\n        const jsStartTime = performance.now()\r\n        await this.jsDiff(text1, text2)\r\n        const jsTime = performance.now() - jsStartTime\r\n        this.stats.diff.nativeTime += jsTime\r\n\r\n        const speedup = jsTime / wasmTime\r\n        logger.debug(`Diff speedup: ${speedup.toFixed(2)}x (WASM: ${wasmTime.toFixed(2)}ms, JS: ${jsTime.toFixed(2)}ms)`)\r\n      }\r\n\r\n      performanceMonitor.measure('wasm-diff', mark)\r\n      this.updateMemoryStats()\r\n\r\n      return result\r\n    }\r\n    catch (error) {\r\n      logger.error('WASM diff failed, falling back to JS:', error)\r\n      return this.jsDiff(text1, text2)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * JavaScript版本的diff实现（降级方案）\r\n   */\r\n  private async jsDiff(text1: string, text2: string): Promise<DiffResult> {\r\n    // 简单的Levenshtein距离实现\r\n    const len1 = text1.length\r\n    const len2 = text2.length\r\n    const matrix: number[][] = []\r\n\r\n    // 初始化矩阵\r\n    for (let i = 0; i <= len1; i++)\r\n      matrix[i] = [i]\r\n\r\n    for (let j = 0; j <= len2; j++)\r\n      matrix[0][j] = j\r\n\r\n    // 计算编辑距离\r\n    for (let i = 1; i <= len1; i++) {\r\n      for (let j = 1; j <= len2; j++) {\r\n        const cost = text1[i - 1] === text2[j - 1] ? 0 : 1\r\n        matrix[i][j] = Math.min(\r\n          matrix[i - 1][j] + 1, // 删除\r\n          matrix[i][j - 1] + 1, // 插入\r\n          matrix[i - 1][j - 1] + cost, // 替换\r\n        )\r\n      }\r\n    }\r\n\r\n    const distance = matrix[len1][len2]\r\n    const maxLen = Math.max(len1, len2)\r\n\r\n    return {\r\n      distance,\r\n      operations: [],\r\n      similarity: maxLen > 0 ? 1 - distance / maxLen : 1,\r\n      executionTime: 0,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 解析文档（加速版）\r\n   */\r\n  async parse(text: string): Promise<ParseResult> {\r\n    const mark = performanceMonitor.mark('wasm-parse')\r\n\r\n    if (!this.options.enabled || !this.options.enableParser) {\r\n      // 降级到JavaScript实现\r\n      return this.jsParse(text)\r\n    }\r\n\r\n    await this.initialize()\r\n\r\n    try {\r\n      const startTime = performance.now()\r\n      const result = await this.parserModule!.parse(text)\r\n      const wasmTime = performance.now() - startTime\r\n\r\n      this.stats.parser.calls++\r\n      this.stats.parser.totalTime += wasmTime\r\n\r\n      // 记录性能对比\r\n      if (this.shouldBenchmark()) {\r\n        const jsStartTime = performance.now()\r\n        await this.jsParse(text)\r\n        const jsTime = performance.now() - jsStartTime\r\n        this.stats.parser.nativeTime += jsTime\r\n\r\n        const speedup = jsTime / wasmTime\r\n        logger.debug(`Parse speedup: ${speedup.toFixed(2)}x (WASM: ${wasmTime.toFixed(2)}ms, JS: ${jsTime.toFixed(2)}ms)`)\r\n      }\r\n\r\n      performanceMonitor.measure('wasm-parse', mark)\r\n      this.updateMemoryStats()\r\n\r\n      return result\r\n    }\r\n    catch (error) {\r\n      logger.error('WASM parse failed, falling back to JS:', error)\r\n      return this.jsParse(text)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * JavaScript版本的解析实现（降级方案）\r\n   */\r\n  private async jsParse(text: string): Promise<ParseResult> {\r\n    // 简单的Markdown解析\r\n    const lines = text.split('\\n')\r\n    const nodes = []\r\n    let nodeCount = 0\r\n\r\n    for (let i = 0; i < lines.length; i++) {\r\n      const line = lines[i]\r\n\r\n      if (line.startsWith('#')) {\r\n        const level = line.match(/^#+/)?.[0].length || 1\r\n        nodes.push({\r\n          type: 2, // HEADING\r\n          start: text.indexOf(line),\r\n          end: text.indexOf(line) + line.length,\r\n          content: line.replace(/^#+\\s*/, ''),\r\n          attributes: { level },\r\n        })\r\n        nodeCount++\r\n      }\r\n      else if (line.trim()) {\r\n        nodes.push({\r\n          type: 1, // PARAGRAPH\r\n          start: text.indexOf(line),\r\n          end: text.indexOf(line) + line.length,\r\n          content: line,\r\n        })\r\n        nodeCount++\r\n      }\r\n    }\r\n\r\n    return {\r\n      nodes,\r\n      parseTime: 0,\r\n      nodeCount,\r\n      memoryUsed: 0,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 批量diff（利用WASM并行能力）\r\n   */\r\n  async batchDiff(pairs: Array<[string, string]>): Promise<DiffResult[]> {\r\n    if (!this.options.enabled || !this.diffModule) {\r\n      // 降级处理\r\n      return Promise.all(pairs.map(([a, b]) => this.jsDiff(a, b)))\r\n    }\r\n\r\n    await this.initialize()\r\n    return this.diffModule.batchDiff(pairs)\r\n  }\r\n\r\n  /**\r\n   * 快速字符串比较\r\n   */\r\n  async compare(str1: string, str2: string): Promise<boolean> {\r\n    if (!this.options.enabled || !this.diffModule)\r\n      return str1 === str2\r\n\r\n    await this.initialize()\r\n    return this.diffModule.compare(str1, str2)\r\n  }\r\n\r\n  /**\r\n   * 是否应该进行基准测试\r\n   */\r\n  private shouldBenchmark(): boolean {\r\n    // 每100次调用进行一次基准测试\r\n    const totalCalls = this.stats.diff.calls + this.stats.parser.calls\r\n    return totalCalls % 100 === 0\r\n  }\r\n\r\n  /**\r\n   * 更新内存统计\r\n   */\r\n  private updateMemoryStats(): void {\r\n    if (performance.memory) {\r\n      const used = performance.memory.usedJSHeapSize\r\n      this.memoryPeak = Math.max(this.memoryPeak, used)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取加速器统计信息\r\n   */\r\n  getStats(): AcceleratorStats {\r\n    const diffStats = this.diffModule?.getCacheStats() || { hits: 0, misses: 0 }\r\n    const memoryUsage = this.diffModule?.getMemoryUsage() || { used: 0, total: 0 }\r\n\r\n    // 计算平均加速比\r\n    let totalSpeedup = 0\r\n    let count = 0\r\n\r\n    if (this.stats.diff.calls > 0 && this.stats.diff.nativeTime > 0) {\r\n      totalSpeedup += this.stats.diff.nativeTime / this.stats.diff.totalTime\r\n      count++\r\n    }\r\n\r\n    if (this.stats.parser.calls > 0 && this.stats.parser.nativeTime > 0) {\r\n      totalSpeedup += this.stats.parser.nativeTime / this.stats.parser.totalTime\r\n      count++\r\n    }\r\n\r\n    const averageSpeedup = count > 0 ? totalSpeedup / count : 1\r\n    const totalTimeSaved = (this.stats.diff.nativeTime - this.stats.diff.totalTime)\r\n      + (this.stats.parser.nativeTime - this.stats.parser.totalTime)\r\n\r\n    return {\r\n      enabled: this.options.enabled,\r\n      initialized: this.initialized,\r\n      modules: {\r\n        diff: {\r\n          initialized: !!this.diffModule,\r\n          calls: this.stats.diff.calls,\r\n          totalTime: this.stats.diff.totalTime,\r\n          cacheHits: diffStats.hits,\r\n        },\r\n        parser: {\r\n          initialized: !!this.parserModule,\r\n          calls: this.stats.parser.calls,\r\n          totalTime: this.stats.parser.totalTime,\r\n          cacheHits: 0,\r\n        },\r\n      },\r\n      memory: {\r\n        used: memoryUsage.used,\r\n        peak: this.memoryPeak,\r\n      },\r\n      performance: {\r\n        averageSpeedup,\r\n        totalTimeSaved: Math.max(0, totalTimeSaved),\r\n      },\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 重置统计信息\r\n   */\r\n  resetStats(): void {\r\n    this.stats = {\r\n      diff: { calls: 0, totalTime: 0, cacheHits: 0, nativeTime: 0 },\r\n      parser: { calls: 0, totalTime: 0, cacheHits: 0, nativeTime: 0 },\r\n    }\r\n    this.memoryPeak = 0\r\n  }\r\n\r\n  /**\r\n   * 清理资源\r\n   */\r\n  dispose(): void {\r\n    this.diffModule?.dispose()\r\n    this.parserModule?.dispose()\r\n    this.initialized = false\r\n    logger.info('WasmAccelerator disposed')\r\n  }\r\n\r\n  /**\r\n   * 获取是否支持WebAssembly\r\n   */\r\n  static isSupported(): boolean {\r\n    try {\r\n      return typeof WebAssembly === 'object'\r\n        && typeof WebAssembly.instantiate === 'function'\r\n    }\r\n    catch {\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取WebAssembly特性\r\n   */\r\n  static getFeatures(): {\r\n    supported: boolean\r\n    streaming: boolean\r\n    simd: boolean\r\n    threads: boolean\r\n    exceptions: boolean\r\n  } {\r\n    const supported = WasmAccelerator.isSupported()\r\n\r\n    return {\r\n      supported,\r\n      streaming: supported && typeof WebAssembly.instantiateStreaming === 'function',\r\n      simd: false, // 需要特性检测\r\n      threads: typeof SharedArrayBuffer !== 'undefined',\r\n      exceptions: false, // 需要特性检测\r\n    }\r\n  }\r\n}\r\n"],"names":["logger","createLogger","performanceMonitor","getPerformanceMonitor","WasmAccelerator","constructor","options","initialized","stats","diff","calls","totalTime","cacheHits","nativeTime","parser","memoryPeak","enabled","enableDiff","enableParser","useWorker","Worker","enableCache","warmupStrategy","initialize","initPromise","doInitialize","info","startTime","performance","now","promises","diffModule","WasmDiff","push","parserModule","WasmParser","Promise","all","warmup","initTime","toFixed","error","debug","compare","parse","text1","text2","mark","jsDiff","result","wasmTime","shouldBenchmark","jsStartTime","jsTime","speedup","measure","updateMemoryStats","len1","length","len2","matrix","i","j","cost","Math","min","distance","maxLen","max","operations","similarity","executionTime","text","jsParse","lines","split","nodes","nodeCount","line","startsWith","level","match","type","start","indexOf","end","content","replace","attributes","trim","parseTime","memoryUsed","batchDiff","pairs","map","a","b","str1","str2","totalCalls","memory","used","usedJSHeapSize","getStats","diffStats","getCacheStats","hits","memoryUsage","getMemoryUsage","totalSpeedup","count","averageSpeedup","totalTimeSaved","modules","peak","resetStats","dispose","isSupported","WebAssembly","instantiate","getFeatures","supported","streaming","instantiateStreaming","simd","threads","SharedArrayBuffer","exceptions"],"mappings":";;;;;;;;;;;;;;AAYA,MAAMA,MAAAA,GAASC,aAAa,iBAAiB,CAAA;AAC7C,MAAMC,qBAAqBC,qBAAAA,EAAsB;AAkC1C,MAAMC,eAAAA,CAAgB;AAAA,EAa3BC,WAAAA,CAAYC,OAAAA,GAA8B,EAAC,EAAG;AAT9C,IAAA,IAAA,CAAQC,WAAAA,GAAc,KAAA;AAEtB,IAAA,IAAA,CAAQC,KAAAA,GAAQ;AAAA,MACdC,IAAAA,EAAM;AAAA,QAAEC,KAAAA,EAAO,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,UAAAA,EAAY;AAAA,OAAE;AAAA,MAC5DC,MAAAA,EAAQ;AAAA,QAAEJ,KAAAA,EAAO,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,UAAAA,EAAY;AAAA;AAAE,KAChE;AAEA,IAAA,IAAA,CAAQE,UAAAA,GAAa,CAAA;AAGnB,IAAA,IAAA,CAAKT,OAAAA,GAAU;AAAA,MACbU,OAAAA,EAAS,IAAA;AAAA,MACTC,UAAAA,EAAY,IAAA;AAAA,MACZC,YAAAA,EAAc,IAAA;AAAA,MACdC,SAAAA,EAAW,OAAOC,MAAAA,KAAW,WAAA;AAAA,MAC7BC,WAAAA,EAAa,IAAA;AAAA,MACbC,cAAAA,EAAgB,MAAA;AAAA,MAChB,GAAGhB;AAAAA,KACL;AAEA,IAAA,IAAI,IAAA,CAAKA,OAAAA,CAAQU,OAAAA,IAAW,IAAA,CAAKV,QAAQgB,cAAAA,KAAmB,OAAA;AAC1D,MAAA,IAAA,CAAKC,UAAAA,EAAW;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMA,UAAAA,GAA4B;AAChC,IAAA,IAAI,CAAC,KAAKjB,OAAAA,CAAQU,OAAAA;AAChB,MAAA;AACF,IAAA,IAAI,IAAA,CAAKT,WAAAA;AACP,MAAA;AACF,IAAA,IAAI,IAAA,CAAKiB,WAAAA;AACP,MAAA,OAAO,IAAA,CAAKA,WAAAA;AAEd,IAAA,IAAA,CAAKA,WAAAA,GAAc,KAAKC,YAAAA,EAAa;AACrC,IAAA,MAAM,IAAA,CAAKD,WAAAA;AAAAA,EACb;AAAA,EAEA,MAAcC,YAAAA,GAA8B;AAC1CzB,IAAAA,MAAAA,CAAO0B,KAAK,sCAAsC,CAAA;AAClD,IAAA,MAAMC,SAAAA,GAAYC,YAAYC,GAAAA,EAAI;AAElC,IAAA,IAAI;AACF,MAAA,MAAMC,WAA4B,EAAA;AAGlC,MAAA,IAAI,IAAA,CAAKxB,QAAQW,UAAAA,EAAY;AAC3B,QAAA,IAAA,CAAKc,UAAAA,GAAa,IAAIC,QAAAA,CAAS;AAAA,UAC7BX,WAAAA,EAAa,KAAKf,OAAAA,CAAQe,WAAAA;AAAAA,UAC1BF,SAAAA,EAAW,KAAKb,OAAAA,CAAQa;AAAAA,SACzB,CAAA;AACDW,QAAAA,QAAAA,CAASG,IAAAA,CAAK,IAAA,CAAKF,UAAAA,CAAWR,UAAAA,EAAY,CAAA;AAAA,MAC5C;AAGA,MAAA,IAAI,IAAA,CAAKjB,QAAQY,YAAAA,EAAc;AAC7B,QAAA,IAAA,CAAKgB,YAAAA,GAAe,IAAIC,UAAAA,CAAW;AAAA,UACjCd,WAAAA,EAAa,KAAKf,OAAAA,CAAQe;AAAAA,SAC3B,CAAA;AACDS,QAAAA,QAAAA,CAASG,IAAAA,CAAK,IAAA,CAAKC,YAAAA,CAAaX,UAAAA,EAAY,CAAA;AAAA,MAC9C;AAEA,MAAA,MAAMa,OAAAA,CAAQC,IAAIP,QAAQ,CAAA;AAG1B,MAAA,IAAI,IAAA,CAAKxB,QAAQgB,cAAAA,KAAmB,MAAA;AAClC,QAAA,MAAM,KAAKgB,MAAAA,EAAO;AAEpB,MAAA,IAAA,CAAK/B,WAAAA,GAAc,IAAA;AACnB,MAAA,MAAMgC,QAAAA,GAAWX,WAAAA,CAAYC,GAAAA,EAAI,GAAIF,SAAAA;AACrC3B,MAAAA,MAAAA,CAAO0B,KAAK,CAAA,uCAAA,EAA0Ca,QAAAA,CAASC,OAAAA,CAAQ,CAAC,CAAC,CAAA,EAAA,CAAI,CAAA;AAAA,IAC/E,SACOC,KAAAA,EAAO;AACZzC,MAAAA,MAAAA,CAAOyC,KAAAA,CAAM,iDAAiDA,KAAK,CAAA;AAEnE,MAAA,IAAA,CAAKnC,QAAQU,OAAAA,GAAU,KAAA;AACvB,MAAA,MAAMyB,KAAAA;AAAAA,IACR;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAcH,MAAAA,GAAwB;AACpCtC,IAAAA,MAAAA,CAAO0C,MAAM,yBAAyB,CAAA;AAGtC,IAAA,IAAI,KAAKX,UAAAA,EAAY;AACnB,MAAA,MAAM,IAAA,CAAKA,UAAAA,CAAWtB,IAAAA,CAAK,OAAA,EAAS,OAAO,CAAA;AAC3C,MAAA,MAAM,IAAA,CAAKsB,UAAAA,CAAWY,OAAAA,CAAQ,MAAA,EAAQ,MAAM,CAAA;AAAA,IAC9C;AAGA,IAAA,IAAI,IAAA,CAAKT,YAAAA;AACP,MAAA,MAAM,IAAA,CAAKA,YAAAA,CAAaU,KAAAA,CAAM,qBAAqB,CAAA;AAAA,EACvD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMnC,IAAAA,CAAKoC,KAAAA,EAAeC,KAAAA,EAAoC;AAC5D,IAAA,MAAMC,IAAAA,GAAO7C,kBAAAA,CAAmB6C,IAAAA,CAAK,WAAW,CAAA;AAEhD,IAAA,IAAI,CAAC,IAAA,CAAKzC,OAAAA,CAAQU,WAAW,CAAC,IAAA,CAAKV,QAAQW,UAAAA,EAAY;AAErD,MAAA,OAAO,IAAA,CAAK+B,MAAAA,CAAOH,KAAAA,EAAOC,KAAK,CAAA;AAAA,IACjC;AAEA,IAAA,MAAM,KAAKvB,UAAAA,EAAW;AAEtB,IAAA,IAAI;AACF,MAAA,MAAMI,SAAAA,GAAYC,YAAYC,GAAAA,EAAI;AAClC,MAAA,MAAMoB,SAAS,MAAM,IAAA,CAAKlB,UAAAA,CAAYtB,IAAAA,CAAKoC,OAAOC,KAAK,CAAA;AACvD,MAAA,MAAMI,QAAAA,GAAWtB,WAAAA,CAAYC,GAAAA,EAAI,GAAIF,SAAAA;AAErC,MAAA,IAAA,CAAKnB,MAAMC,IAAAA,CAAKC,KAAAA,EAAAA;AAChB,MAAA,IAAA,CAAKF,KAAAA,CAAMC,KAAKE,SAAAA,IAAauC,QAAAA;AAG7B,MAAA,IAAI,IAAA,CAAKC,iBAAgB,EAAG;AAC1B,QAAA,MAAMC,WAAAA,GAAcxB,YAAYC,GAAAA,EAAI;AACpC,QAAA,MAAM,IAAA,CAAKmB,MAAAA,CAAOH,KAAAA,EAAOC,KAAK,CAAA;AAC9B,QAAA,MAAMO,MAAAA,GAASzB,WAAAA,CAAYC,GAAAA,EAAI,GAAIuB,WAAAA;AACnC,QAAA,IAAA,CAAK5C,KAAAA,CAAMC,KAAKI,UAAAA,IAAcwC,MAAAA;AAE9B,QAAA,MAAMC,UAAUD,MAAAA,GAASH,QAAAA;AACzBlD,QAAAA,MAAAA,CAAO0C,MAAM,CAAA,cAAA,EAAiBY,OAAAA,CAAQd,OAAAA,CAAQ,CAAC,CAAC,CAAA,SAAA,EAAYU,QAAAA,CAASV,OAAAA,CAAQ,CAAC,CAAC,CAAA,QAAA,EAAWa,MAAAA,CAAOb,OAAAA,CAAQ,CAAC,CAAC,CAAA,GAAA,CAAK,CAAA;AAAA,MAClH;AAEAtC,MAAAA,kBAAAA,CAAmBqD,OAAAA,CAAQ,aAAaR,IAAI,CAAA;AAC5C,MAAA,IAAA,CAAKS,iBAAAA,EAAkB;AAEvB,MAAA,OAAOP,MAAAA;AAAAA,IACT,SACOR,KAAAA,EAAO;AACZzC,MAAAA,MAAAA,CAAOyC,KAAAA,CAAM,yCAAyCA,KAAK,CAAA;AAC3D,MAAA,OAAO,IAAA,CAAKO,MAAAA,CAAOH,KAAAA,EAAOC,KAAK,CAAA;AAAA,IACjC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAcE,MAAAA,CAAOH,KAAAA,EAAeC,KAAAA,EAAoC;AAEtE,IAAA,MAAMW,OAAOZ,KAAAA,CAAMa,MAAAA;AACnB,IAAA,MAAMC,OAAOb,KAAAA,CAAMY,MAAAA;AACnB,IAAA,MAAME,SAAqB,EAAA;AAG3B,IAAA,KAAA,IAASC,CAAAA,GAAI,CAAA,EAAGA,CAAAA,IAAKJ,IAAAA,EAAMI,CAAAA,EAAAA;AACzBD,MAAAA,MAAAA,CAAOC,CAAC,CAAA,GAAI,CAACA,CAAC,CAAA;AAEhB,IAAA,KAAA,IAASC,CAAAA,GAAI,CAAA,EAAGA,CAAAA,IAAKH,IAAAA,EAAMG,CAAAA,EAAAA;AACzBF,MAAAA,MAAAA,CAAO,CAAC,CAAA,CAAEE,CAAC,CAAA,GAAIA,CAAAA;AAGjB,IAAA,KAAA,IAASD,CAAAA,GAAI,CAAA,EAAGA,CAAAA,IAAKJ,IAAAA,EAAMI,CAAAA,EAAAA,EAAK;AAC9B,MAAA,KAAA,IAASC,CAAAA,GAAI,CAAA,EAAGA,CAAAA,IAAKH,IAAAA,EAAMG,CAAAA,EAAAA,EAAK;AAC9B,QAAA,MAAMC,IAAAA,GAAOlB,MAAMgB,CAAAA,GAAI,CAAC,MAAMf,KAAAA,CAAMgB,CAAAA,GAAI,CAAC,CAAA,GAAI,CAAA,GAAI,CAAA;AACjDF,QAAAA,MAAAA,CAAOC,CAAC,CAAA,CAAEC,CAAC,CAAA,GAAIE,IAAAA,CAAKC,GAAAA;AAAAA,UAClBL,MAAAA,CAAOC,CAAAA,GAAI,CAAC,CAAA,CAAEC,CAAC,CAAA,GAAI,CAAA;AAAA;AAAA,UACnBF,MAAAA,CAAOC,CAAC,CAAA,CAAEC,CAAAA,GAAI,CAAC,CAAA,GAAI,CAAA;AAAA;AAAA,UACnBF,OAAOC,CAAAA,GAAI,CAAC,CAAA,CAAEC,CAAAA,GAAI,CAAC,CAAA,GAAIC;AAAAA;AAAAA,SACzB;AAAA,MACF;AAAA,IACF;AAEA,IAAA,MAAMG,QAAAA,GAAWN,MAAAA,CAAOH,IAAI,CAAA,CAAEE,IAAI,CAAA;AAClC,IAAA,MAAMQ,MAAAA,GAASH,IAAAA,CAAKI,GAAAA,CAAIX,IAAAA,EAAME,IAAI,CAAA;AAElC,IAAA,OAAO;AAAA,MACLO,QAAAA;AAAAA,MACAG,YAAY,EAAA;AAAA,MACZC,UAAAA,EAAYH,MAAAA,GAAS,CAAA,GAAI,CAAA,GAAID,WAAWC,MAAAA,GAAS,CAAA;AAAA,MACjDI,aAAAA,EAAe;AAAA,KACjB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM3B,MAAM4B,IAAAA,EAAoC;AAC9C,IAAA,MAAMzB,IAAAA,GAAO7C,kBAAAA,CAAmB6C,IAAAA,CAAK,YAAY,CAAA;AAEjD,IAAA,IAAI,CAAC,IAAA,CAAKzC,OAAAA,CAAQU,WAAW,CAAC,IAAA,CAAKV,QAAQY,YAAAA,EAAc;AAEvD,MAAA,OAAO,IAAA,CAAKuD,QAAQD,IAAI,CAAA;AAAA,IAC1B;AAEA,IAAA,MAAM,KAAKjD,UAAAA,EAAW;AAEtB,IAAA,IAAI;AACF,MAAA,MAAMI,SAAAA,GAAYC,YAAYC,GAAAA,EAAI;AAClC,MAAA,MAAMoB,MAAAA,GAAS,MAAM,IAAA,CAAKf,YAAAA,CAAcU,MAAM4B,IAAI,CAAA;AAClD,MAAA,MAAMtB,QAAAA,GAAWtB,WAAAA,CAAYC,GAAAA,EAAI,GAAIF,SAAAA;AAErC,MAAA,IAAA,CAAKnB,MAAMM,MAAAA,CAAOJ,KAAAA,EAAAA;AAClB,MAAA,IAAA,CAAKF,KAAAA,CAAMM,OAAOH,SAAAA,IAAauC,QAAAA;AAG/B,MAAA,IAAI,IAAA,CAAKC,iBAAgB,EAAG;AAC1B,QAAA,MAAMC,WAAAA,GAAcxB,YAAYC,GAAAA,EAAI;AACpC,QAAA,MAAM,IAAA,CAAK4C,QAAQD,IAAI,CAAA;AACvB,QAAA,MAAMnB,MAAAA,GAASzB,WAAAA,CAAYC,GAAAA,EAAI,GAAIuB,WAAAA;AACnC,QAAA,IAAA,CAAK5C,KAAAA,CAAMM,OAAOD,UAAAA,IAAcwC,MAAAA;AAEhC,QAAA,MAAMC,UAAUD,MAAAA,GAASH,QAAAA;AACzBlD,QAAAA,MAAAA,CAAO0C,MAAM,CAAA,eAAA,EAAkBY,OAAAA,CAAQd,OAAAA,CAAQ,CAAC,CAAC,CAAA,SAAA,EAAYU,QAAAA,CAASV,OAAAA,CAAQ,CAAC,CAAC,CAAA,QAAA,EAAWa,MAAAA,CAAOb,OAAAA,CAAQ,CAAC,CAAC,CAAA,GAAA,CAAK,CAAA;AAAA,MACnH;AAEAtC,MAAAA,kBAAAA,CAAmBqD,OAAAA,CAAQ,cAAcR,IAAI,CAAA;AAC7C,MAAA,IAAA,CAAKS,iBAAAA,EAAkB;AAEvB,MAAA,OAAOP,MAAAA;AAAAA,IACT,SACOR,KAAAA,EAAO;AACZzC,MAAAA,MAAAA,CAAOyC,KAAAA,CAAM,0CAA0CA,KAAK,CAAA;AAC5D,MAAA,OAAO,IAAA,CAAKgC,QAAQD,IAAI,CAAA;AAAA,IAC1B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAcC,QAAQD,IAAAA,EAAoC;AAExD,IAAA,MAAME,KAAAA,GAAQF,IAAAA,CAAKG,KAAAA,CAAM,IAAI,CAAA;AAC7B,IAAA,MAAMC,QAAQ,EAAA;AACd,IAAA,IAAIC,SAAAA,GAAY,CAAA;AAEhB,IAAA,KAAA,IAAShB,CAAAA,GAAI,CAAA,EAAGA,CAAAA,GAAIa,KAAAA,CAAMhB,QAAQG,CAAAA,EAAAA,EAAK;AACrC,MAAA,MAAMiB,IAAAA,GAAOJ,MAAMb,CAAC,CAAA;AAEpB,MAAA,IAAIiB,IAAAA,CAAKC,UAAAA,CAAW,GAAG,CAAA,EAAG;AACxB,QAAA,MAAMC,QAAQF,IAAAA,CAAKG,KAAAA,CAAM,KAAK,CAAA,GAAI,CAAC,EAAEvB,MAAAA,IAAU,CAAA;AAC/CkB,QAAAA,KAAAA,CAAM3C,IAAAA,CAAK;AAAA,UACTiD,IAAAA,EAAM,CAAA;AAAA;AAAA,UACNC,KAAAA,EAAOX,IAAAA,CAAKY,OAAAA,CAAQN,IAAI,CAAA;AAAA,UACxBO,GAAAA,EAAKb,IAAAA,CAAKY,OAAAA,CAAQN,IAAI,IAAIA,IAAAA,CAAKpB,MAAAA;AAAAA,UAC/B4B,OAAAA,EAASR,IAAAA,CAAKS,OAAAA,CAAQ,QAAA,EAAU,EAAE,CAAA;AAAA,UAClCC,UAAAA,EAAY;AAAA,YAAER;AAAAA;AAAM,SACrB,CAAA;AACDH,QAAAA,SAAAA,EAAAA;AAAAA,MACF,CAAA,MAAA,IACSC,IAAAA,CAAKW,IAAAA,EAAK,EAAG;AACpBb,QAAAA,KAAAA,CAAM3C,IAAAA,CAAK;AAAA,UACTiD,IAAAA,EAAM,CAAA;AAAA;AAAA,UACNC,KAAAA,EAAOX,IAAAA,CAAKY,OAAAA,CAAQN,IAAI,CAAA;AAAA,UACxBO,GAAAA,EAAKb,IAAAA,CAAKY,OAAAA,CAAQN,IAAI,IAAIA,IAAAA,CAAKpB,MAAAA;AAAAA,UAC/B4B,OAAAA,EAASR;AAAAA,SACV,CAAA;AACDD,QAAAA,SAAAA,EAAAA;AAAAA,MACF;AAAA,IACF;AAEA,IAAA,OAAO;AAAA,MACLD,KAAAA;AAAAA,MACAc,SAAAA,EAAW,CAAA;AAAA,MACXb,SAAAA;AAAAA,MACAc,UAAAA,EAAY;AAAA,KACd;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMC,UAAUC,KAAAA,EAAuD;AACrE,IAAA,IAAI,CAAC,IAAA,CAAKvF,OAAAA,CAAQU,OAAAA,IAAW,CAAC,KAAKe,UAAAA,EAAY;AAE7C,MAAA,OAAOK,OAAAA,CAAQC,GAAAA,CAAIwD,KAAAA,CAAMC,GAAAA,CAAI,CAAC,CAACC,CAAAA,EAAGC,CAAC,CAAA,KAAM,IAAA,CAAKhD,MAAAA,CAAO+C,CAAAA,EAAGC,CAAC,CAAC,CAAC,CAAA;AAAA,IAC7D;AAEA,IAAA,MAAM,KAAKzE,UAAAA,EAAW;AACtB,IAAA,OAAO,IAAA,CAAKQ,UAAAA,CAAW6D,SAAAA,CAAUC,KAAK,CAAA;AAAA,EACxC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAMlD,OAAAA,CAAQsD,IAAAA,EAAcC,IAAAA,EAAgC;AAC1D,IAAA,IAAI,CAAC,IAAA,CAAK5F,OAAAA,CAAQU,OAAAA,IAAW,CAAC,IAAA,CAAKe,UAAAA;AACjC,MAAA,OAAOkE,IAAAA,KAASC,IAAAA;AAElB,IAAA,MAAM,KAAK3E,UAAAA,EAAW;AACtB,IAAA,OAAO,IAAA,CAAKQ,UAAAA,CAAWY,OAAAA,CAAQsD,IAAAA,EAAMC,IAAI,CAAA;AAAA,EAC3C;AAAA;AAAA;AAAA;AAAA,EAKQ/C,eAAAA,GAA2B;AAEjC,IAAA,MAAMgD,aAAa,IAAA,CAAK3F,KAAAA,CAAMC,KAAKC,KAAAA,GAAQ,IAAA,CAAKF,MAAMM,MAAAA,CAAOJ,KAAAA;AAC7D,IAAA,OAAOyF,aAAa,GAAA,KAAQ,CAAA;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAKQ3C,iBAAAA,GAA0B;AAChC,IAAA,IAAI5B,YAAYwE,MAAAA,EAAQ;AACtB,MAAA,MAAMC,IAAAA,GAAOzE,YAAYwE,MAAAA,CAAOE,cAAAA;AAChC,MAAA,IAAA,CAAKvF,UAAAA,GAAaiD,IAAAA,CAAKI,GAAAA,CAAI,IAAA,CAAKrD,YAAYsF,IAAI,CAAA;AAAA,IAClD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKAE,QAAAA,GAA6B;AAC3B,IAAA,MAAMC,SAAAA,GAAY,IAAA,CAAKzE,UAAAA,EAAY0E,aAAAA,EAAc,IAAK;AAAA,MAAEC,IAAAA,EAAM,CAAa,CAAA;AAC3E,IAAA,MAAMC,WAAAA,GAAc,IAAA,CAAK5E,UAAAA,EAAY6E,cAAAA,EAAe,IAAK;AAAA,MAAEP,IAAAA,EAAM,CAAY,CAAA;AAG7E,IAAA,IAAIQ,YAAAA,GAAe,CAAA;AACnB,IAAA,IAAIC,KAAAA,GAAQ,CAAA;AAEZ,IAAA,IAAI,IAAA,CAAKtG,MAAMC,IAAAA,CAAKC,KAAAA,GAAQ,KAAK,IAAA,CAAKF,KAAAA,CAAMC,IAAAA,CAAKI,UAAAA,GAAa,CAAA,EAAG;AAC/DgG,MAAAA,YAAAA,IAAgB,KAAKrG,KAAAA,CAAMC,IAAAA,CAAKI,UAAAA,GAAa,IAAA,CAAKL,MAAMC,IAAAA,CAAKE,SAAAA;AAC7DmG,MAAAA,KAAAA,EAAAA;AAAAA,IACF;AAEA,IAAA,IAAI,IAAA,CAAKtG,MAAMM,MAAAA,CAAOJ,KAAAA,GAAQ,KAAK,IAAA,CAAKF,KAAAA,CAAMM,MAAAA,CAAOD,UAAAA,GAAa,CAAA,EAAG;AACnEgG,MAAAA,YAAAA,IAAgB,KAAKrG,KAAAA,CAAMM,MAAAA,CAAOD,UAAAA,GAAa,IAAA,CAAKL,MAAMM,MAAAA,CAAOH,SAAAA;AACjEmG,MAAAA,KAAAA,EAAAA;AAAAA,IACF;AAEA,IAAA,MAAMC,cAAAA,GAAiBD,KAAAA,GAAQ,CAAA,GAAID,YAAAA,GAAeC,KAAAA,GAAQ,CAAA;AAC1D,IAAA,MAAME,cAAAA,GAAkB,IAAA,CAAKxG,KAAAA,CAAMC,IAAAA,CAAKI,aAAa,IAAA,CAAKL,KAAAA,CAAMC,IAAAA,CAAKE,SAAAA,IAChE,KAAKH,KAAAA,CAAMM,MAAAA,CAAOD,UAAAA,GAAa,IAAA,CAAKL,MAAMM,MAAAA,CAAOH,SAAAA,CAAAA;AAEtD,IAAA,OAAO;AAAA,MACLK,OAAAA,EAAS,KAAKV,OAAAA,CAAQU,OAAAA;AAAAA,MACtBT,aAAa,IAAA,CAAKA,WAAAA;AAAAA,MAClB0G,OAAAA,EAAS;AAAA,QACPxG,IAAAA,EAAM;AAAA,UACJF,WAAAA,EAAa,CAAC,CAAC,IAAA,CAAKwB,UAAAA;AAAAA,UACpBrB,KAAAA,EAAO,IAAA,CAAKF,KAAAA,CAAMC,IAAAA,CAAKC,KAAAA;AAAAA,UACvBC,SAAAA,EAAW,IAAA,CAAKH,KAAAA,CAAMC,IAAAA,CAAKE,SAAAA;AAAAA,UAC3BC,WAAW4F,SAAAA,CAAUE;AAAAA,SACvB;AAAA,QACA5F,MAAAA,EAAQ;AAAA,UACNP,WAAAA,EAAa,CAAC,CAAC,IAAA,CAAK2B,YAAAA;AAAAA,UACpBxB,KAAAA,EAAO,IAAA,CAAKF,KAAAA,CAAMM,MAAAA,CAAOJ,KAAAA;AAAAA,UACzBC,SAAAA,EAAW,IAAA,CAAKH,KAAAA,CAAMM,MAAAA,CAAOH,SAAAA;AAAAA,UAC7BC,SAAAA,EAAW;AAAA;AACb,OACF;AAAA,MACAwF,MAAAA,EAAQ;AAAA,QACNC,MAAMM,WAAAA,CAAYN,IAAAA;AAAAA,QAClBa,MAAM,IAAA,CAAKnG;AAAAA,OACb;AAAA,MACAa,WAAAA,EAAa;AAAA,QACXmF,cAAAA;AAAAA,QACAC,cAAAA,EAAgBhD,IAAAA,CAAKI,GAAAA,CAAI,CAAA,EAAG4C,cAAc;AAAA;AAC5C,KACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKAG,UAAAA,GAAmB;AACjB,IAAA,IAAA,CAAK3G,KAAAA,GAAQ;AAAA,MACXC,IAAAA,EAAM;AAAA,QAAEC,KAAAA,EAAO,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,UAAAA,EAAY;AAAA,OAAE;AAAA,MAC5DC,MAAAA,EAAQ;AAAA,QAAEJ,KAAAA,EAAO,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,SAAAA,EAAW,CAAA;AAAA,QAAGC,UAAAA,EAAY;AAAA;AAAE,KAChE;AACA,IAAA,IAAA,CAAKE,UAAAA,GAAa,CAAA;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKAqG,OAAAA,GAAgB;AACd,IAAA,IAAA,CAAKrF,YAAYqF,OAAAA,EAAQ;AACzB,IAAA,IAAA,CAAKlF,cAAckF,OAAAA,EAAQ;AAC3B,IAAA,IAAA,CAAK7G,WAAAA,GAAc,KAAA;AACnBP,IAAAA,MAAAA,CAAO0B,KAAK,0BAA0B,CAAA;AAAA,EACxC;AAAA;AAAA;AAAA;AAAA,EAKA,OAAO2F,WAAAA,GAAuB;AAC5B,IAAA,IAAI;AACF,MAAA,OAAO,OAAOC,WAAAA,KAAgB,QAAA,IACzB,OAAOA,YAAYC,WAAAA,KAAgB,UAAA;AAAA,IAC1C,CAAA,CAAA,MACM;AACJ,MAAA,OAAO,KAAA;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,OAAOC,WAAAA,GAML;AACA,IAAA,MAAMC,SAAAA,GAAYrH,gBAAgBiH,WAAAA,EAAY;AAE9C,IAAA,OAAO;AAAA,MACLI,SAAAA;AAAAA,MACAC,SAAAA,EAAWD,SAAAA,IAAa,OAAOH,WAAAA,CAAYK,oBAAAA,KAAyB,UAAA;AAAA,MACpEC,IAAAA,EAAM,KAAA;AAAA;AAAA,MACNC,OAAAA,EAAS,OAAOC,iBAAAA,KAAsB,WAAA;AAAA,MACtCC,UAAAA,EAAY;AAAA;AAAA,KACd;AAAA,EACF;AACF;;;;;;;"}