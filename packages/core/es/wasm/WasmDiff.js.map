{"version":3,"file":"WasmDiff.js","sources":["../../src/wasm/WasmDiff.ts"],"sourcesContent":["/**\r\n * WebAssembly Diff算法包装器\r\n * 提供高性能的文本差异计算\r\n */\r\n\r\nimport { createLogger } from '../utils/logger'\r\nimport { getPerformanceMonitor } from '../utils/PerformanceMonitor'\r\n\r\nconst logger = createLogger('WasmDiff')\r\nconst performanceMonitor = getPerformanceMonitor()\r\n\r\nexport interface DiffResult {\r\n  distance: number\r\n  operations: DiffOperation[]\r\n  similarity: number\r\n  executionTime: number\r\n}\r\n\r\nexport interface DiffOperation {\r\n  type: 'insert' | 'delete' | 'replace' | 'equal'\r\n  oldStart: number\r\n  oldEnd: number\r\n  newStart: number\r\n  newEnd: number\r\n  content?: string\r\n}\r\n\r\nexport interface WasmDiffOptions {\r\n  /** 最大文本长度限制 */\r\n  maxLength?: number\r\n  /** 是否启用缓存 */\r\n  enableCache?: boolean\r\n  /** 缓存大小 */\r\n  cacheSize?: number\r\n  /** 是否使用Web Worker */\r\n  useWorker?: boolean\r\n}\r\n\r\nexport class WasmDiff {\r\n  private wasmInstance?: WebAssembly.Instance\r\n  private wasmMemory?: WebAssembly.Memory\r\n  private initialized = false\r\n  private initPromise?: Promise<void>\r\n  private options: Required<WasmDiffOptions>\r\n  private cache = new Map<string, DiffResult>()\r\n  private worker?: Worker\r\n\r\n  /** 导出的WASM函数 */\r\n  private exports?: {\r\n    memory: WebAssembly.Memory\r\n    lcsLength: (text1: number, len1: number, text2: number, len2: number) => number\r\n    myersDiff: (old: number, oldLen: number, new_: number, newLen: number, output: number) => number\r\n    fastStringCompare: (str1: number, len1: number, str2: number, len2: number) => number\r\n    editDistance: (str1: number, len1: number, str2: number, len2: number) => number\r\n    batchCompare: (pairs: number, count: number) => number\r\n  }\r\n\r\n  constructor(options: WasmDiffOptions = {}) {\r\n    this.options = {\r\n      maxLength: 1000000, // 100万字符\r\n      enableCache: true,\r\n      cacheSize: 100,\r\n      useWorker: false,\r\n      ...options,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 初始化WASM模块\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (this.initialized)\r\n      return\r\n    if (this.initPromise)\r\n      return this.initPromise\r\n\r\n    this.initPromise = this.doInitialize()\r\n    await this.initPromise\r\n  }\r\n\r\n  private async doInitialize(): Promise<void> {\r\n    try {\r\n      logger.info('Initializing WebAssembly diff module')\r\n      const startTime = performance.now()\r\n\r\n      // 加载WASM字节码\r\n      const wasmBytes = await this.loadWasmBytes()\r\n\r\n      // 创建内存\r\n      this.wasmMemory = new WebAssembly.Memory({\r\n        initial: 256, // 16MB\r\n        maximum: 16384, // 1GB\r\n      })\r\n\r\n      // 实例化WASM模块\r\n      const importObject = {\r\n        env: {\r\n          memory: this.wasmMemory,\r\n        },\r\n        console: {\r\n          log: (ptr: number) => {\r\n            const msg = this.readString(ptr)\r\n            logger.debug('WASM:', msg)\r\n          },\r\n          time: (ptr: number) => {\r\n            const label = this.readString(ptr)\r\n            console.time(label)\r\n          },\r\n          timeEnd: (ptr: number) => {\r\n            const label = this.readString(ptr)\r\n            console.timeEnd(label)\r\n          },\r\n        },\r\n      }\r\n\r\n      const { instance } = await WebAssembly.instantiate(wasmBytes, importObject)\r\n      this.wasmInstance = instance\r\n      this.exports = instance.exports as any\r\n\r\n      // 初始化Worker（如果启用）\r\n      if (this.options.useWorker && typeof Worker !== 'undefined')\r\n        this.initializeWorker()\r\n\r\n      this.initialized = true\r\n      const initTime = performance.now() - startTime\r\n      logger.info(`WebAssembly diff module initialized in ${initTime.toFixed(2)}ms`)\r\n    }\r\n    catch (error) {\r\n      logger.error('Failed to initialize WebAssembly:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 加载WASM字节码\r\n   */\r\n  private async loadWasmBytes(): Promise<ArrayBuffer> {\r\n    // 开发环境：从文件加载\r\n    if (process.env.NODE_ENV === 'development') {\r\n      const response = await fetch('/src/wasm/diff.wasm')\r\n      return response.arrayBuffer()\r\n    }\r\n\r\n    // 生产环境：使用内联的Base64\r\n    // 注意：实际项目中应该构建时生成\r\n    const base64 = await import('./diff.wasm.base64')\r\n    return Uint8Array.from(atob(base64.default), c => c.charCodeAt(0)).buffer\r\n  }\r\n\r\n  /**\r\n   * 初始化Web Worker\r\n   */\r\n  private initializeWorker(): void {\r\n    const workerCode = `\r\n      let wasmInstance;\r\n      let wasmMemory;\r\n      let exports;\r\n      \r\n      self.onmessage = async (e) => {\r\n        const { type, data } = e.data;\r\n        \r\n        switch (type) {\r\n          case 'init':\r\n            const { wasmBytes } = data;\r\n            wasmMemory = new WebAssembly.Memory({\r\n              initial: 256,\r\n              maximum: 16384\r\n            });\r\n            \r\n            const { instance } = await WebAssembly.instantiate(wasmBytes, {\r\n              env: { memory: wasmMemory },\r\n              console: {\r\n                log: () => {},\r\n                time: () => {},\r\n                timeEnd: () => {}\r\n              }\r\n            });\r\n            \r\n            wasmInstance = instance;\r\n            exports = instance.exports;\r\n            self.postMessage({ type: 'initialized' });\r\n            break;\r\n            \r\n          case 'diff':\r\n            const { text1, text2 } = data;\r\n            // 执行diff计算\r\n            const result = computeDiff(text1, text2);\r\n            self.postMessage({ type: 'result', data: result });\r\n            break;\r\n        }\r\n      };\r\n      \r\n      function computeDiff(text1, text2) {\r\n        // Worker中的diff计算逻辑\r\n        // ... 省略实现细节\r\n        return { distance: 0, operations: [] };\r\n      }\r\n    `\r\n\r\n    const blob = new Blob([workerCode], { type: 'application/javascript' })\r\n    this.worker = new Worker(URL.createObjectURL(blob))\r\n\r\n    this.worker.onmessage = (e) => {\r\n      logger.debug('Worker message:', e.data)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 计算两个文本的差异\r\n   */\r\n  async diff(text1: string, text2: string): Promise<DiffResult> {\r\n    await this.initialize()\r\n\r\n    const mark = performanceMonitor.mark('wasm-diff-start')\r\n    const startTime = performance.now()\r\n\r\n    // 检查缓存\r\n    const cacheKey = this.getCacheKey(text1, text2)\r\n    if (this.options.enableCache && this.cache.has(cacheKey)) {\r\n      logger.debug('Diff result from cache')\r\n      return this.cache.get(cacheKey)!\r\n    }\r\n\r\n    try {\r\n      // 检查长度限制\r\n      if (text1.length > this.options.maxLength || text2.length > this.options.maxLength)\r\n        throw new Error(`Text length exceeds limit of ${this.options.maxLength}`)\r\n\r\n      // 快速相等检查\r\n      if (text1 === text2) {\r\n        return {\r\n          distance: 0,\r\n          operations: [{\r\n            type: 'equal',\r\n            oldStart: 0,\r\n            oldEnd: text1.length,\r\n            newStart: 0,\r\n            newEnd: text2.length,\r\n          }],\r\n          similarity: 1,\r\n          executionTime: performance.now() - startTime,\r\n        }\r\n      }\r\n\r\n      // 写入文本到WASM内存\r\n      const ptr1 = this.writeString(text1, 0)\r\n      const ptr2 = this.writeString(text2, ptr1 + text1.length + 4)\r\n\r\n      // 调用WASM函数计算编辑距离\r\n      const distance = this.exports!.editDistance(\r\n        ptr1,\r\n        text1.length,\r\n        ptr2,\r\n        text2.length,\r\n      )\r\n\r\n      // 计算LCS长度\r\n      const lcsLen = this.exports!.lcsLength(\r\n        ptr1,\r\n        text1.length,\r\n        ptr2,\r\n        text2.length,\r\n      )\r\n\r\n      // 计算相似度\r\n      const maxLen = Math.max(text1.length, text2.length)\r\n      const similarity = maxLen > 0 ? 1 - distance / maxLen : 1\r\n\r\n      // Myers算法获取详细操作\r\n      const outputPtr = ptr2 + text2.length + 4\r\n      const opsCount = this.exports!.myersDiff(\r\n        ptr1,\r\n        text1.length,\r\n        ptr2,\r\n        text2.length,\r\n        outputPtr,\r\n      )\r\n\r\n      // 解析操作序列\r\n      const operations = this.parseOperations(outputPtr, opsCount, text1, text2)\r\n\r\n      const result: DiffResult = {\r\n        distance,\r\n        operations,\r\n        similarity,\r\n        executionTime: performance.now() - startTime,\r\n      }\r\n\r\n      // 缓存结果\r\n      if (this.options.enableCache)\r\n        this.addToCache(cacheKey, result)\r\n\r\n      performanceMonitor.measure('wasm-diff', mark)\r\n      logger.info(`Diff completed: distance=${distance}, similarity=${similarity.toFixed(2)}, time=${result.executionTime.toFixed(2)}ms`)\r\n\r\n      return result\r\n    }\r\n    catch (error) {\r\n      logger.error('Diff calculation failed:', error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 批量比较多个文本对\r\n   */\r\n  async batchDiff(pairs: Array<[string, string]>): Promise<DiffResult[]> {\r\n    await this.initialize()\r\n\r\n    logger.info(`Batch diff for ${pairs.length} pairs`)\r\n    const startTime = performance.now()\r\n\r\n    // 并行处理\r\n    const results = await Promise.all(\r\n      pairs.map(([text1, text2]) => this.diff(text1, text2)),\r\n    )\r\n\r\n    const totalTime = performance.now() - startTime\r\n    logger.info(`Batch diff completed in ${totalTime.toFixed(2)}ms`)\r\n\r\n    return results\r\n  }\r\n\r\n  /**\r\n   * 快速字符串比较\r\n   */\r\n  async compare(str1: string, str2: string): Promise<boolean> {\r\n    await this.initialize()\r\n\r\n    if (str1.length !== str2.length)\r\n      return false\r\n    if (str1 === str2)\r\n      return true\r\n\r\n    const ptr1 = this.writeString(str1, 0)\r\n    const ptr2 = this.writeString(str2, ptr1 + str1.length + 4)\r\n\r\n    const result = this.exports!.fastStringCompare(\r\n      ptr1,\r\n      str1.length,\r\n      ptr2,\r\n      str2.length,\r\n    )\r\n\r\n    return result === 1\r\n  }\r\n\r\n  /**\r\n   * 写入字符串到WASM内存\r\n   */\r\n  private writeString(str: string, offset: number): number {\r\n    const encoder = new TextEncoder()\r\n    const bytes = encoder.encode(str)\r\n    const mem = new Uint8Array(this.wasmMemory!.buffer, offset)\r\n\r\n    for (let i = 0; i < bytes.length; i++)\r\n      mem[i] = bytes[i]\r\n\r\n    return offset\r\n  }\r\n\r\n  /**\r\n   * 从WASM内存读取字符串\r\n   */\r\n  private readString(ptr: number, length?: number): string {\r\n    const mem = new Uint8Array(this.wasmMemory!.buffer, ptr)\r\n\r\n    // 如果没有指定长度，查找null结束符\r\n    if (length === undefined) {\r\n      length = 0\r\n      while (mem[length] !== 0) length++\r\n    }\r\n\r\n    const bytes = new Uint8Array(length)\r\n    for (let i = 0; i < length; i++)\r\n      bytes[i] = mem[i]\r\n\r\n    const decoder = new TextDecoder()\r\n    return decoder.decode(bytes)\r\n  }\r\n\r\n  /**\r\n   * 解析操作序列\r\n   */\r\n  private parseOperations(ptr: number, count: number, text1: string, text2: string): DiffOperation[] {\r\n    const operations: DiffOperation[] = []\r\n    const view = new DataView(this.wasmMemory!.buffer, ptr)\r\n\r\n    // 简单实现：根据编辑距离生成基本操作\r\n    // 实际应该从WASM读取详细的操作序列\r\n    const oldPos = 0\r\n    const newPos = 0\r\n\r\n    // 这里简化处理，实际应该解析WASM返回的详细操作\r\n    if (count > 0) {\r\n      operations.push({\r\n        type: 'replace',\r\n        oldStart: 0,\r\n        oldEnd: text1.length,\r\n        newStart: 0,\r\n        newEnd: text2.length,\r\n        content: text2,\r\n      })\r\n    }\r\n\r\n    return operations\r\n  }\r\n\r\n  /**\r\n   * 获取缓存键\r\n   */\r\n  private getCacheKey(text1: string, text2: string): string {\r\n    // 使用简单哈希避免存储大量文本\r\n    const hash1 = this.simpleHash(text1)\r\n    const hash2 = this.simpleHash(text2)\r\n    return `${hash1}:${hash2}`\r\n  }\r\n\r\n  /**\r\n   * 简单哈希函数\r\n   */\r\n  private simpleHash(str: string): string {\r\n    let hash = 0\r\n    for (let i = 0; i < str.length; i++) {\r\n      const char = str.charCodeAt(i)\r\n      hash = ((hash << 5) - hash) + char\r\n      hash = hash & hash // 转为32位整数\r\n    }\r\n    return hash.toString(36)\r\n  }\r\n\r\n  /**\r\n   * 添加到缓存\r\n   */\r\n  private addToCache(key: string, result: DiffResult): void {\r\n    // LRU缓存策略\r\n    if (this.cache.size >= this.options.cacheSize) {\r\n      const firstKey = this.cache.keys().next().value\r\n      this.cache.delete(firstKey)\r\n    }\r\n    this.cache.set(key, result)\r\n  }\r\n\r\n  /**\r\n   * 清理资源\r\n   */\r\n  dispose(): void {\r\n    if (this.worker)\r\n      this.worker.terminate()\r\n\r\n    this.cache.clear()\r\n    this.wasmInstance = undefined\r\n    this.wasmMemory = undefined\r\n    this.initialized = false\r\n    logger.info('WasmDiff disposed')\r\n  }\r\n\r\n  /**\r\n   * 获取内存使用情况\r\n   */\r\n  getMemoryUsage(): { used: number, total: number } {\r\n    if (!this.wasmMemory)\r\n      return { used: 0, total: 0 }\r\n\r\n    const pages = this.wasmMemory.buffer.byteLength / 65536\r\n    return {\r\n      used: pages * 65536,\r\n      total: 16384 * 65536, // 最大值\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取缓存统计\r\n   */\r\n  getCacheStats(): { size: number, hits: number, misses: number } {\r\n    return {\r\n      size: this.cache.size,\r\n      hits: 0, // 需要实际追踪\r\n      misses: 0, // 需要实际追踪\r\n    }\r\n  }\r\n}\r\n"],"names":["logger","createLogger","performanceMonitor","getPerformanceMonitor","WasmDiff","constructor","options","initialized","cache","Map","maxLength","enableCache","cacheSize","useWorker","initialize","initPromise","doInitialize","info","startTime","performance","now","wasmBytes","loadWasmBytes","wasmMemory","WebAssembly","Memory","initial","maximum","importObject","env","memory","console","log","ptr","msg","readString","debug","time","label","timeEnd","instance","instantiate","wasmInstance","exports","Worker","initializeWorker","initTime","toFixed","error","process","NODE_ENV","response","fetch","arrayBuffer","base64","Uint8Array","from","atob","default","c","charCodeAt","buffer","workerCode","blob","Blob","type","worker","URL","createObjectURL","onmessage","e","data","diff","text1","text2","mark","cacheKey","getCacheKey","has","get","length","Error","distance","operations","oldStart","oldEnd","newStart","newEnd","similarity","executionTime","ptr1","writeString","ptr2","editDistance","lcsLen","lcsLength","maxLen","Math","max","outputPtr","opsCount","myersDiff","parseOperations","result","addToCache","measure","batchDiff","pairs","results","Promise","all","map","totalTime","compare","str1","str2","fastStringCompare","str","offset","encoder","TextEncoder","bytes","encode","mem","i","undefined","decoder","TextDecoder","decode","count","DataView","push","content","hash1","simpleHash","hash2","hash","char","toString","key","size","firstKey","keys","next","value","delete","set","dispose","terminate","clear","getMemoryUsage","used","total","pages","byteLength","getCacheStats","hits","misses"],"mappings":"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"}